---
id: TSK-021
title: Write tests for preference management
status: pending
ticket_id: TKT-003
estimate: M
type: test
dependencies:
  depends_on:
    - TSK-017
    - TSK-018
    - TSK-019
    - TSK-020
  blocks: []
---

# TSK-021: Write tests for preference management

## Objective

Write tests for preference service and API endpoints.

## Context

Tests ensure preferences work correctly including defaults, overrides, and organization inheritance.

## Deliverables

- [ ] `backend/tests/unit/test_notification_preferences.py` - Unit tests
- [ ] `backend/tests/api/test_notification_preferences_api.py` - API tests

## Implementation Notes

```python
# backend/tests/unit/test_notification_preferences.py

@pytest.mark.asyncio
class TestNotificationPreferenceService:
    async def test_get_user_preferences_returns_defaults(self, db_session):
        """Test that new users get default preferences."""
        service = NotificationPreferenceService(db_session)
        user_id = uuid4()

        preferences = await service.get_user_preferences(user_id)

        assert preferences.in_app["ticket_assigned"] is True
        assert preferences.email["ticket_assigned"] is False

    async def test_update_user_preferences(self, db_session):
        """Test updating user preferences."""
        service = NotificationPreferenceService(db_session)
        user_id = uuid4()

        updated = await service.update_user_preferences(
            user_id,
            NotificationPreferences(
                in_app={"ticket_assigned": False},
                email={},
            ),
        )

        assert updated.preferences["in_app"]["ticket_assigned"] is False

    async def test_organization_preferences_inheritance(self, db_session):
        """Test that org preferences are inherited by new members."""
        # Setup
        service = NotificationPreferenceService(db_session)
        org_id = uuid4()

        # Set org preferences
        await service.update_organization_preferences(
            org_id,
            NotificationPreferences(
                in_app={"ticket_assigned": False},
                email={},
            ),
        )

        # New user inherits
        user_prefs = await service.get_user_preferences(uuid4())
        # (would need to pass organization_id)
```

## Acceptance Criteria

- [ ] Test for default preferences
- [ ] Test for updating user preferences
- [ ] Test for organization preference inheritance
- [ ] Test for organization preferences CRUD
- [ ] Test for preference validation
- [ ] Test for organization admin authorization
