---
id: TSK-021
title: Write API integration tests
status: pending
created: 2025-01-08
parent_ticket: TKT-003
estimate: M
type: test
dependencies:
  depends_on: [TSK-016, TSK-017, TSK-018, TSK-019, TSK-020]
  blocks: []
---

# TSK-021: Write API integration tests

## Objective

Create integration tests for all consolidation API endpoints.

## Context

API integration tests verify the endpoints work correctly with authentication, database operations, and async job execution.

## Deliverables

- `backend/tests/api/test_consolidation_api.py`

## Implementation Notes

```python
# tests/api/test_consolidation_api.py
import pytest
from fastapi.testclient import TestClient
from unittest.mock import patch

def test_trigger_consolidation_success(client, admin_token, project):
    response = client.post(
        "/api/v1/consolidation/trigger",
        json={"project_id": str(project.id), "options": {"merge": True}},
        headers={"Authorization": f"Bearer {admin_token}"},
    )
    assert response.status_code == 202
    data = response.json()
    assert "job_id" in data
    assert data["status"] == "pending"

def test_trigger_consolidation_unauthorized(client, project):
    response = client.post(
        "/api/v1/consolidation/trigger",
        json={"project_id": str(project.id)},
    )
    assert response.status_code == 401

def test_trigger_consolidation_non_admin(client, user_token, project):
    response = client.post(
        "/api/v1/consolidation/trigger",
        json={"project_id": str(project.id)},
        headers={"Authorization": f"Bearer {user_token}"},
    )
    assert response.status_code == 403

def test_get_consolidation_status(client, admin_token, consolidation_job):
    response = client.get(
        f"/api/v1/consolidation/status/{consolidation_job.id}",
        headers={"Authorization": f"Bearer {admin_token}"},
    )
    assert response.status_code == 200
    data = response.json()
    assert data["job_id"] == str(consolidation_job.id)

@pytest.mark.asyncio
async def test_rollback_consolidation(client, admin_token, consolidation_change):
    with patch('omoii_os.services.consolidation.consolidation_service.ConsolidationService.rollback_consolidation') as mock_rollback:
        mock_rollback.return_value = RollbackResponse(
            success=True,
            rollback_id="test-id",
            memories_restored=5,
            memories_deleted=1,
            warnings=[],
        )

        response = client.post(
            "/api/v1/consolidation/rollback",
            json={"consolidation_id": str(consolidation_change.id)},
            headers={"Authorization": f"Bearer {admin_token}"},
        )
        assert response.status_code == 200
        data = response.json()
        assert data["success"] == True
```

## Acceptance Criteria

- [ ] Test POST /trigger (success, unauthorized, non-admin)
- [ ] Test GET /status (success, not found)
- [ ] Test GET /history (pagination, filtering)
- [ ] Test POST /rollback (success, expired window, conflicts)
- [ ] Authentication tests for all endpoints
- [ ] Authorization tests (admin vs regular user)
- [ ] Error response tests
- [ ] All tests passing

## Dependencies

**Depends On**: TSK-016, TSK-017, TSK-018, TSK-019, TSK-020
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
