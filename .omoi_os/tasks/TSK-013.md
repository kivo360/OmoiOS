---
id: TSK-013
title: Write unit tests for each component
status: pending
created: 2025-01-08
parent_ticket: TKT-002
estimate: M
type: test
dependencies:
  depends_on: [TSK-006, TSK-007, TSK-008, TSK-009, TSK-010, TSK-011]
  blocks: []
---

# TSK-013: Write unit tests for each component

## Objective

Create comprehensive unit tests for all consolidation service components.

## Context

Unit tests ensure each component works correctly before integration. Tests should use mocks for external dependencies.

## Deliverables

- `backend/tests/unit/services/consolidation/test_similarity_detector.py`
- `backend/tests/unit/services/consolidation/test_memory_merger.py`
- `backend/tests/unit/services/consolidation/test_memory_synthesizer.py`
- `backend/tests/unit/services/consolidation/test_memory_archiver.py`
- `backend/tests/unit/services/consolidation/test_playbook_promoter.py`
- `backend/tests/unit/services/consolidation/test_consolidation_service.py`

## Implementation Notes

Each test file should include:
- Test fixtures for sample data
- Mocked dependencies (embedding service, LLM service)
- Edge case testing
- Error handling tests

Example for SimilarityDetector:
```python
# tests/unit/services/consolidation/test_similarity_detector.py
import pytest
from omoi_os.services.consolidation.similarity_detector import SimilarityDetector, MemoryCluster

@pytest.fixture
def detector(mock_embedding_service):
    return SimilarityDetector(mock_embedding_service)

@pytest.fixture
def sample_memories_with_embeddings(db_session):
    memories = []
    for i in range(10):
        mem = TaskMemory(
            project_id="test-project",
            execution_summary=f"Memory {i} about testing",
            context_embedding=[0.1] * 1536,  # Mock embedding
            memory_type="discovery",
        )
        db_session.add(mem)
        memories.append(mem)
    db_session.flush()
    return memories

@pytest.mark.asyncio
async def test_detect_clusters_finds_similar_memories(detector, sample_memories_with_embeddings):
    clusters = await detector.detect_clusters(
        db_session, "test-project", threshold=0.90, min_cluster_size=2
    )

    # Should find clusters based on mock embeddings
    assert len(clusters) > 0
    assert all(len(c.memory_ids) >= 2 for c in clusters)

@pytest.mark.asyncio
async def test_detect_clusters_respects_min_cluster_size(detector, db_session):
    clusters = await detector.detect_clusters(
        db_session, "test-project", threshold=0.90, min_cluster_size=5
    )

    # Should filter out small clusters
    assert all(len(c.memory_ids) >= 5 for c in clusters)
```

## Acceptance Criteria

- [ ] SimilarityDetector tests (clustering algorithm)
- [ ] MemoryMerger tests (merge logic)
- [ ] MemorySynthesizer tests (with mocked LLM)
- [ ] MemoryArchiver tests (staleness criteria)
- [ ] PlaybookPromoter tests (eligibility checks)
- [ ] ConsolidationService tests (orchestration)
- [ ] Mock fixtures for all dependencies
- [ ] Edge cases covered (empty clusters, single memory, etc.)
- [ ] Error handling tests
- [ ] All tests passing

## Dependencies

**Depends On**: TSK-006, TSK-007, TSK-008, TSK-009, TSK-010, TSK-011
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
