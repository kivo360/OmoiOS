---
id: TSK-002
title: Implement ScalableConnectionManager class
status: pending
parent_ticket: TKT-003
estimate: L
created: 2026-01-08
type: implementation
dependencies:
  depends_on:
    - TSK-001
  blocks:
    - TSK-003
    - TSK-004
---

# TSK-002: Implement ScalableConnectionManager Class

## Objective

Implement the core ScalableConnectionManager class that handles multi-instance WebSocket connection management with Redis-backed state.

## Context

The ScalableConnectionManager is the heart of the WebSocket infrastructure. It manages connection lifecycle, Redis state synchronization, message delivery, and background tasks (heartbeat, stale cleanup).

## Deliverables

- [ ] `backend/omoi_os/api/websocket/connection_manager.py` - Complete ScalableConnectionManager implementation

## Implementation Notes

Key methods to implement:
- `start()` / `stop()` - Lifecycle management
- `connect()` / `disconnect()` - Connection registration
- `publish_event()` - Event publishing to Redis Pub/Sub
- `_connection_handler()` - Per-connection message loop
- `_send_replay()` - Message replay from Redis Streams
- `_redis_listener()` - Redis Pub/Sub listener
- `_heartbeat_loop()` - Periodic heartbeat
- `_stale_connection_cleanup()` - Background cleanup
- Redis state management methods

## Acceptance Criteria

- [ ] Connections are tracked in Redis with cross-instance visibility
- [ ] Message replay works from Redis Streams (5-minute window)
- [ ] Heartbeat detects and cleans up stale connections
- [ ] Multiple instances can run simultaneously
- [ ] Graceful shutdown drains connections properly
- [ ] Unit tests cover all major code paths
- [ ] Integration tests verify Redis interaction

## Dependencies

**Depends On**: TSK-001 (Pydantic models)

**Blocks**: TSK-003 (WebSocket Routes), TSK-004 (Internal API)

## Estimate

**Size**: L (4-6 hours)

**Rationale**: Complex distributed system logic with Redis integration, multiple background tasks, and error handling.
