---
id: TSK-002
title: Create SQLAlchemy models for consolidation
status: pending
created: 2025-01-08
parent_ticket: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-001]
  blocks: []
---

# TSK-002: Create SQLAlchemy models for consolidation

## Objective

Create SQLAlchemy ORM models for `ConsolidationJob` and `ConsolidationChange` tables with proper relationships and methods.

## Context

The consolidation system needs ORM models to interact with the new database tables. These models will be used throughout the consolidation service for querying and updating consolidation records.

## Deliverables

- `backend/omoi_os/models/consolidation_job.py` - ConsolidationJob model
- `backend/omoi_os/models/consolidation_change.py` - ConsolidationChange model

## Implementation Notes

```python
# omoi_os/models/consolidation_job.py
from sqlalchemy import String, Integer, DateTime, ForeignKey, JSONB
from sqlalchemy.dialects.postgresql import UUID, ARRAY
from sqlalchemy.orm import Mapped, mapped_column, relationship
from whenever import Instant

from omoi_os.models.base import Base

class ConsolidationJob(Base):
    __tablename__ = "consolidation_jobs"

    id: Mapped[str] = mapped_column(String, primary_key=True)
    project_id: Mapped[str] = mapped_column(String, nullable=False, index=True)
    status: Mapped[str] = mapped_column(String(20), nullable=False)
    trigger_type: Mapped[str] = mapped_column(String(20), nullable=False)
    options: Mapped[dict] = mapped_column(JSONB, nullable=False, default={})
    memories_merged: Mapped[int] = mapped_column(Integer, default=0)
    memories_archived: Mapped[int] = mapped_column(Integer, default=0)
    memories_promoted: Mapped[int] = mapped_column(Integer, default=0)
    summaries_created: Mapped[int] = mapped_column(Integer, default=0)
    started_at: Mapped[Optional[Instant]] = mapped_column(DateTime(timezone=True), nullable=True)
    completed_at: Mapped[Optional[Instant]] = mapped_column(DateTime(timezone=True), nullable=True)
    error_message: Mapped[Optional[str]] = mapped_column(String, nullable=True)
    triggered_by: Mapped[str] = mapped_column(String, nullable=True, index=True)

    # Relationships
    changes = relationship("ConsolidationChange", back_populates="job")
```

## Acceptance Criteria

- [ ] ConsolidationJob model with all fields
- [ ] ConsolidationChange model with all fields
- [ ] Proper relationships defined
- [ ] Foreign key relationships to TaskMemory and Project
- [ ] Helper methods for status transitions
- [ ] to_dict() method for serialization
- [ ] Models importable from omoi_os.models package

## Dependencies

**Depends On**: TSK-001 (Database migration)
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
