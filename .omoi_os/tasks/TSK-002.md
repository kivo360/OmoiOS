---
id: TSK-002
title: Implement TeamManager service
status: pending
parent_ticket: TKT-001
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-001]
  blocks: [TSK-003]
---

# TSK-002: Implement TeamManager service

## Objective

Create the TeamManager service that handles team creation, agent assignment, and team membership queries.

## Context

The TeamManager is responsible for all team-related operations within a supervisor. It provides the interface for creating teams, assigning agents, and querying team membership.

## Deliverables

- [ ] `backend/omoi_os/services/team_manager.py` - TeamManager service class
- [ ] `backend/tests/unit/services/test_team_manager.py` - Unit tests

## Implementation Notes

```python
# backend/omoi_os/services/team_manager.py

from typing import List, Optional
from uuid import UUID
from datetime import datetime

from sqlalchemy.orm import Session

from omoi_os.models.supervisor import SupervisorTeam, SupervisorTeamMember
from omoi_os.services.database import DatabaseService
from omoi_os.utils.datetime import utc_now


class TeamManager:
    """Manages supervisor teams and agent memberships."""

    def __init__(self, db: DatabaseService, supervisor_id: UUID):
        """Initialize team manager.

        Args:
            db: Database service
            supervisor_id: UUID of the supervisor
        """
        self.db = db
        self.supervisor_id = supervisor_id

    def create_team(
        self,
        name: str,
        description: Optional[str] = None,
        objective: Optional[str] = None,
        config: dict = None,
        agent_ids: List[UUID] = None,
    ) -> SupervisorTeam:
        """Create a new team.

        Args:
            name: Team name
            description: Optional description
            objective: Optional team objective
            config: Optional team configuration
            agent_ids: Optional list of agent IDs to assign

        Returns:
            Created SupervisorTeam
        """
        with self.db.get_session() as session:
            team = SupervisorTeam(
                supervisor_id=self.supervisor_id,
                name=name,
                description=description,
                objective=objective,
                config=config or {},
            )
            session.add(team)
            session.flush()  # Get the ID

            # Add members if provided
            if agent_ids:
                for agent_id in agent_ids:
                    member = SupervisorTeamMember(
                        team_id=team.id,
                        agent_id=agent_id,
                        role="MEMBER",
                    )
                    session.add(member)

            session.commit()
            session.refresh(team)
            session.expunge(team)

            return team

    def get_teams(self) -> List[SupervisorTeam]:
        """Get all teams for this supervisor."""
        with self.db.get_session() as session:
            teams = (
                session.query(SupervisorTeam)
                .filter(SupervisorTeam.supervisor_id == self.supervisor_id)
                .all()
            )
            for team in teams:
                session.expunge(team)
            return teams

    def get_team_members(self, team_id: UUID) -> List[SupervisorTeamMember]:
        """Get all active members of a team."""
        with self.db.get_session() as session:
            members = (
                session.query(SupervisorTeamMember)
                .filter(
                    SupervisorTeamMember.team_id == team_id,
                    SupervisorTeamMember.left_at.is_(None),
                )
                .all()
            )
            for member in members:
                session.expunge(member)
            return members

    def add_agent_to_team(self, team_id: UUID, agent_id: UUID, role: str = "MEMBER") -> SupervisorTeamMember:
        """Add an agent to a team."""
        with self.db.get_session() as session:
            # Check if already a member
            existing = (
                session.query(SupervisorTeamMember)
                .filter(
                    SupervisorTeamMember.team_id == team_id,
                    SupervisorTeamMember.agent_id == agent_id,
                    SupervisorTeamMember.left_at.is_(None),
                )
                .first()
            )
            if existing:
                raise ValueError(f"Agent {agent_id} is already a member of team {team_id}")

            member = SupervisorTeamMember(
                team_id=team_id,
                agent_id=agent_id,
                role=role,
            )
            session.add(member)
            session.commit()
            session.refresh(member)
            session.expunge(member)

            return member

    def remove_agent_from_team(self, team_id: UUID, agent_id: UUID) -> bool:
        """Remove an agent from a team (soft delete by setting left_at)."""
        with self.db.get_session() as session:
            member = (
                session.query(SupervisorTeamMember)
                .filter(
                    SupervisorTeamMember.team_id == team_id,
                    SupervisorTeamMember.agent_id == agent_id,
                    SupervisorTeamMember.left_at.is_(None),
                )
                .first()
            )
            if not member:
                return False

            member.left_at = utc_now()
            session.commit()
            return True
```

## Acceptance Criteria

- [ ] TeamManager class implements all CRUD operations
- [ ] Teams can be created with initial agent assignments
- [ ] Agents can be added/removed from teams
- [ ] Team membership queries return only active members
- [ ] All database operations use proper session management
- [ ] Unit tests cover all methods with >80% coverage

## Dependencies

**Depends On**: TSK-001 (Database models)
**Blocks**: TSK-003 (SupervisorAgent service)

## Estimate

**Size**: S (<2 hours)
