---
id: TSK-002
title: Create database migration for notification tables
status: pending
parent_ticket: TKT-001
estimate: S
type: implementation
dependencies:
  depends_on:
    - TSK-001
  blocks:
    - TSK-003
---

# TSK-002: Create database migration for notification tables

## Objective

Create an Alembic migration to create the notifications, notification_preferences, and organization_notification_preferences tables with all indexes.

## Context

Alembic is used for database migrations in OmoiOS. This migration creates the tables needed for the notification system.

## Deliverables

- [ ] `backend/migrations/versions/XXX_notification_system.py` - Alembic migration

## Implementation Notes

```python
# Example migration structure
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    op.create_table(
        'notifications',
        sa.Column('id', postgresql.UUID(as_uuid=True), primary_key=True),
        sa.Column('user_id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('type', sa.String(50), nullable=False),
        sa.Column('title', sa.String(255), nullable=False),
        sa.Column('message', sa.Text(), nullable=False),
        sa.Column('data', postgresql.JSONB(), nullable=False, server_default='{}'),
        sa.Column('status', sa.String(20), nullable=False, server_default='unread'),
        sa.Column('read_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('delivered_via_ws', sa.Boolean(), nullable=False, server_default='false'),
        sa.Column('delivered_via_email', sa.Boolean(), nullable=False, server_default='false'),
        sa.Column('aggregation_id', postgresql.UUID(as_uuid=True), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
        sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE')
    )
    # Create indexes...
```

## Acceptance Criteria

- [ ] All three tables created with correct columns
- [ ] Foreign key to users.id with CASCADE delete
- [ ] Indexes on: user_id, (user_id, status, created_at), type, created_at DESC, aggregation_id
- [ ] Unique constraints on user_id (preferences) and organization_id
- [ ] Migration includes downgrade() method
