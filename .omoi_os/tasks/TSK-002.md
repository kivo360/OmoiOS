---
id: TSK-002
title: Create ConsolidationJob SQLAlchemy model
status: pending
ticket_id: TKT-001
parent_ticket: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on: []
  blocks:
    - TSK-004
---

# TSK-002: Create ConsolidationJob SQLAlchemy model

## Objective

Create the ConsolidationJob SQLAlchemy model for tracking consolidation job execution, status, and metrics.

## Context

The ConsolidationJob model tracks the lifecycle of consolidation jobs including their trigger type, execution status, phases completed, and performance metrics.

## Deliverables

- [ ] `backend/omoi_os/models/consolidation_job.py` - ConsolidationJob model class

## Implementation Notes

```python
# backend/omoi_os/models/consolidation_job.py
from datetime import datetime, timezone
from typing import TYPE_CHECKING, Optional
from uuid import uuid4

from sqlalchemy import DateTime, Integer, String, Text, Enum as SQLEnum
from sqlalchemy.dialects.postgresql import ARRAY as PG_ARRAY, JSONB
from sqlalchemy.orm import Mapped, mapped_column

from omoi_os.models.base import Base

if TYPE_CHECKING:
    from omoi_os.models.project import Project

class JobStatus(str, SQLEnum):
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"

class TriggerType(str, SQLEnum):
    SCHEDULED = "scheduled"
    MANUAL = "manual"
    THRESHOLD = "threshold"

class ConsolidationJob(Base):
    """Tracks consolidation job execution and results."""

    __tablename__ = "consolidation_jobs"

    id: Mapped[str] = mapped_column(
        String, primary_key=True, default=lambda: str(uuid4())
    )
    project_id: Mapped[str] = mapped_column(
        String, nullable=False
    )

    # Job info
    status: Mapped[str] = mapped_column(
        String(50), nullable=False, index=True
    )
    trigger_type: Mapped[str] = mapped_column(
        String(50), nullable=False
    )

    # Scope (flexible JSON for filters)
    scope: Mapped[Optional[dict]] = mapped_column(
        JSONB, nullable=True, default=lambda: {}
    )

    # Results
    phases_completed: Mapped[Optional[list[str]]] = mapped_column(
        PG_ARRAY(String), nullable=True, default=list
    )
    metrics: Mapped[Optional[dict]] = mapped_column(
        JSONB, nullable=True, default=lambda: {}
    )

    # Timing
    started_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    completed_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    duration_seconds: Mapped[Optional[int]] = mapped_column(Integer, nullable=True)

    # Error handling
    error_message: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    retry_count: Mapped[int] = mapped_column(Integer, nullable=False, default=0)
    max_retries: Mapped[int] = mapped_column(Integer, nullable=False, default=3)

    # Metadata
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, default=lambda: datetime.now(timezone.utc), index=True
    )
    triggered_by: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)

    def to_dict(self) -> dict:
        """Convert to dictionary for API responses."""
        return {
            "id": self.id,
            "project_id": self.project_id,
            "status": self.status,
            "trigger_type": self.trigger_type,
            "scope": self.scope or {},
            "phases_completed": self.phases_completed or [],
            "metrics": self.metrics or {},
            "started_at": self.started_at.isoformat() if self.started_at else None,
            "completed_at": self.completed_at.isoformat() if self.completed_at else None,
            "duration_seconds": self.duration_seconds,
            "error_message": self.error_message,
            "retry_count": self.retry_count,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "triggered_by": self.triggered_by,
        }
```

## Acceptance Criteria

- [ ] ConsolidationJob model created with all required fields
- [ ] JobStatus and TriggerType enums defined
- [ ] JSONB used for scope and metrics (flexible schema)
- [ ] PG_ARRAY used for phases_completed
- [ ] Indexes defined on project_id+status and created_at
- [ ] to_dict() method implemented
- [ ] Model imports without errors

## Dependencies

**Depends On**: None (can be done in parallel with TSK-001)
**Blocks**: TSK-004 (Migration uses this model)
