---
id: TSK-022
title: Create run_scheduled_consolidation Celery task
status: pending
ticket_id: TKT-004
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-011]
  blocks: [TSK-023]
---

# TSK-022: Create run_scheduled_consolidation Celery task

## Objective

Create the Celery task that runs scheduled consolidation for all projects exceeding the memory threshold.

## Context

The system should automatically check all projects and trigger consolidation for those exceeding the configured threshold.

## Deliverables

- `backend/omoi_os/tasks/consolidation_tasks.py` - run_scheduled_consolidation task

## Implementation Notes

```python
# omoi_os/tasks/consolidation_tasks.py
from celery import shared_task
from sqlalchemy.orm import Session
from sqlalchemy import select, func

from omoi_os.db.session import get_session
from omoi_os.models.project import Project
from omoi_os.models.task_memory import TaskMemory
from omoi_os.models.consolidation_job import ConsolidationJob

@shared_task(name="consolidation.run_scheduled")
def run_scheduled_consolidation():
    """
    Run consolidation for all projects exceeding threshold.

    Scheduled to run daily via Celery beat.
    """
    with get_session() as session:
        # Find projects exceeding threshold
        subq = (
            select(TaskMemory.project_id, func.count(TaskMemory.id).label("memory_count"))
            .where(TaskMemory.is_duplicate == False)
            .where(TaskMemory.is_archived == False)
            .group_by(TaskMemory.project_id)
            .subquery()
        )

        projects = session.execute(
            select(Project)
            .join(subq, Project.id == subq.c.project_id)
            .where(subq.c.memory_count > Project.consolidation_threshold)
            .where(Project.consolidation_enabled == True)
        ).scalars().all()

        results = []
        for project in projects:
            # Trigger per-project consolidation
            result = run_project_consolidation.delay(str(project.id))
            results.append({
                "project_id": str(project.id),
                "task_id": result.id,
            })

        return {
            "projects_queued": len(results),
            "results": results,
        }
```

## Acceptance Criteria

- [ ] Celery task created with name "consolidation.run_scheduled"
- [ ] Queries projects with memory count > threshold
- [ ] Only processes projects with consolidation_enabled=True
- [ ] Triggers per-project consolidation tasks
- [ ] Returns summary of queued projects
- [ ] Tests for various threshold scenarios

## Dependencies

**Depends On**: TSK-011 (ConsolidationService)
**Blocks**: TSK-023

## Estimate

**Size**: M (2-4 hours)
