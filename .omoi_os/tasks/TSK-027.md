---
id: TSK-027
title: Write tests for email delivery
status: pending
parent_ticket: TKT-004
estimate: M
type: test
dependencies:
  depends_on:
    - TSK-024
    - TSK-025
    - TSK-026
  blocks: []
---

# TSK-027: Write tests for email delivery

## Objective

Write tests for email notification service including retry logic and unsubscribe.

## Context

Tests ensure email delivery works correctly and handles failures gracefully.

## Deliverables

- [ ] `backend/tests/unit/test_email_notification_service.py` - Unit tests

## Implementation Notes

```python
# backend/tests/unit/test_email_notification_service.py

import pytest
from unittest.mock import Mock, AsyncMock, patch

from omoi_os.services.sendgrid_email_service import SendGridEmailNotificationService


@pytest.mark.asyncio
class TestEmailNotificationService:
    async def test_send_email_success(self):
        """Test successful email send."""
        service = SendGridEmailNotificationService(
            api_key="test-key",
            from_email="noreply@omoios.dev",
        )

        with patch.object(service.client, 'send') as mock_send:
            mock_send.return_value = Mock(status_code=202)

            result = await service.send_notification_email(mock_notification, mock_user)

            assert result is True
            mock_send.assert_called_once()

    async def test_send_email_retry_on_failure(self):
        """Test retry logic on transient failure."""
        service = SendGridEmailNotificationService(
            api_key="test-key",
            from_email="noreply@omoios.dev",
        )

        with patch.object(service.client, 'send') as mock_send:
            # Fail first two attempts, succeed third
            mock_send.side_effect = [Exception("Error"), Exception("Error"), Mock(status_code=202)]

            result = await service.send_notification_email(mock_notification, mock_user)

            assert result is True
            assert mock_send.call_count == 3

    async def test_send_email_failure_after_max_retries(self):
        """Test failure after max retries."""
        service = SendGridEmailNotificationService(
            api_key="test-key",
            from_email="noreply@omoios.dev",
        )

        with patch.object(service.client, 'send') as mock_send:
            mock_send.side_effect = Exception("Error")

            result = await service.send_notification_email(mock_notification, mock_user)

            assert result is False
            assert mock_send.call_count == 3

    async def test_unsubscribe_token_generation(self):
        """Test unsubscribe token generation."""
        from omoi_os.services.email_notification_service import generate_unsubscribe_token, validate_unsubscribe_token

        user_id = uuid4()
        token = generate_unsubscribe_token(user_id)

        decoded = validate_unsubscribe_token(token)
        assert decoded == user_id

    async def test_invalid_unsubscribe_token(self):
        """Test invalid unsubscribe token."""
        from omoi_os.services.email_notification_service import validate_unsubscribe_token

        result = validate_unsubscribe_token("invalid-token")
        assert result is None
```

## Acceptance Criteria

- [ ] Test for successful email send
- [ ] Test for retry on transient failure
- [ ] Test for failure after max retries
- [ ] Test for unsubscribe token generation
- [ ] Test for invalid unsubscribe token
- [ ] Tests use mocks for external email service
- [ ] Tests verify retry delay timing
