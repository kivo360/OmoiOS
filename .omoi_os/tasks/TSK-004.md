---
id: TSK-004
title: Implement supervisor health monitoring
status: pending
parent_ticket: TKT-001
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-001, TSK-003]
  blocks: []
---

# TSK-004: Implement supervisor health monitoring

## Objective

Implement health monitoring that tracks supervisor heartbeats and marks supervisors as unresponsive after missed heartbeats.

## Context

Supervisor health monitoring ensures that failed or stuck supervisors are detected and can be restarted. This task implements the heartbeat tracking and unresponsive detection logic.

## Deliverables

- [ ] `backend/omoi_os/services/supervisor_health.py` - Health monitoring service
- [ ] `backend/tests/unit/services/test_supervisor_health.py` - Unit tests

## Implementation Notes

```python
# backend/omoi_os/services/supervisor_health.py

from datetime import timedelta
from uuid import UUID
from typing import List, Dict, Any

from sqlalchemy import and_

from omoi_os.models.supervisor import Supervisor, SupervisorStatus
from omoi_os.services.database import DatabaseService
from omoi_os.utils.datetime import utc_now


class SupervisorHealthMonitor:
    """Monitor supervisor health and detect unresponsive supervisors."""

    def __init__(self, db: DatabaseService):
        """Initialize health monitor.

        Args:
            db: Database service
        """
        self.db = db
        self.missed_heartbeat_threshold = 3  # Number of missed heartbeats
        self.heartbeat_interval = 30  # Expected seconds between heartbeats

    def check_supervisor_health(self, supervisor_id: UUID) -> Dict[str, Any]:
        """Check health of a specific supervisor.

        Args:
            supervisor_id: UUID of supervisor to check

        Returns:
            Health status dict
        """
        with self.db.get_session() as session:
            supervisor = session.get(Supervisor, supervisor_id)
            if not supervisor:
                return {"status": "not_found"}

            last_heartbeat = supervisor.last_heartbeat
            if not last_heartbeat:
                return {
                    "status": "unknown",
                    "reason": "No heartbeats received",
                }

            time_since_heartbeat = utc_now() - last_heartbeat
            missed_count = int(time_since_heartbeat.total_seconds() / self.heartbeat_interval)

            if missed_count >= self.missed_heartbeat_threshold:
                return {
                    "status": "unresponsive",
                    "missed_heartbeats": missed_count,
                    "last_heartbeat": last_heartbeat.isoformat(),
                }

            return {
                "status": "healthy",
                "missed_heartbeats": 0,
                "last_heartbeat": last_heartbeat.isoformat(),
            }

    def get_unresponsive_supervisors(self) -> List[Supervisor]:
        """Get all supervisors that have missed threshold heartbeats."""
        cutoff = utc_now() - timedelta(seconds=self.heartbeat_interval * self.missed_heartbeat_threshold)

        with self.db.get_session() as session:
            supervisors = (
                session.query(Supervisor)
                .filter(
                    and_(
                        Supervisor.status == SupervisorStatus.ACTIVE,
                        Supervisor.last_heartbeat < cutoff,
                    )
                )
                .all()
            )
            for s in supervisors:
                session.expunge(s)
            return supervisors

    def mark_supervisor_unresponsive(self, supervisor_id: UUID) -> bool:
        """Mark a supervisor as unresponsive.

        Args:
            supervisor_id: UUID of supervisor to mark

        Returns:
            True if marked successfully
        """
        with self.db.get_session() as session:
            supervisor = session.get(Supervisor, supervisor_id)
            if not supervisor:
                return False

            supervisor.status = SupervisorStatus.FAILED
            supervisor.health_metrics = supervisor.health_metrics or {}
            supervisor.health_metrics["failure_reason"] = "Missed heartbeats"
            session.commit()
            return True
```

## Acceptance Criteria

- [ ] Health monitor tracks heartbeats for all supervisors
- [ ] Supervisors with 3+ missed heartbeats marked unresponsive
- [ ] Health check returns detailed status for any supervisor
- [ ] Query for all unresponsive supervisors
- [ ] Unit tests cover health scenarios

## Dependencies

**Depends On**: TSK-001 (Database models), TSK-003 (SupervisorAgent)
**Blocks**: None

## Estimate

**Size**: S (<2 hours)
