---
id: TSK-004
title: Implement internal event publishing API
status: pending
parent_ticket: TKT-003
estimate: S
created: 2026-01-08
type: implementation
dependencies:
  depends_on:
    - TSK-002
  blocks: []
---

# TSK-004: Implement Internal Event Publishing API

## Objective

Create the internal HTTP endpoint `/api/v1/internal/ws/publish` that agent workers use to publish events to the WebSocket infrastructure.

## Context

Agent workers need an API to publish events (status changes, progress updates) that will be delivered to subscribed clients via WebSocket. This is a service-to-service endpoint protected by internal authentication.

## Deliverables

- [ ] `backend/omoi_os/api/routes/internal.py` - Add publish endpoint (or create new file)

## Implementation Notes

Endpoint implementation:
```python
@router.post("/api/v1/internal/ws/publish")
async def publish_agent_event(
    request: Request,
    event: AgentEventPublishRequest,
    x_internal_service_key: str = Header(...),
):
    # 1. Validate service key
    # 2. Publish to Redis Pub/Sub
    # 3. Store in Redis Streams for replay
    # 4. Return 202 Accepted
```

Request model:
```python
class AgentEventPublishRequest(BaseModel):
    event_type: str
    agent_id: str
    user_id: str
    project_id: str
    payload: dict
```

## Acceptance Criteria

- [ ] Service key validation rejects unauthorized requests
- [ ] Events are published to correct Redis channel
- [ ] Events are stored in Redis Streams for replay
- [ ] Returns 202 Accepted on success
- [ ] Returns 401/403 on auth failures
- [ ] Returns 400 on validation errors
- [ ] Integration tests verify event delivery

## Dependencies

**Depends On**: TSK-002 (ScalableConnectionManager)

**Blocks**: None

## Estimate

**Size**: S (< 2 hours)

**Rationale**: Simple HTTP endpoint with Redis Pub/Sub and Streams integration.
