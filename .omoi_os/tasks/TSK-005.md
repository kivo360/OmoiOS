---
id: TSK-005
title: Create supervisor API routes
status: pending
ticket_id: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-001, TSK-002, TSK-003, TSK-004]
  blocks: []
---

# TSK-005: Create supervisor API routes

## Objective

Create FastAPI routes for supervisor management including CRUD operations, lifecycle control, and health queries.

## Context

This task exposes supervisor functionality via REST API, allowing external systems and the frontend to create, manage, and monitor supervisors.

## Deliverables

- [ ] `backend/omoi_os/api/routes/supervisors.py` - FastAPI routes
- [ ] `backend/tests/api/test_supervisors_routes.py` - API integration tests

## Implementation Notes

```python
# backend/omoi_os/api/routes/supervisors.py

from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session

from omoi_os.api.dependencies import get_db
from omoi_os.models.supervisor import Supervisor, SupervisorStatus
from omoi_os.services.supervisor_agent import SupervisorAgent
from omoi_os.services.team_manager import TeamManager
from omoi_os.services.database import DatabaseService
from omoi_os.services.event_bus import get_event_bus
from omoi_os.schemas.supervisor import (
    SupervisorCreate,
    SupervisorResponse,
    TeamCreate,
    TeamResponse,
    SupervisorHealthResponse,
)

router = APIRouter(prefix="/supervisors", tags=["supervisors"])


@router.post("", response_model=SupervisorResponse, status_code=status.HTTP_201_CREATED)
def create_supervisor(
    data: SupervisorCreate,
    db: Session = Depends(get_db),
) -> Supervisor:
    """Create a new supervisor."""
    db_service = DatabaseService(db)

    # Check for name uniqueness within parent
    existing = (
        db.session.query(Supervisor)
        .filter(
            Supervisor.name == data.name,
            Supervisor.parent_id == (data.parent_id or None),
        )
        .first()
    )
    if existing:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Supervisor name must be unique within hierarchy level",
        )

    # Validate hierarchy depth if parent provided
    if data.parent_id:
        parent = db.session.get(Supervisor, data.parent_id)
        if not parent:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"Parent supervisor {data.parent_id} not found",
            )
        # Check depth (should be <5)
        if parent.hierarchy_level >= 5:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Cannot create supervisor: hierarchy depth would exceed 5",
            )

    supervisor = Supervisor(
        name=data.name,
        description=data.description,
        config=data.config,
        parent_id=data.parent_id,
        hierarchy_level=(parent.hierarchy_level + 1) if data.parent_id else 0,
        status=SupervisorStatus.SPAWNING,
    )
    db.session.add(supervisor)
    db.session.commit()
    db.session.refresh(supervisor)

    return supervisor


@router.get("", response_model=List[SupervisorResponse])
def list_supervisors(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db),
) -> List[Supervisor]:
    """List all supervisors."""
    query = db.session.query(Supervisor).offset(skip).limit(limit)
    return query.all()


@router.get("/{supervisor_id}", response_model=SupervisorResponse)
def get_supervisor(
    supervisor_id: UUID,
    db: Session = Depends(get_db),
) -> Supervisor:
    """Get a supervisor by ID."""
    supervisor = db.session.get(Supervisor, supervisor_id)
    if not supervisor:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Supervisor {supervisor_id} not found",
        )
    return supervisor


@router.post("/{supervisor_id}/pause")
async def pause_supervisor(
    supervisor_id: UUID,
    db: Session = Depends(get_db),
) -> dict:
    """Pause a supervisor."""
    # Implementation would get supervisor instance and call pause()
    return {"status": "paused", "supervisor_id": str(supervisor_id)}


@router.post("/{supervisor_id}/resume")
async def resume_supervisor(
    supervisor_id: UUID,
    db: Session = Depends(get_db),
) -> dict:
    """Resume a paused supervisor."""
    # Implementation would get supervisor instance and call resume()
    return {"status": "resumed", "supervisor_id": str(supervisor_id)}


@router.get("/{supervisor_id}/health", response_model=SupervisorHealthResponse)
def get_supervisor_health(
    supervisor_id: UUID,
    db: Session = Depends(get_db),
) -> dict:
    """Get supervisor health status."""
    # Implementation would use SupervisorHealthMonitor
    return {
        "supervisor_id": str(supervisor_id),
        "status": "healthy",
        "last_heartbeat": "2025-01-08T10:00:00Z",
    }


@router.post("/{supervisor_id}/teams", response_model=TeamResponse, status_code=status.HTTP_201_CREATED)
def create_team(
    supervisor_id: UUID,
    data: TeamCreate,
    db: Session = Depends(get_db),
) -> dict:
    """Create a team within a supervisor."""
    supervisor = db.session.get(Supervisor, supervisor_id)
    if not supervisor:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Supervisor {supervisor_id} not found",
        )

    db_service = DatabaseService(db)
    team_manager = TeamManager(db_service, supervisor_id)

    team = team_manager.create_team(
        name=data.name,
        description=data.description,
        objective=data.objective,
        config=data.config,
        agent_ids=data.agent_ids,
    )

    return team
```

## Acceptance Criteria

- [ ] POST /supervisors creates new supervisor
- [ ] GET /supervisors lists all supervisors with pagination
- [ ] GET /supervisors/{id} returns specific supervisor
- [ ] POST /supervisors/{id}/pause pauses supervisor
- [ ] POST /supervisors/{id}/resume resumes supervisor
- [ ] GET /supervisors/{id}/health returns health status
- [ ] POST /supervisors/{id}/teams creates team
- [ ] All endpoints have proper error handling
- [ ] API integration tests verify all endpoints

## Dependencies

**Depends On**: TSK-001 (Database models), TSK-002 (TeamManager), TSK-003 (SupervisorAgent), TSK-004 (Health monitoring)
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
