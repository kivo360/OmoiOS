---
id: TSK-005
title: Create database indexes for performance
status: pending
ticket_id: TKT-001
parent_ticket: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on:
    - TSK-004
  blocks: []
---

# TSK-005: Create database indexes for performance

## Objective

Add performance-critical indexes to the consolidation schema. These are included in the migration but documented separately for clarity.

## Context

The consolidation system requires efficient similarity search, filtering, and lineage queries. Proper indexing is critical for meeting performance SLAs.

## Deliverables

- [ ] Indexes created via migration (in TSK-004)

## Implementation Notes

The following indexes are created as part of TSK-004:

**Consolidated Memories:**
- `idx_cm_project` - B-tree on project_id (for project filtering)
- `idx_cm_abstraction` - B-tree on abstraction_level (for level filtering)
- `idx_cm_type` - B-tree on memory_type (for type filtering)
- `idx_cm_pattern` - B-tree on pattern_type (for pattern type filtering)
- `idx_cm_created` - B-tree on consolidated_at DESC (for recent-first queries)
- `idx_cm_tags` - GIN on tags (for array contains queries)
- `idx_cm_source_ids` - GIN on source_memory_ids (for lineage lookups)
- `idx_cm_embedding` - HNSW on embedding (for vector similarity search)
- `idx_cm_content_tsv` - GIN on content_tsv (for full-text search)

**Consolidation Jobs:**
- `idx_cj_project_status` - Composite on (project_id, status) (for job queries)
- `idx_cj_created` - B-tree on created_at DESC (for recent jobs)
- `idx_cj_trigger_type` - B-tree on trigger_type (for trigger filtering)

**Task Memories:**
- `idx_tm_consolidated` - Partial on is_consolidated=true (for unconsolidated queries)
- `idx_tm_consolidated_into` - Partial on consolidated_into_id (for lineage forward lookups)

## Acceptance Criteria

- [ ] All indexes listed above created in migration
- [ ] HNSW index uses vector_cosine_ops for pgvector
- [ ] Partial indexes use WHERE clauses appropriately
- [ ] Indexes verified with `\di` in psql

## Dependencies

**Depends On**: TSK-004 (Migration file)
**Blocks**: None

## Verification

```sql
-- Verify all indexes exist
SELECT indexname, tablename
FROM pg_indexes
WHERE tablename IN ('consolidated_memories', 'consolidation_jobs', 'task_memories')
  AND indexname LIKE 'idx_%'
ORDER BY tablename, indexname;

-- Check HNSW index specifically
SELECT indexname, indexdef
FROM pg_indexes
WHERE indexname = 'idx_cm_embedding';

-- Verify index usage with EXPLAIN
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM consolidated_memories
WHERE project_id = 'test-project'
  AND abstraction_level = 2
LIMIT 10;
```
