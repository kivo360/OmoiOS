---
id: TSK-003
title: Extend TaskMemory model with consolidation fields
status: pending
ticket_id: TKT-001
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-001]
  blocks: []
---

# TSK-003: Extend TaskMemory model with consolidation fields

## Objective

Add consolidation-related fields to the existing TaskMemory model to support consolidation tracking.

## Context

The TaskMemory model needs new fields to track which memories are consolidated, which are summaries, and which are archived. These fields allow the consolidation service to query and update memories properly.

## Deliverables

- `backend/omoi_os/models/task_memory.py` - Extended with consolidation fields

## Implementation Notes

Add these fields to the existing TaskMemory model:

```python
# Add to omoi_os/models/task_memory.py

from sqlalchemy import ARRAY, Boolean, DateTime, Float, String
from sqlalchemy.dialects.postgresql import UUID

class TaskMemory(Base):
    # ... existing fields ...

    # Consolidation fields
    consolidated_from: Mapped[Optional[List[str]]] = mapped_column(
        ARRAY(UUID),
        nullable=True,
        comment="Source memory IDs if this is a consolidation",
    )
    consolidated_at: Mapped[Optional[Instant]] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="When this memory was consolidated",
    )
    synthesized_from: Mapped[Optional[List[str]]] = mapped_column(
        ARRAY(UUID),
        nullable=True,
        comment="Source cluster IDs if this is a synthesis",
    )
    synthesized_at: Mapped[Optional[Instant]] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        comment="When this synthesis was created",
    )
    synthesis_confidence: Mapped[Optional[float]] = mapped_column(
        Float,
        nullable=True,
        comment="Confidence score for synthesis",
    )
    is_archived: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=False,
        index=True,
        comment="Whether memory is archived",
    )
    archived_at: Mapped[Optional[Instant]] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
        comment="When memory was archived",
    )
    archive_reason: Mapped[Optional[str]] = mapped_column(
        String(50),
        nullable=True,
        comment="Reason for archival: staleness, low_value, manual",
    )
```

## Acceptance Criteria

- [ ] All consolidation fields added to TaskMemory
- [ ] Proper nullable/default values
- [ ] Indexes created for consolidated_at, synthesized_at, is_archived
- [ ] Field comments/descriptions added
- [ ] Existing TaskMemory functionality preserved
- [ ] Model tests pass with new fields

## Dependencies

**Depends On**: TSK-001 (Database migration)
**Blocks**: None

## Estimate

**Size**: S (< 2 hours)
