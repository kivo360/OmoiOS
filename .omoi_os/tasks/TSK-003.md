---
id: TSK-003
title: Implement /ws/agents WebSocket endpoint
status: pending
parent_ticket: TKT-003
estimate: M
created: 2026-01-08
type: implementation
dependencies:
  depends_on:
    - TSK-002
  blocks:
    - TSK-005
---

# TSK-003: Implement /ws/agents WebSocket Endpoint

## Objective

Create the `/ws/agents` WebSocket route that handles agent status and progress streaming with authentication and subscription filtering.

## Context

The `/ws/agents` endpoint is the primary interface for clients to receive real-time AI agent updates. It integrates the ScalableConnectionManager with FastAPI routing.

## Deliverables

- [ ] `backend/omoi_os/api/routes/websocket_agents.py` - Complete WebSocket route implementation

## Implementation Notes

Route implementation:
```python
@router.websocket("/ws/agents")
async def websocket_agents(
    websocket: WebSocket,
    token: str = Query(...),  # JWT
    agent_ids: Optional[str] = Query(None),
    project_ids: Optional[str] = Query(None),
    event_types: Optional[str] = Query(None),
    encoding: str = Query("json"),
    compression: bool = Query(False),
):
    # 1. Validate JWT token
    # 2. Parse filters
    # 3. Create connection via ScalableConnectionManager
    # 4. Return connection_id
```

## Acceptance Criteria

- [ ] JWT authentication is required (401 if invalid)
- [ ] Query parameters are parsed and validated
- [ ] Filters are applied correctly
- [ ] Connection is registered with ScalableConnectionManager
- [ ] WebSocket accepts connection successfully
- [ ] Error responses return appropriate close codes
- [ ] Integration tests verify end-to-end flow

## Dependencies

**Depends On**: TSK-002 (ScalableConnectionManager)

**Blocks**: TSK-005 (Client Integration)

## Estimate

**Size**: M (2-4 hours)

**Rationale**: Straightforward route implementation with proper error handling and parameter parsing.
