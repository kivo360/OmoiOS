---
id: TSK-003
title: Implement SupervisorAgent core service
status: pending
parent_ticket: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-001, TSK-002]
  blocks: []
---

# TSK-003: Implement SupervisorAgent core service

## Objective

Implement the SupervisorAgent core service that orchestrates supervisor lifecycle, policy evaluation coordination, and team management.

## Context

The SupervisorAgent is the main service class that ties together all supervisor functionality. It manages the supervisor lifecycle, coordinates with monitoring services, and provides the primary interface for supervisor operations.

## Deliverables

- [ ] `backend/omoi_os/services/supervisor_agent.py` - SupervisorAgent service class
- [ ] `backend/tests/unit/services/test_supervisor_agent.py` - Unit tests

## Implementation Notes

```python
# backend/omoi_os/services/supervisor_agent.py

import asyncio
import logging
from uuid import UUID
from typing import Dict, List, Any, Optional
from datetime import datetime

from omoi_os.models.supervisor import SupervisorStatus
from omoi_os.services.database import DatabaseService
from omoi_os.services.event_bus import EventBusService, SystemEvent
from omoi_os.services.team_manager import TeamManager
from omoi_os.utils.datetime import utc_now

logger = logging.getLogger(__name__)


class SupervisorAgent:
    """Main supervisor orchestration service.

    Coordinates monitoring services, manages teams, and executes interventions.
    """

    def __init__(
        self,
        supervisor_id: UUID,
        db: DatabaseService,
        event_bus: EventBusService,
    ):
        """Initialize supervisor agent.

        Args:
            supervisor_id: UUID of this supervisor
            db: Database service
            event_bus: Event bus for publishing events
        """
        self.supervisor_id = supervisor_id
        self.db = db
        self.event_bus = event_bus

        # Initialize components
        self.team_manager = TeamManager(db, supervisor_id)

        # State
        self.running = False
        self.status = SupervisorStatus.SPAWNING

        # Background tasks
        self._heartbeat_task: Optional[asyncio.Task] = None

    async def start(self) -> None:
        """Start supervisor operation."""
        logger.info(f"Starting supervisor {self.supervisor_id}")

        if self.running:
            logger.warning(f"Supervisor {self.supervisor_id} is already running")
            return

        self.running = True
        self.status = SupervisorStatus.ACTIVE

        # Update status in database
        self._update_status(SupervisorStatus.ACTIVE)

        # Start background tasks
        self._heartbeat_task = asyncio.create_task(self._heartbeat_loop())

        # Publish startup event
        self._publish_event("started", {
            "timestamp": utc_now().isoformat(),
        })

        logger.info(f"Supervisor {self.supervisor_id} started successfully")

    async def stop(self) -> None:
        """Stop supervisor operation."""
        logger.info(f"Stopping supervisor {self.supervisor_id}")

        if not self.running:
            logger.warning(f"Supervisor {self.supervisor_id} is not running")
            return

        self.running = False
        self.status = SupervisorStatus.TERMINATED

        # Cancel background tasks
        if self._heartbeat_task:
            self._heartbeat_task.cancel()
            try:
                await self._heartbeat_task
            except asyncio.CancelledError:
                pass

        # Update status in database
        self._update_status(SupervisorStatus.TERMINATED)

        # Publish shutdown event
        self._publish_event("stopped", {
            "timestamp": utc_now().isoformat(),
        })

        logger.info(f"Supervisor {self.supervisor_id} stopped successfully")

    async def pause(self) -> None:
        """Pause supervisor (keep alive but stop monitoring)."""
        logger.info(f"Pausing supervisor {self.supervisor_id}")

        self.status = SupervisorStatus.PAUSED
        self._update_status(SupervisorStatus.PAUSED)

        self._publish_event("paused", {
            "timestamp": utc_now().isoformat(),
        })

    async def resume(self) -> None:
        """Resume paused supervisor."""
        logger.info(f"Resuming supervisor {self.supervisor_id}")

        self.status = SupervisorStatus.ACTIVE
        self._update_status(SupervisorStatus.ACTIVE)

        self._publish_event("resumed", {
            "timestamp": utc_now().isoformat(),
        })

    async def get_team_status(self) -> Dict[str, Any]:
        """Get status of all teams managed by this supervisor."""
        teams = self.team_manager.get_teams()
        team_statuses = []

        for team in teams:
            members = self.team_manager.get_team_members(team.id)
            team_statuses.append({
                "team_id": str(team.id),
                "team_name": team.name,
                "objective": team.objective,
                "member_count": len(members),
                "active_members": sum(1 for m in members if m.left_at is None),
            })

        return {
            "supervisor_id": str(self.supervisor_id),
            "status": self.status,
            "teams": team_statuses,
            "total_teams": len(teams),
            "total_members": sum(t["active_members"] for t in team_statuses),
        }

    async def _heartbeat_loop(self) -> None:
        """Background heartbeat loop."""
        heartbeat_interval = 30  # seconds

        while self.running:
            try:
                self._send_heartbeat()
                await asyncio.sleep(heartbeat_interval)
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"Heartbeat error for supervisor {self.supervisor_id}: {e}")
                await asyncio.sleep(5)  # Brief pause on error

    def _send_heartbeat(self) -> None:
        """Send heartbeat to database."""
        with self.db.get_session() as session:
            supervisor = session.get(Supervisor, self.supervisor_id)  # type: ignore
            if supervisor:
                supervisor.last_heartbeat = utc_now()
                session.commit()

    def _update_status(self, status: str) -> None:
        """Update supervisor status in database."""
        with self.db.get_session() as session:
            supervisor = session.get(Supervisor, self.supervisor_id)  # type: ignore
            if supervisor:
                supervisor.status = status
                session.commit()

    def _publish_event(self, event_type: str, payload: Dict[str, Any]) -> None:
        """Publish supervisor event."""
        event = SystemEvent(
            event_type=f"supervisor.{event_type}",
            entity_type="supervisor",
            entity_id=str(self.supervisor_id),
            payload=payload,
        )
        self.event_bus.publish(event)
```

## Acceptance Criteria

- [ ] SupervisorAgent implements start/stop/pause/resume lifecycle
- [ ] Heartbeats sent every 30 seconds while running
- [ ] Status transitions persisted to database
- [ ] All lifecycle events published to EventBus
- [ ] get_team_status returns accurate team information
- [ ] Unit tests cover all lifecycle transitions
- [ ] Integration tests verify database persistence

## Dependencies

**Depends On**: TSK-001 (Database models), TSK-002 (TeamManager)
**Blocks**: TSK-004 (Health monitoring), TSK-005 (API routes)

## Estimate

**Size**: M (2-4 hours)
