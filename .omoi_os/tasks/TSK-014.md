---
id: TSK-014
title: Write integration tests for full workflow
status: pending
created: 2025-01-08
parent_ticket: TKT-002
estimate: M
type: test
dependencies:
  depends_on: [TSK-011, TSK-012, TSK-013]
  blocks: []
---

# TSK-014: Write integration tests for full workflow

## Objective

Create integration tests that verify the full consolidation workflow works end-to-end.

## Context

Integration tests verify that all components work together correctly with real database operations.

## Deliverables

- `backend/tests/integration/test_consolidation_workflow.py`

## Implementation Notes

```python
# tests/integration/test_consolidation_workflow.py
import pytest
from omoi_os.services.consolidation.consolidation_service import ConsolidationService
from omoi_os.schemas.consolidation import ConsolidationOptions

@pytest.mark.asyncio
async def test_full_consolidation_workflow(db_session, project, sample_memories):
    """Test the complete consolidation workflow."""
    # Setup
    service = ConsolidationService(memory_service, embedding_service)
    options = ConsolidationOptions(
        merge=True,
        summarize=True,
        archive=True,
        promote=True,
    )

    # Execute
    result = await service.execute_consolidation(
        session=db_session,
        project_id=project.id,
        options=options,
        trigger_type="manual",
        triggered_by="test-user",
    )

    # Verify
    assert result.operation == "consolidation"
    assert len(result.created_memory_ids) > 0
    assert result.reduction_ratio > 0

    # Check consolidation job
    job = db_session.get(ConsolidationJob, result.job_id)
    assert job.status == "completed"
    assert job.memories_merged > 0

    # Check consolidation changes
    changes = db_session.query(ConsolidationChange).filter(
        ConsolidationChange.consolidation_job_id == result.job_id
    ).all()
    assert len(changes) > 0

    # Verify merged memories
    for mem_id in result.created_memory_ids:
        mem = db_session.get(TaskMemory, mem_id)
        assert mem.memory_type in ("consolidated", "synthesis")
        assert mem.consolidated_from or mem.synthesized_from

    # Verify archived memories
    for mem_id in result.archived_memory_ids:
        mem = db_session.get(TaskMemory, mem_id)
        assert mem.is_archived == True
        assert mem.archive_reason is not None

@pytest.mark.asyncio
async def test_consolidation_with_errors(db_session, project):
    """Test error handling in consolidation."""
    service = ConsolidationService(memory_service, embedding_service)

    # Trigger error (e.g., invalid project)
    with pytest.raises(Exception):
        await service.execute_consolidation(
            session=db_session,
            project_id="invalid-id",
            options=ConsolidationOptions(),
            trigger_type="manual",
            triggered_by="test-user",
        )

    # Verify job marked as failed
    jobs = db_session.query(ConsolidationJob).filter(
        ConsolidationJob.project_id == "invalid-id"
    ).all()
    assert len(jobs) > 0
    assert jobs[0].status == "failed"
    assert jobs[0].error_message is not None
```

## Acceptance Criteria

- [ ] Full workflow test with all options enabled
- [ ] Test with individual options (merge only, archive only)
- [ ] Error handling test with invalid input
- [ ] Job status tracking test
- [ ] Audit logging verification
- [ ] Database state verification after consolidation
- [ ] Test rollback scenario
- [ ] All tests passing

## Dependencies

**Depends On**: TSK-011, TSK-012, TSK-013
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
