---
id: TSK-026
title: Integrate with NotificationService
status: pending
parent_ticket: TKT-004
estimate: S
type: implementation
dependencies:
  depends_on:
    - TSK-003
    - TSK-024
  blocks: []
---

# TSK-026: Integrate with NotificationService

## Objective

Integrate email delivery into NotificationService so emails are sent based on user preferences.

## Context

NotificationService should check email preferences and trigger email delivery when appropriate.

## Deliverables

- [ ] Update NotificationService to use EmailNotificationService

## Implementation Notes

```python
# In NotificationService.__init__
def __init__(
    self,
    db: DatabaseService,
    ws_manager: Optional["WebSocketManager"] = None,
    email_service: Optional[EmailNotificationService] = None,
):
    self.db = db
    self.ws_manager = ws_manager
    self.email_service = email_service

# In NotificationService.create_notification
async def create_notification(
    self,
    user_id: UUID,
    type: str,
    title: str,
    message: str,
    data: Dict[str, Any],
) -> Optional[Notification]:
    """Create and deliver a notification."""
    # ... preference checking, rate limiting, aggregation ...

    notification = await self._create_in_db(user_id, type, title, message, data)

    # Deliver in-app
    if prefs.in_app_enabled(type):
        await self._deliver_websocket(notification)

    # Deliver email
    if self.email_service and prefs.email_enabled(type):
        await self._deliver_email(notification)

    return notification

async def _deliver_email(self, notification: Notification):
    """Deliver notification via email (async, non-blocking)."""
    # Get user
    user = await self._get_user(notification.user_id)

    # Send in background task
    asyncio.create_task(
        self.email_service.send_notification_email(notification, user)
    )

    # Mark as attempted
    await self._mark_email_delivered(notification.id)
```

## Acceptance Criteria

- [ ] NotificationService accepts EmailNotificationService
- [ ] Email delivery triggered based on email preferences
- [ ] Email delivery is async (doesn't block notification creation)
- [ ] Email delivery failures logged but don't affect notification
- [ ] delivered_via_email flag set on success
