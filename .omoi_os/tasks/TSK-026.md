---
id: TSK-026
title: Write tests for scheduled tasks
status: pending
ticket_id: TKT-004
estimate: M
type: test
dependencies:
  depends_on: [TSK-022, TSK-023, TSK-024, TSK-025]
  blocks: []
---

# TSK-026: Write tests for scheduled tasks

## Objective

Create tests for the scheduled consolidation Celery tasks.

## Context

Tests should verify the scheduled job runs correctly, checks thresholds, and triggers per-project consolidation.

## Deliverables

- `backend/tests/tasks/test_consolidation_tasks.py`

## Implementation Notes

```python
# tests/tasks/test_consolidation_tasks.py
import pytest
from unittest.mock import patch, MagicMock
from omoi_os.tasks.consolidation_tasks import run_scheduled_consolidation, run_project_consolidation

@pytest.mark.celery
def test_run_scheduled_consolidation(db_session, projects_with_memory_counts):
    """Test scheduled consolidation triggers for eligible projects."""
    with patch('omoii_os.tasks.consolidation_tasks.run_project_consolidation.delay') as mock_delay:
        mock_delay.return_value = MagicMock(id="test-task-id")

        result = run_scheduled_consolidation()

        # Should have triggered for projects exceeding threshold
        assert result["projects_queued"] > 0
        assert mock_delay.call_count > 0

@pytest.mark.celery
@pytest.mark.asyncio
async def test_run_project_consolidation_success(db_session, project):
    """Test per-project consolidation task."""
    with patch('omoii_os.services.consolidation.consolidation_service.get_consolidation_service') as mock_service:
        mock_result = ConsolidationResult(
            job_id="test-job",
            operation="consolidation",
            created_memory_ids=["mem-1", "mem-2"],
            modified_memory_ids=[],
            archived_memory_ids=[],
            input_count=10,
            output_count=2,
            reduction_ratio=0.8,
            consolidation_change_ids=[],
        )
        mock_service.return_value.execute_consolidation.return_value = mock_result

        result = run_project_consolidation(str(project.id))

        assert result["status"] == "completed"
        assert result["memories_merged"] == 2

@pytest.mark.celery
def test_run_project_consolidation_disabled_project(db_session, project):
    """Test consolidation skipped for disabled projects."""
    project.consolidation_enabled = False

    result = run_project_consolidation(str(project.id))

    assert "error" in result
    assert "disabled" in result["error"].lower()
```

## Acceptance Criteria

- [ ] Test run_scheduled_consolidation with multiple projects
- [ ] Test run_project_consolidation success case
- [ ] Test run_project_consolidation with disabled project
- [ ] Test run_project_consolidation error handling
- [ ] Test threshold checking logic
- [ ] Tests for retry behavior
- [ ] All tests passing

## Dependencies

**Depends On**: TSK-022, TSK-023, TSK-024, TSK-025
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
