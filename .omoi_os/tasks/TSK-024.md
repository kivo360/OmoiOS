---
id: TSK-024
title: Implement email sending with retry logic
status: pending
parent_ticket: TKT-004
estimate: M
type: implementation
dependencies:
  depends_on:
    - TSK-022
    - TSK-023
  blocks:
    - TSK-026
---

# TSK-024: Implement email sending with retry logic

## Objective

Implement a concrete email service with retry logic and exponential backoff.

## Context

Email delivery can fail temporarily. Retry logic ensures notifications are eventually delivered.

## Deliverables

- [ ] `omoi_os/services/sendgrid_email_service.py` - SendGrid implementation (example)

## Implementation Notes

```python
# omoi_os/services/sendgrid_email_service.py

import asyncio
from datetime import timedelta
from typing import Optional

from sendgrid import SendGridAPIClient
from sendgrid.helpers.mail import Mail
from jinja2 import Template

from omoi_os.services.email_notification_service import EmailNotificationService
from omoi_os.models.notification import Notification
from omoi_os.models.user import User


class SendGridEmailNotificationService(EmailNotificationService):
    """SendGrid implementation of email notifications."""

    MAX_RETRIES = 3
    RETRY_DELAYS = [1, 2, 4]  # seconds

    def __init__(
        self,
        api_key: str,
        from_email: str,
        from_name: str = "OmoiOS",
        base_url: str = "https://app.omoios.dev",
    ):
        self.client = SendGridAPIClient(api_key)
        self.from_email = from_email
        self.from_name = from_name
        self.base_url = base_url
        self.html_template = self._load_template("notification.html.j2")
        self.text_template = self._load_template("notification.txt.j2")

    async def send_notification_email(
        self, notification: Notification, user: User
    ) -> bool:
        """Send notification email with retry logic."""
        for attempt, delay in enumerate(self.RETRY_DELAYS):
            try:
                success = await self._attempt_send(notification, user)
                if success:
                    return True
            except Exception as e:
                if attempt == len(self.RETRY_DELAYS) - 1:
                    # Log final failure
                    print(f"Email delivery failed after {self.MAX_RETRIES} attempts: {e}")
                    return False

                # Wait before retry
                await asyncio.sleep(delay)

        return False

    async def _attempt_send(
        self, notification: Notification, user: User
    ) -> bool:
        """Single send attempt."""
        # Render templates
        html_content = self.html_template.render(
            notification=notification,
            user=user,
            action_url=f"{self.base_url}/notifications/{notification.id}",
            unsubscribe_url=f"{self.base_url}/notifications/unsubscribe?token={user.id}",
        )

        # Create email
        message = Mail(
            from_email=self.from_email,
            to_emails=user.email,
            subject=notification.title,
            html_content=html_content,
        )

        # Send
        response = self.client.send(message)
        return response.status_code in (200, 202)

    def _load_template(self, name: str) -> Template:
        """Load Jinja2 template."""
        # Implementation...
        pass
```

## Acceptance Criteria

- [ ] Email sending with up to 3 retries
- [ ] Exponential backoff between retries (1s, 2s, 4s)
- [ ] Template rendering with Jinja2
- [ ] Action link to notification in app
- [ ] Unsubscribe link in email footer
- [ ] Error logging for failed deliveries
- [ ] Returns success/failure status
