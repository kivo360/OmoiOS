---
id: TSK-019
title: Implement POST /rollback endpoint
status: pending
ticket_id: TKT-003
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-015]
  blocks: []
---

# TSK-019: Implement POST /rollback endpoint

## Objective

Implement the POST /api/v1/consolidation/rollback endpoint for rolling back consolidation operations.

## Context

Users need to undo consolidation operations if they were incorrect or undesirable. Rollback must validate the 7-day window and check for conflicts.

## Deliverables

- POST /rollback endpoint implementation

## Implementation Notes

```python
@router.post("/rollback", response_model=RollbackResponse)
async def rollback_consolidation(
    request: RollbackRequest,
    current_user = Depends(get_current_admin_user),
    db: Session = Depends(get_db),
):
    # Get consolidation
    consolidation = db.query(ConsolidationChange).filter(
        ConsolidationChange.id == request.consolidation_id
    ).first()

    if not consolidation:
        raise HTTPException(status_code=404, detail="Consolidation not found")

    # Check 7-day window
    if consolidation.changed_at < utc_now() - timedelta(days=7):
        raise HTTPException(status_code=400, detail="Rollback window expired (7 days)")

    # Check for conflicts
    conflicts = db.query(ConsolidationChange).filter(
        ConsolidationChange.memory_id == consolidation.memory_id,
        ConsolidationChange.changed_at > consolidation.changed_at,
    ).count()

    if conflicts > 0:
        return RollbackResponse(
            success=False,
            rollback_id=None,
            memories_restored=0,
            memories_deleted=0,
            warnings=["Conflicting changes exist after consolidation"],
        )

    # Perform rollback
    service = get_consolidation_service()
    result = await service.rollback_consolidation(
        session=db,
        consolidation_id=request.consolidation_id,
        reason=request.reason,
        user_id=current_user.id,
    )

    return result
```

Rollback implementation in service:
```python
async def rollback_consolidation(
    self,
    session: Session,
    consolidation_id: str,
    reason: Optional[str],
    user_id: str,
) -> RollbackResponse:
    """Rollback a consolidation operation."""
    change = session.get(ConsolidationChange, consolidation_id)

    # Get operation details
    operation = change.operation
    memory_id = change.memory_id
    previous_state = change.previous_state

    restored_ids = []
    deleted_ids = []
    warnings = []

    if operation == "merge":
        # Unmark source memories as duplicate
        source_ids = previous_state.get("source_ids", [])
        for source_id in source_ids:
            mem = session.get(TaskMemory, source_id)
            if mem:
                mem.is_duplicate = False
                mem.duplicate_of = None
                restored_ids.append(source_id)

        # Delete consolidated memory
        consolidated = session.get(TaskMemory, memory_id)
        if consolidated:
            session.delete(consolidated)
            deleted_ids.append(memory_id)

    elif operation == "archive":
        # Unarchive memory
        mem = session.get(TaskMemory, memory_id)
        if mem:
            mem.is_archived = False
            mem.archived_at = None
            mem.archive_reason = None
            restored_ids.append(memory_id)

    # Record rollback
    rollback_change = ConsolidationChange(
        consolidation_job_id=change.consolidation_job_id,
        operation="rollback",
        memory_id=memory_id,
        previous_state={"operation": operation},
        new_state={"restored": True},
        reason=reason,
        changed_by=user_id,
    )
    session.add(rollback_change)

    return RollbackResponse(
        success=True,
        rollback_id=rollback_change.id,
        memories_restored=len(restored_ids),
        memories_deleted=len(deleted_ids),
        warnings=warnings,
    )
```

## Acceptance Criteria

- [ ] Validates consolidation exists
- [ ] Checks 7-day rollback window
- [ ] Checks for conflicting changes
- [ ] Performs rollback based on operation type
- [ ] Records rollback in audit log
- [ ] Returns success/failure with details
- [ ] Error responses for invalid requests
- [ ] Integration tests

## Dependencies

**Depends On**: TSK-015
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
