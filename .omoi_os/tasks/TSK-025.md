---
id: TSK-025
title: Add error handling and retry logic
status: pending
created: 2025-01-08
parent_ticket: TKT-004
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-022, TSK-023]
  blocks: []
---

# TSK-025: Add error handling and retry logic

## Objective

Add proper error handling and retry logic to consolidation tasks.

## Context

Background tasks should handle failures gracefully and retry on transient errors.

## Deliverables

- Error handling and retry configuration for consolidation tasks

## Implementation Notes

```python
from celery import shared_task
from celery.exceptions import Retry

@shared_task(
    name="consolidation.run_project",
    autoretry_for=(ConnectionError, TimeoutError),
    retry_kwargs={'max_retries': 3, 'countdown': 60},
    retry_backoff=True,
    retry_backoff_max=600,
)
def run_project_consolidation(project_id: str, job_id: Optional[str] = None):
    try:
        # ... existing implementation ...

    except Exception as e:
        # Log error
        logger.error(f"Consolidation failed for project {project_id}: {e}")

        # Update job status if job_id provided
        if job_id:
            with get_session() as session:
                job = session.get(ConsolidationJob, job_id)
                if job:
                    job.status = "failed"
                    job.error_message = str(e)
                    job.completed_at = utc_now()
                    session.flush()

        # Re-raise for Celery retry handling
        raise
```

## Acceptance Criteria

- [ ] Retry configured for transient errors (ConnectionError, TimeoutError)
- [ ] Exponential backoff configured
- [ ] Max retries limited (3)
- [ ] Job status updated on failure
- [ ] Error logging added
- [ ] Tests for retry scenarios

## Dependencies

**Depends On**: TSK-022, TSK-023
**Blocks**: None

## Estimate

**Size**: S (< 2 hours)
