---
id: TSK-025
title: Add unsubscribe mechanism
status: pending
parent_ticket: TKT-004
estimate: S
type: implementation
dependencies:
  depends_on:
    - TSK-024
  blocks: []
---

# TSK-025: Add unsubscribe mechanism

## Objective

Add unsubscribe functionality to email notifications for compliance and user control.

## Context

Users should be able to unsubscribe from email notifications via a link in the email.

## Deliverables

- [ ] Unsubscribe token generation and validation
- [ ] API endpoint for unsubscribe

## Implementation Notes

```python
# Generate unsubscribe token
import secrets
from datetime import datetime, timedelta

def generate_unsubscribe_token(user_id: UUID) -> str:
    """Generate unsubscribe token for user."""
    # Could use JWT with expiration
    payload = {
        "user_id": str(user_id),
        "exp": (datetime.utcnow() + timedelta(days=365)).timestamp(),
    }
    return jwt.encode(payload, SECRET, algorithm="HS256")

def validate_unsubscribe_token(token: str) -> Optional[UUID]:
    """Validate unsubscribe token and return user_id."""
    try:
        payload = jwt.decode(token, SECRET, algorithms=["HS256"])
        return UUID(payload["user_id"])
    except JWTError:
        return None

# API endpoint
@router.get("/notifications/unsubscribe")
async def unsubscribe_from_emails(token: str):
    """Unsubscribe user from all email notifications."""
    user_id = validate_unsubscribe_token(token)
    if not user_id:
        raise HTTPException(status_code=400, detail="Invalid token")

    # Disable all email notifications
    # ...

    return {"message": "You have been unsubscribed from email notifications"}
```

## Acceptance Criteria

- [ ] Unsubscribe token generated per user
- [ ] Token embedded in unsubscribe URL
- [ ] Unsubscribe endpoint validates token
- [ ] Unsubscribe disables all email notifications
- [ ] Token has reasonable expiration (1 year)
- [ ] Unsubscribe page confirms action
