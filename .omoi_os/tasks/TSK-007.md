---
id: TSK-007
title: Create ConsolidationTriggerService with APScheduler
status: pending
ticket_id: TKT-002
estimate: M
type: implementation
dependencies:
  depends_on:
    - TSK-001
    - TSK-002
    - TSK-004
  blocks:
    - TSK-009
---

# TSK-007: Create ConsolidationTriggerService with APScheduler

## Objective

Implement the ConsolidationTriggerService that monitors trigger conditions (time-based, threshold-based) and initiates consolidation jobs.

## Context

The trigger service is responsible for deciding when to run consolidation. It supports scheduled triggers (cron), threshold triggers (N new memories), and manual triggers (API).

## Deliverables

- [ ] `backend/omoi_os/services/consolidation/trigger_service.py` - Trigger service implementation
- [ ] `backend/omoi_os/config.py` - Add consolidation configuration

## Implementation Notes

```python
# backend/omoi_os/services/consolidation/trigger_service.py
from typing import Optional, Dict, Any
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from sqlalchemy.orm import Session

from omoi_os.models.consolidation_job import ConsolidationJob, JobStatus, TriggerType
from omoi_os.services.task_queue import TaskQueueService


class ConsolidationTriggerService:
    """
    Service for monitoring consolidation triggers and initiating jobs.

    Supports:
    - Time-based triggers (cron schedule)
    - Threshold triggers (N new memories)
    - Manual triggers (API)
    """

    def __init__(self, db: Session):
        self.db = db
        self.scheduler = AsyncIOScheduler()
        self.task_queue = TaskQueueService(db)

    def start(self) -> None:
        """Start the trigger service scheduler."""
        # Add scheduled job
        from omoi_os.config import get_app_settings

        settings = get_app_settings()
        schedule = getattr(settings, "consolidation_schedule", "0 2 * * *")

        self.scheduler.add_job(
            self._run_scheduled_consolidation,
            CronTrigger.from_crontab(schedule),
            id="scheduled_consolidation",
            replace_existing=True
        )

        self.scheduler.start()

    def stop(self) -> None:
        """Stop the trigger service scheduler."""
        self.scheduler.shutdown()

    async def _run_scheduled_consolidation(self) -> None:
        """Run consolidation for all active projects."""
        # Get all active projects
        from omoi_os.models.project import Project

        projects = self.db.query(Project).filter(Project.is_active == True).all()

        for project in projects:
            await self.trigger_consolidation(
                project_id=str(project.id),
                trigger_type=TriggerType.SCHEDULED
            )

    async def trigger_consolidation(
        self,
        project_id: str,
        trigger_type: TriggerType,
        scope: Optional[Dict[str, Any]] = None,
        triggered_by: Optional[str] = None
    ) -> str:
        """
        Trigger a consolidation job.

        Returns:
            Job ID
        """
        job = ConsolidationJob(
            project_id=project_id,
            trigger_type=trigger_type.value,
            scope=scope or {},
            status=JobStatus.PENDING,
            triggered_by=triggered_by or "system"
        )

        self.db.add(job)
        self.db.flush()

        # Enqueue in task queue
        self.task_queue.enqueue(
            task_type="consolidation",
            task_id=str(job.id),
            payload={"job_id": str(job.id)}
        )

        return str(job.id)

    async def check_threshold_triggers(self, project_id: str) -> None:
        """
        Check if threshold-based consolidation should trigger.

        Called when new memories are created.
        """
        from omoi_os.config import get_app_settings

        settings = get_app_settings()
        threshold = getattr(settings, "consolidation_threshold", 100)

        # Count unconsolidated memories
        from omoi_os.models.task_memory import TaskMemory

        count = self.db.query(TaskMemory).filter(
            TaskMemory.project_id == project_id,
            TaskMemory.is_consolidated == False
        ).count()

        if count >= threshold:
            await self.trigger_consolidation(
                project_id=project_id,
                trigger_type=TriggerType.THRESHOLD,
                scope={"unconsolidated_only": True}
            )
```

Add to config:
```python
# backend/omoi_os/config.py
class AppSettings(BaseSettings):
    # ... existing settings ...

    # Consolidation settings
    consolidation_schedule: str = Field(
        default="0 2 * * *",
        description="Cron schedule for consolidation (default: daily at 2 AM)"
    )
    consolidation_threshold: int = Field(
        default=100,
        ge=10,
        le=1000,
        description="Number of unconsolidated memories to trigger consolidation"
    )
    consolidation_timeout: int = Field(
        default=600,
        ge=60,
        le=3600,
        description="Max seconds per consolidation job"
    )
```

## Acceptance Criteria

- [ ] ConsolidationTriggerService implemented with APScheduler
- [ ] Scheduled trigger uses configurable cron schedule
- [ ] Threshold trigger checks unconsolidated memory count
- [ ] Manual trigger accepts optional scope parameter
- [ ] Jobs enqueued in TaskQueueService
- [ ] Service can be started and stopped cleanly
- [ ] Configuration added to AppSettings
- [ ] All tests pass

## Dependencies

**Depends On**: TSK-001, TSK-002, TSK-004 (Models and migration must exist)
**Blocks**: TSK-009 (Worker uses trigger service)

## Verification

```bash
# Test scheduler starts
cd backend
python -c "
from omoi_os.services.consolidation.trigger_service import ConsolidationTriggerService
from omoi_os.services.database import DatabaseService

db = DatabaseService()
trigger_svc = ConsolidationTriggerService(db.get_session())
trigger_svc.start()
print('Scheduler started')
trigger_svc.stop()
print('Scheduler stopped')
"
```
