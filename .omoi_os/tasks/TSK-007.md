---
id: TSK-007
title: Integrate with EventBusService for event subscription
status: pending
ticket_id: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on:
    - TSK-003
  blocks: []
---

# TSK-007: Integrate with EventBusService for event subscription

## Objective

Subscribe to EventBus events (ticket_updated, task_completed, etc.) and trigger notifications when events occur.

## Context

The EventBusService publishes events for various system actions. The notification system needs to subscribe to relevant events and create notifications.

## Deliverables

- [ ] `omoi_os/services/notification_event_subscriber.py` - NotificationEventSubscriber class

## Implementation Notes

```python
# omoi_os/services/notification_event_subscriber.py

from uuid import UUID
from typing import Dict, Any

from omoi_os.services.event_bus import EventBusService
from omoi_os.services.notification_service import NotificationService


class NotificationEventSubscriber:
    """Subscribes to EventBus events and creates notifications."""

    def __init__(
        self,
        event_bus: EventBusService,
        notification_service: NotificationService,
    ):
        self.event_bus = event_bus
        self.notification_service = notification_service

    async def subscribe(self):
        """Subscribe to all relevant events."""
        await self.event_bus.subscribe("ticket_created", self._on_ticket_created)
        await self.event_bus.subscribe("ticket_updated", self._on_ticket_updated)
        await self.event_bus.subscribe("ticket_assigned", self._on_ticket_assigned)
        await self.event_bus.subscribe("task_completed", self._on_task_completed)
        await self.event_bus.subscribe("task_failed", self._on_task_failed)
        await self.event_bus.subscribe("approval_requested", self._on_approval_requested)
        await self.event_bus.subscribe("agent_status_changed", self._on_agent_status_changed)

    async def _on_ticket_assigned(self, event: Dict[str, Any]):
        """Handle ticket assignment event."""
        assignee_id = event.data.get("assignee_id")
        if not assignee_id:
            return

        await self.notification_service.create_notification(
            user_id=UUID(assignee_id),
            type="ticket_assigned",
            title="Ticket assigned to you",
            message=f"{event.data.get('assigner_name')} assigned '{event.data.get('ticket_title')}' to you",
            data={
                "ticket_id": str(event.data.get("ticket_id")),
                "project_id": str(event.data.get("project_id")),
                "assigner_name": event.data.get("assigner_name"),
            },
        )

    async def _on_task_completed(self, event: Dict[str, Any]):
        """Handle task completion event."""
        user_id = event.data.get("submitter_id")
        if not user_id:
            return

        await self.notification_service.create_notification(
            user_id=UUID(user_id),
            type="task_completed",
            title="Task completed successfully",
            message=f"Your task '{event.data.get('task_title')}' completed",
            data={
                "task_id": str(event.data.get("task_id")),
                "ticket_id": str(event.data.get("ticket_id")),
            },
        )

    async def _on_task_failed(self, event: Dict[str, Any]):
        """Handle task failure event."""
        user_id = event.data.get("submitter_id")
        if not user_id:
            return

        await self.notification_service.create_notification(
            user_id=UUID(user_id),
            type="task_failed",
            title="Task failed",
            message=f"Your task '{event.data.get('task_title')}' failed: {event.data.get('error_message')}",
            data={
                "task_id": str(event.data.get("task_id")),
                "ticket_id": str(event.data.get("ticket_id")),
                "error_message": event.data.get("error_message"),
            },
        )

    # Additional event handlers...
```

## Acceptance Criteria

- [ ] NotificationEventSubscriber subscribes to all relevant events
- [ ] Creates notifications for ticket_assigned events
- [ ] Creates notifications for task_completed events
- [ ] Creates notifications for task_failed events
- [ ] Creates notifications for approval_requested events
- [ ] Creates notifications for agent_status_changed events
- [ ] Uses event data to populate notification message and data fields
- [ ] Handles missing data gracefully
