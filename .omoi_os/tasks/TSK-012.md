---
id: TSK-012
title: Add audit logging for all operations
status: pending
ticket_id: TKT-002
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-011]
  blocks: []
---

# TSK-012: Add audit logging for all operations

## Objective

Ensure all consolidation operations create proper audit records in the consolidation_changes table.

## Context

Consolidation operations must be fully auditable for compliance and rollback support. Each operation should record before/after state.

## Deliverables

- Audit logging integrated into all consolidation operations

## Implementation Notes

The audit logging should be integrated into:
- MemoryMerger: Record merge operation with source IDs
- MemorySynthesizer: Record summarize operation with cluster
- MemoryArchiver: Record archive operation with reason
- PlaybookPromoter: Record promote operation with entry ID
- ConsolidationService: Record rollback operations

Each audit record should include:
- consolidation_job_id
- operation (merge, archive, promote, summarize, rollback)
- memory_id
- previous_state (JSONB)
- new_state (JSONB)
- reason
- confidence
- changed_at
- changed_by

## Acceptance Criteria

- [ ] All merge operations logged with source memory IDs
- [ ] All summarize operations logged with cluster info
- [ ] All archive operations logged with reason
- [ ] All promote operations logged with playbook entry ID
- [ ] Rollback operations logged
- [ ] previous_state captures state before change
- [ ] new_state captures state after change
- [ ] changed_by set to "system" or user_id
- [ ] Unit tests for audit logging

## Dependencies

**Depends On**: TSK-011
**Blocks**: None

## Estimate

**Size**: S (< 2 hours)
