---
id: TSK-017
title: Create NotificationPreferenceService
status: pending
parent_ticket: TKT-003
estimate: M
type: implementation
dependencies:
  depends_on:
    - TSK-001
  blocks:
    - TSK-018
    - TSK-019
---

# TSK-017: Create NotificationPreferenceService

## Objective

Create a service for managing user and organization notification preferences.

## Context

Notification preferences control which notification types users receive and through which channels.

## Deliverables

- [ ] `omoi_os/services/notification_preference_service.py` - NotificationPreferenceService class

## Implementation Notes

```python
# omoi_os/services/notification_preference_service.py

from uuid import UUID
from typing import Dict, Optional

from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from omoi_os.models.notification import NotificationPreference, OrganizationNotificationPreference
from omoi_os.models.user import User
from omoi_os.schemas.notification import NotificationPreferences


DEFAULT_PREFERENCES = {
    "in_app": {
        "ticket_assigned": True,
        "ticket_updated": True,
        "task_completed": True,
        "task_failed": True,
        "approval_requested": True,
        "agent_status_changed": True,
        "system_alert": True,
        "mention": True,
    },
    "email": {
        "ticket_assigned": False,
        "ticket_updated": False,
        "task_completed": False,
        "task_failed": False,
        "approval_requested": False,
        "agent_status_changed": False,
        "system_alert": False,
        "mention": False,
    },
}


class NotificationPreferenceService:
    """Service for managing notification preferences."""

    def __init__(self, db: AsyncSession):
        self.db = db

    async def get_user_preferences(self, user_id: UUID) -> NotificationPreferences:
        """Get user preferences with defaults."""
        stmt = select(NotificationPreference).where(
            NotificationPreference.user_id == user_id
        )
        result = await self.db.execute(stmt)
        pref = result.scalar_one_or_none()

        if pref:
            return NotificationPreferences(**pref.preferences)

        # Check for organization defaults
        # (would need to fetch user's organization_id)
        return NotificationPreferences(**DEFAULT_PREFERENCES)

    async def update_user_preferences(
        self, user_id: UUID, preferences: NotificationPreferences
    ) -> NotificationPreference:
        """Update user preferences."""
        stmt = select(NotificationPreference).where(
            NotificationPreference.user_id == user_id
        )
        result = await self.db.execute(stmt)
        pref = result.scalar_one_or_none()

        data = preferences.model_dump()

        if pref:
            pref.preferences = data
        else:
            pref = NotificationPreference(user_id=user_id, preferences=data)
            self.db.add(pref)

        await self.db.commit()
        await self.db.refresh(pref)

        return pref

    async def get_organization_preferences(self, organization_id: UUID) -> NotificationPreferences:
        """Get organization default preferences."""
        stmt = select(OrganizationNotificationPreference).where(
            OrganizationNotificationPreference.organization_id == organization_id
        )
        result = await self.db.execute(stmt)
        pref = result.scalar_one_or_none()

        if pref:
            return NotificationPreferences(**pref.preferences)

        return NotificationPreferences(**DEFAULT_PREFERENCES)

    async def update_organization_preferences(
        self, organization_id: UUID, preferences: NotificationPreferences
    ) -> OrganizationNotificationPreference:
        """Update organization default preferences."""
        stmt = select(OrganizationNotificationPreference).where(
            OrganizationNotificationPreference.organization_id == organization_id
        )
        result = await self.db.execute(stmt)
        pref = result.scalar_one_or_none()

        data = preferences.model_dump()

        if pref:
            pref.preferences = data
        else:
            pref = OrganizationNotificationPreference(
                organization_id=organization_id, preferences=data
            )
            self.db.add(pref)

        await self.db.commit()
        await self.db.refresh(pref)

        return pref
```

## Acceptance Criteria

- [ ] NotificationPreferenceService with get/update methods
- [ ] Default preferences defined
- [ ] User preferences override defaults
- [ ] Organization preferences provided for new members
- [ ] Preferences validated against allowed types
