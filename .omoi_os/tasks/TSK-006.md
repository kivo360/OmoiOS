---
id: TSK-006
title: Write tests for supervisor core service
status: pending
parent_ticket: TKT-001
estimate: M
type: test
dependencies:
  depends_on: [TSK-001, TSK-002, TSK-003, TSK-004, TSK-005]
  blocks: []
---

# TSK-006: Write tests for supervisor core service

## Objective

Write comprehensive tests for the supervisor core service including unit tests for individual components and integration tests for API endpoints.

## Context

This task ensures the supervisor core functionality is properly tested with good coverage of unit and integration tests.

## Deliverables

- [ ] `backend/tests/unit/services/test_supervisor_agent.py` - Unit tests
- [ ] `backend/tests/unit/services/test_team_manager.py` - Unit tests
- [ ] `backend/tests/unit/services/test_supervisor_health.py` - Unit tests
- [ ] `backend/tests/api/test_supervisors_routes.py` - API integration tests

## Implementation Notes

```python
# backend/tests/unit/services/test_supervisor_agent.py

"""Test SupervisorAgent service.

Tests Requirements: REQ-SUPERVISOR-FUNC-001, REQ-SUPERVISOR-FUNC-009
"""

import pytest
from uuid import uuid4
from unittest.mock import Mock, patch

from omoi_os.services.supervisor_agent import SupervisorAgent
from omoi_os.models.supervisor import SupervisorStatus


@pytest.fixture
def mock_db():
    """Mock database service."""
    return Mock()


@pytest.fixture
def mock_event_bus():
    """Mock event bus."""
    return Mock()


@pytest.fixture
def supervisor_id():
    """Test supervisor ID."""
    return uuid4()


@pytest.fixture
def supervisor_agent(mock_db, mock_event_bus, supervisor_id):
    """Create supervisor agent for testing."""
    return SupervisorAgent(
        supervisor_id=supervisor_id,
        db=mock_db,
        event_bus=mock_event_bus,
    )


class TestSupervisorAgent:
    """Test suite for SupervisorAgent."""

    @pytest.mark.asyncio
    async def test_start_updates_status_and_publishes_event(
        self, supervisor_agent, mock_db, mock_event_bus
    ):
        """Test starting supervisor updates status and publishes event."""
        # Act
        await supervisor_agent.start()

        # Assert
        assert supervisor_agent.running is True
        assert supervisor_agent.status == SupervisorStatus.ACTIVE
        mock_event_bus.publish.assert_called_once()

    @pytest.mark.asyncio
    async def test_stop_stops_background_tasks(
        self, supervisor_agent
    ):
        """Test stopping supervisor cancels background tasks."""
        # Arrange
        await supervisor_agent.start()

        # Act
        await supervisor_agent.stop()

        # Assert
        assert supervisor_agent.running is False
        assert supervisor_agent.status == SupervisorStatus.TERMINATED

    @pytest.mark.asyncio
    async def test_pause_sets_paused_status(
        self, supervisor_agent
    ):
        """Test pause sets status to PAUSED."""
        # Arrange
        await supervisor_agent.start()

        # Act
        await supervisor_agent.pause()

        # Assert
        assert supervisor_agent.status == SupervisorStatus.PAUSED

    @pytest.mark.asyncio
    async def test_resume_restores_active_status(
        self, supervisor_agent
    ):
        """Test resume restores ACTIVE status."""
        # Arrange
        await supervisor_agent.start()
        await supervisor_agent.pause()

        # Act
        await supervisor_agent.resume()

        # Assert
        assert supervisor_agent.status == SupervisorStatus.ACTIVE
```

## Test Coverage Requirements

- [ ] SupervisorAgent lifecycle (start, stop, pause, resume)
- [ ] TeamManager CRUD operations
- [ ] Health monitoring heartbeat detection
- [ ] API endpoints (create, list, get, pause, resume, health, teams)
- [ ] Error handling for invalid operations
- [ ] Database transaction rollback on errors
- [ ] Event publishing for all state changes

## Acceptance Criteria

- [ ] Unit tests achieve >80% code coverage
- [ ] All test files follow naming convention
- [ ] Tests use fixtures for common setup
- [ ] Integration tests use test database
- [ ] All tests pass with pytest
- [ ] No test interdependencies

## Dependencies

**Depends On**: All implementation tasks for TKT-001
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
