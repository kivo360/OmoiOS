---
id: TSK-006
title: Write tests for models and migrations
status: pending
ticket_id: TKT-001
estimate: M
type: test
dependencies:
  depends_on:
    - TSK-001
    - TSK-002
    - TSK-003
    - TSK-004
  blocks: []
---

# TSK-006: Write tests for models and migrations

## Objective

Ensure the consolidation models work correctly and the migration can be applied and rolled back without errors.

## Context

Testing database models and migrations is critical for data integrity and system reliability.

## Deliverables

- [ ] `backend/tests/test_consolidation_models.py` - Model tests
- [ ] `backend/tests/test_consolidation_migration.py` - Migration tests

## Implementation Notes

```python
# backend/tests/test_consolidation_models.py
import pytest
from sqlalchemy.orm import Session

from omoi_os.models.consolidated_memory import ConsolidatedMemory, AbstractionLevel, PatternType
from omoi_os.models.consolidation_job import ConsolidationJob, JobStatus, TriggerType
from omoi_os.models.task_memory import TaskMemory


class TestConsolidatedMemory:
    """Test ConsolidatedMemory model."""

    def test_create_consolidated_memory(self, db: Session):
        """Test creating a consolidated memory."""
        memory = ConsolidatedMemory(
            project_id="test-project",
            content="Test pattern",
            memory_type="discovery",
            abstraction_level=2,
            pattern_type=PatternType.SUCCESS,
            confidence_score=0.85,
            source_memory_ids=["mem-1", "mem-2"],
            source_count=2,
            consolidation_method="llm"
        )
        db.add(memory)
        db.flush()

        assert memory.id is not None
        assert memory.abstraction_level == 2
        assert memory.pattern_type == "success"

    def test_consolidated_memory_to_dict(self, db: Session):
        """Test to_dict() method."""
        memory = ConsolidatedMemory(
            project_id="test-project",
            content="Test pattern",
            memory_type="discovery",
            abstraction_level=2,
            source_memory_ids=["mem-1"],
            source_count=1
        )
        db.add(memory)
        db.flush()

        result = memory.to_dict()
        assert result["project_id"] == "test-project"
        assert result["abstraction_level"] == 2
        assert "created_at" in result


class TestConsolidationJob:
    """Test ConsolidationJob model."""

    def test_create_consolidation_job(self, db: Session):
        """Test creating a consolidation job."""
        job = ConsolidationJob(
            project_id="test-project",
            status=JobStatus.PENDING,
            trigger_type=TriggerType.MANUAL,
            triggered_by="user-123"
        )
        db.add(job)
        db.flush()

        assert job.id is not None
        assert job.status == "pending"
        assert job.trigger_type == "manual"

    def test_job_status_transitions(self, db: Session):
        """Test job status can be updated."""
        job = ConsolidationJob(
            project_id="test-project",
            status=JobStatus.PENDING,
            trigger_type=TriggerType.SCHEDULED
        )
        db.add(job)
        db.flush()

        job.status = JobStatus.RUNNING
        job.started_at = datetime.now(timezone.utc)
        db.flush()

        assert job.status == "running"


class TestTaskMemoryConsolidationFields:
    """Test TaskMemory consolidation enhancements."""

    def test_consolidation_fields_default(self, db: Session):
        """Test new consolidation fields have correct defaults."""
        memory = TaskMemory(
            task_id="task-1",
            execution_summary="Test summary",
            success=True
        )
        db.add(memory)
        db.flush()

        assert memory.is_consolidated is False
        assert memory.consolidated_into_id is None

    def test_mark_as_consolidated(self, db: Session):
        """Test marking a memory as consolidated."""
        memory = TaskMemory(
            task_id="task-1",
            execution_summary="Test summary",
            success=True
        )
        consolidated = ConsolidatedMemory(
            project_id="test-project",
            content="Merged",
            memory_type="discovery",
            abstraction_level=1,
            source_memory_ids=[memory.id],
            source_count=1
        )
        db.add_all([memory, consolidated])
        db.flush()

        memory.is_consolidated = True
        memory.consolidated_into_id = consolidated.id
        db.flush()

        assert memory.is_consolidated is True
        assert memory.consolidated_into_id == consolidated.id
```

```python
# backend/tests/test_consolidation_migration.py
import pytest
from alembic import command
from alembic.config import Config


class TestConsolidationMigration:
    """Test consolidation schema migration."""

    def test_upgrade_migration(self, alembic_config: Config):
        """Test migration can be upgraded."""
        command.upgrade(alembic_config, "consolidation_001")
        # Should not raise

    def test_downgrade_migration(self, alembic_config: Config):
        """Test migration can be downgraded."""
        command.upgrade(alembic_config, "consolidation_001")
        command.downgrade(alembic_config, "-1")
        # Should not raise

    def test_tables_created(self, db_session, alembic_config: Config):
        """Test all tables are created."""
        command.upgrade(alembic_config, "consolidation_001")

        # Check tables exist
        inspector = inspect(db_session.bind)
        tables = inspector.get_table_names()

        assert "consolidated_memories" in tables
        assert "consolidation_jobs" in tables

    def test_indexes_created(self, db_session, alembic_config: Config):
        """Test all indexes are created."""
        command.upgrade(alembic_config, "consolidation_001")

        inspector = inspect(db_session.bind)
        indexes = inspector.get_indexes("consolidated_memories")

        index_names = [idx["name"] for idx in indexes]
        assert "idx_cm_project" in index_names
        assert "idx_cm_abstraction" in index_names
```

## Acceptance Criteria

- [ ] ConsolidatedMemory model tests pass
- [ ] ConsolidationJob model tests pass
- [ ] TaskMemory consolidation field tests pass
- [ ] Migration upgrade tests pass
- [ ] Migration downgrade tests pass
- [ ] Table and index verification tests pass
- [ ] All tests can run with `pytest tests/test_consolidation_*.py`

## Dependencies

**Depends On**: TSK-001, TSK-002, TSK-003, TSK-004 (Models and migration must exist)
**Blocks**: None

## Verification

```bash
cd backend
pytest tests/test_consolidation_models.py -v
pytest tests/test_consolidation_migration.py -v
```
