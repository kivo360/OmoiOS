---
id: TSK-006
title: Implement SimilarityDetector for clustering
status: pending
created: 2025-01-08
parent_ticket: TKT-002
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-002, TSK-003]
  blocks: [TSK-007]
---

# TSK-006: Implement SimilarityDetector for clustering

## Objective

Implement the similarity detection algorithm that clusters memories based on embedding cosine similarity using pgvector.

## Context

The consolidation system needs to identify groups of similar memories that should be merged. This component uses vector similarity to find clusters above a threshold.

## Deliverables

- `backend/omoi_os/services/consolidation/similarity_detector.py` - SimilarityDetector class

## Implementation Notes

```python
# omoi_os/services/consolidation/similarity_detector.py
from typing import List, Optional
from sqlalchemy.orm import Session
from sqlalchemy import select, func
from dataclasses import dataclass

from omoi_os.models.task_memory import TaskMemory
from omoi_os.services.embedding import EmbeddingService

@dataclass
class MemoryCluster:
    memory_ids: List[str]
    cluster_id: str
    similarity_score: float
    representative_id: str

class SimilarityDetector:
    def __init__(self, embedding_service: EmbeddingService):
        self.embedding_service = embedding_service

    async def detect_clusters(
        self,
        session: Session,
        project_id: str,
        threshold: float = 0.90,
        min_cluster_size: int = 2,
    ) -> List[MemoryCluster]:
        """
        Detect clusters of similar memories.

        Algorithm:
        1. Get all active memories with embeddings
        2. Compute pairwise similarity matrix
        3. Find connected components above threshold
        4. Filter by min_cluster_size
        """
        memories = session.execute(
            select(TaskMemory)
            .where(TaskMemory.project_id == project_id)
            .where(TaskMemory.is_duplicate == False)
            .where(TaskMemory.is_archived == False)
            .where(TaskMemory.context_embedding.isnot(None))
        ).scalars().all()

        # Build similarity graph and find connected components
        clusters = self._find_connected_components(memories, threshold)

        # Filter by size
        return [c for c in clusters if len(c.memory_ids) >= min_cluster_size]

    def _find_connected_components(
        self,
        memories: List[TaskMemory],
        threshold: float,
    ) -> List[MemoryCluster]:
        """Find connected components in similarity graph."""
        # Union-find or BFS-based clustering
        # Returns list of clusters
        pass
```

## Acceptance Criteria

- [ ] SimilarityDetector class with detect_clusters() method
- [ ] Uses pgvector for cosine similarity calculation
- [ ] Implements connected components clustering
- [ ] Filters by min_cluster_size
- [ ] Returns MemoryCluster objects with metadata
- [ ] Excludes duplicate and archived memories
- [ ] Unit tests with mock data

## Dependencies

**Depends On**: TSK-002 (Models), TSK-003 (TaskMemory extension)
**Blocks**: TSK-007 (MemoryMerger)

## Estimate

**Size**: M (2-4 hours)
