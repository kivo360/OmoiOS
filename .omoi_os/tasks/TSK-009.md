---
id: TSK-009
title: Write integration tests for notification flow
status: pending
ticket_id: TKT-001
estimate: M
type: test
dependencies:
  depends_on:
    - TSK-003
    - TSK-007
  blocks: []
---

# TSK-009: Write integration tests for notification flow

## Objective

Write integration tests that verify the end-to-end notification flow from event to delivery.

## Context

Integration tests ensure the notification system works with the database, event bus, and WebSocket infrastructure.

## Deliverables

- [ ] `backend/tests/integration/test_notification_flow.py` - Integration tests

## Implementation Notes

```python
# backend/tests/integration/test_notification_flow.py

import pytest
from uuid import uuid4

from omoi_os.services.notification_service import NotificationService
from omoi_os.services.notification_event_subscriber import NotificationEventSubscriber
from omoi_os.services.event_bus import EventBusService


@pytest.mark.asyncio
class TestNotificationFlow:
    async def test_ticket_assignment_creates_notification(self, db_service, event_bus):
        """Test that ticket assignment event creates notification."""
        # Setup
        notification_service = NotificationService(db_service)
        subscriber = NotificationEventSubscriber(event_bus, notification_service)
        await subscriber.subscribe()

        assignee_id = uuid4()

        # Publish event
        await event_bus.publish("ticket_assigned", {
            "ticket_id": str(uuid4()),
            "assignee_id": str(assignee_id),
            "assigner_name": "John Doe",
            "ticket_title": "Fix bug",
        })

        # Verify notification created
        notifications = await notification_service.get_notifications(assignee_id)
        assert len(notifications) == 1
        assert notifications[0].type == "ticket_assigned"

    async def test_notification_websocket_delivery(self, db_service, ws_manager, event_bus):
        """Test that notifications are delivered via WebSocket."""
        # Setup
        notification_service = NotificationService(db_service, ws_manager=ws_manager)
        user_id = uuid4()

        # Create notification
        await notification_service.create_notification(
            user_id=user_id,
            type="test",
            title="Test",
            message="Test message",
            data={},
        )

        # Verify WebSocket called
        # (mock ws_manager should have been called with broadcast_to_user)

    async def test_aggregation_flow(self, db_service):
        """Test that similar notifications are aggregated."""
        # Setup
        notification_service = NotificationService(db_service)
        user_id = uuid4()

        # Create multiple similar notifications
        for i in range(5):
            await notification_service.create_notification(
                user_id=user_id,
                type="ticket_assigned",
                title=f"Ticket {i}",
                message=f"Message {i}",
                data={"assigner_id": str(uuid4())},
            )

        # Verify aggregation
        notifications = await notification_service.get_notifications(user_id)
        # Should have 1 aggregated notification
```

## Acceptance Criteria

- [ ] Test for ticket assignment event flow
- [ ] Test for WebSocket delivery verification
- [ ] Test for notification aggregation
- [ ] Test for rate limiting in real context
- [ ] Test for preference application
- [ ] Tests use real database (test DB)
- [ ] Tests clean up data after completion
