---
id: TSK-009
title: Implement MemoryArchiver for stale memories
status: pending
created: 2025-01-08
parent_ticket: TKT-002
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-002, TSK-003]
  blocks: []
---

# TSK-009: Implement MemoryArchiver for stale memories

## Objective

Implement the memory archiver that archives stale and rarely-used memories.

## Context

Old memories that haven't been reused should be archived to maintain search performance and reduce noise.

## Deliverables

- `backend/omoi_os/services/consolidation/memory_archiver.py` - MemoryArchiver class

## Implementation Notes

```python
# omoi_os/services/consolidation/memory_archiver.py
from typing import List
from sqlalchemy.orm import Session
from sqlalchemy import select
from datetime import timedelta

from omoi_os.models.task_memory import TaskMemory
from omoi_os.utils.datetime import utc_now

class MemoryArchiver:
    async def archive_stale_memories(
        self,
        session: Session,
        project_id: str,
        stale_days: int = 90,
        min_reuse: int = 3,
    ) -> List[str]:
        """
        Archive stale and rarely-used memories.

        Criteria:
        - Not reused in stale_days
        - Total reuse_count < min_reuse
        - Not already archived or duplicate

        Returns list of archived memory IDs.
        """
        cutoff_date = utc_now() - timedelta(days=stale_days)

        stale_memories = session.execute(
            select(TaskMemory)
            .where(TaskMemory.project_id == project_id)
            .where(TaskMemory.is_duplicate == False)
            .where(TaskMemory.is_archived == False)
            .where(TaskMemory.reused_count < min_reuse)
            .where(TaskMemory.learned_at < cutoff_date)
        ).scalars().all()

        archived_ids = []
        for mem in stale_memories:
            mem.is_archived = True
            mem.archived_at = utc_now()
            mem.archive_reason = "staleness"
            archived_ids.append(str(mem.id))

        return archived_ids
```

## Acceptance Criteria

- [ ] MemoryArchiver class with archive_stale_memories() method
- [ ] Filters by stale_days threshold
- [ ] Filters by reuse_count threshold
- [ ] Sets is_archived=True
- [ ] Sets archived_at timestamp
- [ ] Sets archive_reason
- [ ] Returns list of archived IDs
- [ ] Unit tests for various thresholds

## Dependencies

**Depends On**: TSK-002, TSK-003
**Blocks**: None

## Estimate

**Size**: S (< 2 hours)
