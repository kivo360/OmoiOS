---
id: TSK-001
title: Create database migration for consolidation tables
status: pending
created: 2025-01-08
parent_ticket: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on: []
  blocks: [TSK-002, TSK-003]
---

# TSK-001: Create database migration for consolidation tables

## Objective

Create an Alembic migration that adds the `consolidation_jobs` and `consolidation_changes` tables, and extends `task_memories` with consolidation-related columns.

## Context

The consolidation system requires new database tables to track jobs and audit changes, plus extensions to the existing task_memories table. This migration provides the foundation for all consolidation features.

## Deliverables

- `backend/migrations/versions/xxx_consolidation_tables.py` - Alembic migration file

## Implementation Notes

Migration steps:
1. Create `consolidation_jobs` table with all columns from design
2. Create `consolidation_changes` table with foreign keys
3. Add columns to `task_memories`: consolidated_from, consolidated_at, synthesized_from, synthesized_at, synthesis_confidence, is_archived, archived_at, archive_reason
4. Create indexes for consolidation queries
5. Add check constraints for enums

```python
# Migration structure example
def upgrade():
    # Create consolidation_jobs
    op.create_table(
        'consolidation_jobs',
        sa.Column('id', postgresql.UUID(as_uuid=True), primary_key=True),
        sa.Column('project_id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('status', sa.String(20), nullable=False),
        sa.Column('trigger_type', sa.String(20), nullable=False),
        sa.Column('options', postgresql.JSONB, nullable=False, server_default='{}'),
        # ... more columns
    )

    # Create consolidation_changes
    op.create_table(
        'consolidation_changes',
        # ... columns
    )

    # Add columns to task_memories
    op.add_column('task_memories', sa.Column('consolidated_from', postgresql.ARRAY(postgresql.UUID())))
    # ... more columns

    # Create indexes
    op.create_index('idx_consolidation_jobs_project', 'consolidation_jobs', ['project_id', 'created_at'])
    # ... more indexes
```

## Acceptance Criteria

- [ ] Migration file created with revision number
- [ ] `upgrade()` function creates all tables and columns
- [ ] `downgrade()` function reverses all changes
- [ ] Migration applies cleanly to fresh database
- [ ] Migration rollback succeeds
- [ ] All foreign keys properly defined
- [ ] All indexes created
- [ ] Check constraints added for status enums

## Dependencies

**Depends On**: None
**Blocks**: TSK-002, TSK-003

## Estimate

**Size**: M (2-4 hours)
