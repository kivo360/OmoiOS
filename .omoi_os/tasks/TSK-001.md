---
id: TSK-001
title: Create Notification and NotificationPreference models
status: pending
ticket_id: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on: []
  blocks:
    - TSK-002
    - TSK-003
---

# TSK-001: Create Notification and NotificationPreference models

## Objective

Create SQLAlchemy models for notifications and preferences in `omoi_os/models/` directory.

## Context

The notification system requires database models to store notifications, user preferences, and organization defaults. These models will be used by the NotificationService and API endpoints.

## Deliverables

- [ ] `omoi_os/models/notification.py` - Notification, NotificationPreference, OrganizationNotificationPreference models
- [ ] Update `omoi_os/models/__init__.py` to export new models

## Implementation Notes

```python
# omoi_os/models/notification.py

from datetime import datetime
from typing import Optional
from uuid import UUID, uuid4

from sqlalchemy import Boolean, DateTime, String, Text
from sqlalchemy.dialects.postgresql import JSONB, UUID as PGUUID
from sqlalchemy.orm import Mapped, mapped_column

from omoi_os.models.base import Base
from omoi_os.utils.datetime import utc_now


class Notification(Base):
    """User notification."""

    __tablename__ = "notifications"

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    user_id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), nullable=False, index=True)
    type: Mapped[str] = mapped_column(String(50), nullable=False, index=True)
    title: Mapped[str] = mapped_column(String(255), nullable=False)
    message: Mapped[str] = mapped_column(Text, nullable=False)
    data: Mapped[dict] = mapped_column(JSONB, nullable=False, default={})

    # Status
    status: Mapped[str] = mapped_column(String(20), nullable=False, default="unread")
    read_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)

    # Delivery tracking
    delivered_via_ws: Mapped[bool] = mapped_column(Boolean, default=False)
    delivered_via_email: Mapped[bool] = mapped_column(Boolean, default=False)
    aggregation_id: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), nullable=True)

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, default=utc_now
    )
    deleted_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)


class NotificationPreference(Base):
    """User notification preferences."""

    __tablename__ = "notification_preferences"

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    user_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True), nullable=False, unique=True, index=True
    )
    organization_id: Mapped[Optional[UUID]] = mapped_column(PGUUID(as_uuid=True), nullable=True)
    preferences: Mapped[dict] = mapped_column(JSONB, nullable=False, default={})

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, default=utc_now
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, default=utc_now, onupdate=utc_now
    )


class OrganizationNotificationPreference(Base):
    """Organization default notification preferences."""

    __tablename__ = "organization_notification_preferences"

    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    organization_id: Mapped[UUID] = mapped_column(
        PGUUID(as_uuid=True), nullable=False, unique=True, index=True
    )
    preferences: Mapped[dict] = mapped_column(JSONB, nullable=False, default={})

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, default=utc_now
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, default=utc_now, onupdate=utc_now
    )
```

## Acceptance Criteria

- [ ] All three models created with correct fields
- [ ] Models follow existing OmoiOS patterns (Base class, Mapped types)
- [ ] JSONB fields for flexible data storage
- [ ] Indexes on user_id, type, created_at for query performance
- [ ] Models exported from __init__.py
