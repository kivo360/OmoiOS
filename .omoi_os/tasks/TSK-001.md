---
id: TSK-001
title: Create supervisor database models and migration
status: pending
parent_ticket: TKT-001
estimate: M
type: implementation
dependencies:
  depends_on: []
  blocks: [TSK-002, TSK-003]
---

# TSK-001: Create supervisor database models and migration

## Objective

Create SQLAlchemy models for all supervisor-related tables and generate the corresponding Alembic migration.

## Context

This task creates the foundational database schema for the Supervisor Agent feature. All subsequent tasks depend on having these models and migration in place.

## Deliverables

- [ ] `backend/omoi_os/models/supervisor.py` - SQLAlchemy models for Supervisor, Team, TeamMember
- [ ] `backend/migrations/versions/XXX_supervisor_initial_tables.py` - Alembic migration

## Implementation Notes

```python
# backend/omoi_os/models/supervisor.py

from sqlalchemy import Column, String, Text, Boolean, Integer, Float, ForeignKey, JSONB
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
from datetime import datetime

from omoi_os.models.base import Base
import uuid


class SupervisorStatus:
    SPAWNING = "SPAWNING"
    ACTIVE = "ACTIVE"
    PAUSED = "PAUSED"
    FAILED = "FAILED"
    TERMINATED = "TERMINATED"


class Supervisor(Base):
    """Supervisor agent for multi-agent monitoring coordination."""

    __tablename__ = "supervisors"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    status = Column(String(50), nullable=False, default=SupervisorStatus.SPAWNING)
    config = Column(JSONB, nullable=False, default={})
    parent_id = Column(UUID(as_uuid=True), ForeignKey("supervisors.id"), nullable=True)
    hierarchy_level = Column(Integer, nullable=False, default=0)
    policy_version_id = Column(UUID(as_uuid=True), nullable=True)
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    last_heartbeat = Column(DateTime, nullable=True)
    health_metrics = Column(JSONB, nullable=False, default={})

    # Relationships
    parent = relationship("Supervisor", remote_side=[id], backref="children")
    teams = relationship("SupervisorTeam", back_populates="supervisor", cascade="all, delete-orphan")


class SupervisorTeam(Base):
    """Team of agents managed by a supervisor."""

    __tablename__ = "supervisor_teams"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    supervisor_id = Column(UUID(as_uuid=True), ForeignKey("supervisors.id"), nullable=False)
    name = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    objective = Column(Text, nullable=True)
    config = Column(JSONB, nullable=False, default={})
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    supervisor = relationship("Supervisor", back_populates="teams")
    members = relationship("SupervisorTeamMember", back_populates="team", cascade="all, delete-orphan")


class SupervisorTeamMember(Base):
    """Agent membership in a supervisor team."""

    __tablename__ = "supervisor_team_members"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    team_id = Column(UUID(as_uuid=True), ForeignKey("supervisor_teams.id"), nullable=False)
    agent_id = Column(UUID(as_uuid=True), nullable=False)
    role = Column(String(100), nullable=False, default="MEMBER")
    joined_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    left_at = Column(DateTime, nullable=True)
    metadata = Column(JSONB, nullable=False, default={})

    # Relationships
    team = relationship("SupervisorTeam", back_populates="members")
```

## Acceptance Criteria

- [ ] All three models created with proper fields and relationships
- [ ] Migration creates tables with proper indexes
- [ ] Migration applies cleanly to fresh database
- [ ] Migration can be rolled back without errors
- [ ] Models use correct column types (UUID, JSONB, DateTime)
- [ ] Relationships properly configured for SQLAlchemy

## Dependencies

**Depends On**: None
**Blocks**: TSK-002 (TeamManager), TSK-003 (SupervisorAgent)

## Estimate

**Size**: M (2-4 hours)
