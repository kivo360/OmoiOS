---
id: TSK-016
title: Implement POST /trigger endpoint
status: pending
ticket_id: TKT-003
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-015]
  blocks: []
---

# TSK-016: Implement POST /trigger endpoint

## Objective

Implement the POST /api/v1/consolidation/trigger endpoint that starts a consolidation job.

## Context

Users need to manually trigger consolidation for projects. This endpoint validates the request and starts an async consolidation job.

## Deliverables

- POST /trigger endpoint implementation

## Implementation Notes

```python
@router.post("/trigger", response_model=TriggerConsolidationResponse, status_code=status.HTTP_202_ACCEPTED)
async def trigger_consolidation(
    request: TriggerConsolidationRequest,
    current_user = Depends(get_current_admin_user),
    db: Session = Depends(get_db),
    service = Depends(get_consolidation_service),
):
    # Validate project exists
    project = db.get(Project, request.project_id)
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")

    # Check if consolidation is disabled
    if not project.consolidation_enabled:
        raise HTTPException(status_code=400, detail="Consolidation disabled for project")

    # Create job record
    job = ConsolidationJob(
        project_id=str(request.project_id),
        status="pending",
        trigger_type="manual",
        options=request.options.dict() if request.options else {},
        triggered_by=current_user.id,
    )
    db.add(job)
    db.flush()

    # Trigger async consolidation
    from omoi_os.tasks.consolidation_tasks import run_project_consolidation
    run_project_consolidation.delay(str(request.project_id), str(job.id))

    return TriggerConsolidationResponse(
        job_id=job.id,
        status="pending",
        estimated_completion=utc_now() + timedelta(minutes=5),
    )
```

## Acceptance Criteria

- [ ] Validates project exists
- [ ] Checks consolidation enabled flag
- [ ] Creates consolidation job record
- [ ] Triggers async Celery task
- [ ] Returns 202 Accepted with job_id
- [ ] Returns estimated completion time
- [ ] Error responses for invalid requests
- [ ] Integration tests

## Dependencies

**Depends On**: TSK-015
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
