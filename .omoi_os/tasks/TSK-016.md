---
id: TSK-016
title: Write integration tests for all endpoints
status: pending
parent_ticket: TKT-002
estimate: M
type: test
dependencies:
  depends_on:
    - TSK-010
    - TSK-011
    - TSK-012
    - TSK-013
    - TSK-014
  blocks: []
---

# TSK-016: Write integration tests for all endpoints

## Objective

Write integration tests for all notification API endpoints using TestClient and database.

## Context

Integration tests verify the API endpoints work correctly with authentication, database, and service layer.

## Deliverables

- [ ] `backend/tests/api/test_notifications_api.py` - API integration tests

## Implementation Notes

```python
# backend/tests/api/test_notifications_api.py

import pytest
from uuid import uuid4
from httpx import AsyncClient

from omoi_os.models.notification import Notification
from omoi_os.models.user import User


@pytest.mark.asyncio
class TestNotificationsAPI:
    async def test_list_notifications_empty(self, client: AsyncClient, test_user: User):
        """Test listing notifications when none exist."""
        response = await client.get("/api/v1/notifications")
        assert response.status_code == 200
        data = response.json()
        assert data["notifications"] == []
        assert data["total"] == 0
        assert data["unread_count"] == 0

    async def test_list_notifications_with_data(self, client: AsyncClient, test_user: User, db_session):
        """Test listing notifications with existing data."""
        # Create notification
        notification = Notification(
            id=uuid4(),
            user_id=test_user.id,
            type="test",
            title="Test",
            message="Test message",
        )
        db_session.add(notification)
        await db_session.commit()

        response = await client.get("/api/v1/notifications")
        assert response.status_code == 200
        data = response.json()
        assert len(data["notifications"]) == 1
        assert data["total"] == 1
        assert data["unread_count"] == 1

    async def test_mark_as_read(self, client: AsyncClient, test_user: User, db_session):
        """Test marking notification as read."""
        notification = Notification(
            id=uuid4(),
            user_id=test_user.id,
            type="test",
            title="Test",
            message="Test message",
        )
        db_session.add(notification)
        await db_session.commit()

        response = await client.patch(f"/api/v1/notifications/{notification.id}/read")
        assert response.status_code == 200

        # Verify in database
        await db_session.refresh(notification)
        assert notification.status == "read"

    async def test_cross_user_access_forbidden(self, client: AsyncClient, other_user: User, db_session):
        """Test that users cannot access other users' notifications."""
        notification = Notification(
            id=uuid4(),
            user_id=other_user.id,
            type="test",
            title="Test",
            message="Test message",
        )
        db_session.add(notification)
        await db_session.commit()

        response = await client.patch(f"/api/v1/notifications/{notification.id}/read")
        assert response.status_code == 404
```

## Acceptance Criteria

- [ ] Test for list notifications endpoint
- [ ] Test for mark as read endpoint
- [ ] Test for mark all as read endpoint
- [ ] Test for delete endpoint
- [ ] Test for unread count endpoint
- [ ] Test for cross-user access denial (403/404)
- [ ] Tests use authenticated test client
- [ ] Tests clean up data
