---
id: TSK-015
title: Add WebSocket broadcasting to NotificationService
status: pending
parent_ticket: TKT-002
estimate: M
type: implementation
dependencies:
  depends_on:
    - TSK-003
    - TSK-010
  blocks: []
---

# TSK-015: Add WebSocket broadcasting to NotificationService

## Objective

Integrate WebSocket broadcasting so new notifications are pushed to connected clients in real-time.

## Context

The existing WebSocket infrastructure at `/api/v1/ws/events` needs to broadcast notification_new and notification_read events.

## Deliverables

- [ ] Update `omoi_os/services/notification_service.py` with WebSocket integration
- [ ] Update frontend `WebSocketProvider.tsx` to handle notification events

## Implementation Notes

```python
# In NotificationService._deliver_websocket
async def _deliver_websocket(self, notification: Notification):
    """Send notification via WebSocket."""
    if self.ws_manager:
        message = {
            "type": "notification_new",
            "payload": notification.to_dict(),
        }
        await self.ws_manager.broadcast_to_user(str(notification.user_id), message)
        await self._mark_ws_delivered(notification.id)
```

```typescript
// In frontend WebSocketProvider.tsx, add to onmessage handler
ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  if (data.type === 'notification_new') {
    // Show toast notification
    toast.show(data.payload.title)
    // Invalidate React Query cache
    queryClient.invalidateQueries({ queryKey: ['notifications'] })
  }
  if (data.type === 'notification_read') {
    queryClient.invalidateQueries({ queryKey: ['notifications'] })
  }
}
```

## Acceptance Criteria

- [ ] NotificationService broadcasts notification_new on creation
- [ ] NotificationService broadcasts notification_read on mark as read
- [ ] WebSocketProvider handles notification events
- [ ] React Query cache invalidated on notification events
- [ ] Toast notification shown for new notifications
