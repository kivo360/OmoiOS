---
id: TSK-015
title: Create API router for consolidation endpoints
status: pending
created: 2025-01-08
parent_ticket: TKT-003
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-004, TSK-011]
  blocks: [TSK-016, TSK-017, TSK-018, TSK-019]
---

# TSK-015: Create API router for consolidation endpoints

## Objective

Create the FastAPI router for consolidation endpoints with proper authentication and dependency injection.

## Context

The consolidation system needs HTTP endpoints for manual triggers, status queries, and rollback operations.

## Deliverables

- `backend/omoi_os/api/routes/consolidation.py` - API router

## Implementation Notes

```python
# omoi_os/api/routes/consolidation.py
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session

from omoi_os.db.session import get_db
from omoi_os.services.consolidation.consolidation_service import get_consolidation_service
from omoi_os.schemas.consolidation import (
    TriggerConsolidationRequest,
    TriggerConsolidationResponse,
    ConsolidationStatusResponse,
    RollbackRequest,
    RollbackResponse,
)
from omoi_os.api.dependencies import get_current_admin_user

router = APIRouter(prefix="/api/v1/consolidation", tags=["consolidation"])

@router.post("/trigger", response_model=TriggerConsolidationResponse, status_code=status.HTTP_202_ACCEPTED)
async def trigger_consolidation(
    request: TriggerConsolidationRequest,
    current_user = Depends(get_current_admin_user),
    db: Session = Depends(get_db),
    service = Depends(get_consolidation_service),
):
    """Trigger manual consolidation for a project."""
    # Implementation follows in TSK-016
    pass

@router.get("/status/{job_id}", response_model=ConsolidationStatusResponse)
async def get_consolidation_status(
    job_id: str,
    current_user = Depends(get_current_admin_user),
    db: Session = Depends(get_db),
):
    """Get consolidation job status."""
    # Implementation follows in TSK-017
    pass

@router.get("/history/{project_id}")
async def get_consolidation_history(
    project_id: str,
    current_user = Depends(get_current_admin_user),
    db: Session = Depends(get_db),
    limit: int = 50,
    offset: int = 0,
):
    """Get consolidation history for a project."""
    # Implementation follows in TSK-018
    pass

@router.post("/rollback", response_model=RollbackResponse)
async def rollback_consolidation(
    request: RollbackRequest,
    current_user = Depends(get_current_admin_user),
    db: Session = Depends(get_db),
):
    """Rollback a consolidation operation."""
    # Implementation follows in TSK-019
    pass
```

## Acceptance Criteria

- [ ] API router created with proper prefix
- [ ] All endpoint stubs defined
- [ ] Authentication dependency added
- [ ] Database session dependency added
- [ ] Service dependency setup
- [ ] OpenAPI tags added
- [ ] Router registered in main app

## Dependencies

**Depends On**: TSK-004 (Schemas), TSK-011 (Service)
**Blocks**: TSK-016, TSK-017, TSK-018, TSK-019

## Estimate

**Size**: S (< 2 hours)
