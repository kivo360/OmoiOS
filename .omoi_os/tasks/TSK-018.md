---
id: TSK-018
title: Implement GET /history endpoint
status: pending
created: 2025-01-08
parent_ticket: TKT-003
estimate: S
type: implementation
dependencies:
  depends_on: [TSK-015]
  blocks: []
---

# TSK-018: Implement GET /history endpoint

## Objective

Implement the GET /api/v1/consolidation/history/{project_id} endpoint for retrieving consolidation history.

## Context

Users need to view past consolidation operations to understand what changes were made.

## Deliverables

- GET /history/{project_id} endpoint implementation

## Implementation Notes

```python
from fastapi import Query

@router.get("/history/{project_id}")
async def get_consolidation_history(
    project_id: str,
    current_user = Depends(get_current_admin_user),
    db: Session = Depends(get_db),
    limit: int = Query(50, ge=1, le=100),
    offset: int = Query(0, ge=0),
    operation: Optional[str] = Query(None),
):
    # Validate access
    project = db.get(Project, project_id)
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")

    if not current_user.has_access(project):
        raise HTTPException(status_code=403, detail="Access denied")

    # Build query
    query = db.query(ConsolidationJob).filter(
        ConsolidationJob.project_id == project_id
    )

    if operation:
        query = query.join(ConsolidationChange).filter(
            ConsolidationChange.operation == operation
        )

    # Get total count
    total = query.count()

    # Get paginated results
    jobs = query.order_by(ConsolidationJob.created_at.desc()).offset(offset).limit(limit).all()

    return {
        "project_id": project_id,
        "total": total,
        "offset": offset,
        "limit": limit,
        "jobs": [
            {
                "job_id": job.id,
                "status": job.status,
                "trigger_type": job.trigger_type,
                "created_at": job.created_at,
                "completed_at": job.completed_at,
                "memories_merged": job.memories_merged,
                "memories_archived": job.memories_archived,
                "memories_promoted": job.memories_promoted,
                "summaries_created": job.summaries_created,
            }
            for job in jobs
        ],
    }
```

## Acceptance Criteria

- [ ] Returns paginated consolidation history
- [ ] Supports filtering by operation type
- [ ] Validates user has access to project
- [ ] Returns total count for pagination
- [ ] Ordered by created_at desc
- [ ] Integration tests

## Dependencies

**Depends On**: TSK-015
**Blocks**: None

## Estimate

**Size**: S (< 2 hours)
