---
id: TSK-008
title: Implement MemorySynthesizer for summaries
status: pending
created: 2025-01-08
parent_ticket: TKT-002
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-002, TSK-003, TSK-006]
  blocks: []
---

# TSK-008: Implement MemorySynthesizer for summaries

## Objective

Implement the memory synthesizer that creates summary memories from clusters using LLM.

## Context

Large clusters of similar memories should have a higher-level summary that extracts patterns, best practices, and insights. This component uses the LLM service to generate summaries.

## Deliverables

- `backend/omoi_os/services/consolidation/memory_synthesizer.py` - MemorySynthesizer class
- `backend/omoi_os/templates/prompts/memory_synthesis.md.j2` - Synthesis prompt template

## Implementation Notes

```python
# omoi_os/services/consolidation/memory_synthesizer.py
from typing import List
from sqlalchemy.orm import Session

from omoi_os.models.task_memory import TaskMemory
from omoi_os.services.embedding import EmbeddingService
from omoi_os.services.llm_service import LLMService
from omoi_os.services.consolidation.similarity_detector import MemoryCluster

class MemorySynthesizer:
    def __init__(
        self,
        embedding_service: EmbeddingService,
        llm_service: LLMService,
    ):
        self.embedding_service = embedding_service
        self.llm_service = llm_service

    async def create_summary(
        self,
        session: Session,
        cluster: MemoryCluster,
    ) -> str:
        """
        Create summary memory from cluster.

        Uses LLM to extract:
        - Common patterns
        - Best practices
        - Architectural insights
        - Gotchas and warnings

        Returns ID of new summary memory.
        """
        # Get source memories
        source_memories = [
            session.get(TaskMemory, mid) for mid in cluster.memory_ids
        ]

        # Build synthesis prompt
        from omoi_os.services.template_service import get_template_service

        template_service = get_template_service()
        prompt = template_service.render(
            "prompts/memory_synthesis.md.j2",
            memories=[
                {
                    "summary": m.execution_summary,
                    "type": m.memory_type,
                    "goal": m.goal,
                }
                for m in source_memories
            ],
        )

        # Generate synthesis using LLM
        synthesis = await self.llm_service.structured_output(
            prompt,
            output_type=MemorySynthesis,
        )

        # Validate confidence
        if synthesis.confidence < 0.80:
            # Flag for review
            pass

        # Create summary memory
        embedding = self.embedding_service.generate_embedding(
            synthesis.summary
        )

        summary = TaskMemory(
            task_id=source_memories[0].task_id,
            execution_summary=synthesis.summary,
            memory_type="synthesis",
            context_embedding=embedding,
            goal=synthesis.patterns,
            result=synthesis.best_practices,
            feedback=synthesis.gotchas,
            tags=["synthesis", "consolidated"],
            synthesized_from=[str(m.id) for m in source_memories],
            synthesized_at=utc_now(),
            synthesis_confidence=synthesis.confidence,
            success=True,
        )

        session.add(summary)
        session.flush()

        return str(summary.id)
```

Prompt template `prompts/memory_synthesis.md.j2`:
```jinja2
You are analyzing a cluster of {{ memories|length }} related memories from an AI agent's work.

{% for mem in memories %}
Memory {{ loop.index }}:
- Type: {{ mem.type }}
- Goal: {{ mem.goal }}
- Summary: {{ mem.summary }}
{% endfor %}

Extract:
1. Common patterns across these memories
2. Best practices identified
3. Architectural insights
4. Gotchas or warnings

Provide a concise summary that synthesizes the key insights.
```

## Acceptance Criteria

- [ ] MemorySynthesizer class with create_summary() method
- [ ] Uses LLM for synthesis with structured output
- [ ] Validates confidence threshold
- [ ] Creates summary memory with type="synthesis"
- [ ] Sets synthesized_from and synthesized_at
- [ ] Stores synthesis_confidence
- [ ] Prompt template created
- [ ] Unit tests with mocked LLM responses

## Dependencies

**Depends On**: TSK-002, TSK-003, TSK-006
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
