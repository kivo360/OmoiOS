---
id: TSK-008
title: Write unit tests for NotificationService
status: pending
parent_ticket: TKT-001
estimate: M
type: test
dependencies:
  depends_on:
    - TSK-003
    - TSK-004
    - TSK-005
  blocks: []
---

# TSK-008: Write unit tests for NotificationService

## Objective

Write comprehensive unit tests for the NotificationService covering creation, delivery, rate limiting, and aggregation.

## Context

Unit tests ensure the notification service works correctly in isolation before integration testing.

## Deliverables

- [ ] `backend/tests/unit/test_notification_service.py` - Unit tests

## Implementation Notes

```python
# backend/tests/unit/test_notification_service.py

import pytest
from uuid import uuid4
from unittest.mock import Mock, AsyncMock

from omoi_os.services.notification_service import NotificationService
from omoi_os.models.notification import Notification


@pytest.mark.asyncio
class TestNotificationService:
    async def test_create_notification_success(self, db_session):
        """Test successful notification creation."""
        # Setup
        notification_service = NotificationService(db_session, ws_manager=Mock())
        user_id = uuid4()

        # Execute
        notification = await notification_service.create_notification(
            user_id=user_id,
            type="ticket_assigned",
            title="Test",
            message="Test message",
            data={},
        )

        # Assert
        assert notification is not None
        assert notification.user_id == user_id
        assert notification.type == "ticket_assigned"

    async def test_create_notification_rate_limited(self, db_session):
        """Test that rate-limited notifications are silent."""
        # Setup
        notification_service = NotificationService(db_session, ws_manager=Mock())
        user_id = uuid4()

        # Mock rate limiter to return True
        notification_service._is_rate_limited = AsyncMock(return_value=True)

        # Execute
        notification = await notification_service.create_notification(
            user_id=user_id,
            type="ticket_assigned",
            title="Test",
            message="Test message",
            data={},
        )

        # Assert
        assert notification is not None
        assert notification.delivered_via_ws == False

    async def test_create_notification_disabled_by_preferences(self, db_session):
        """Test that notifications disabled in preferences are not created."""
        # Setup
        notification_service = NotificationService(db_session, ws_manager=Mock())
        user_id = uuid4()

        # Mock preferences to disable ticket_assigned
        notification_service._get_preferences = AsyncMock(
            return_value=Mock(in_app_enabled=lambda x: False)
        )

        # Execute
        notification = await notification_service.create_notification(
            user_id=user_id,
            type="ticket_assigned",
            title="Test",
            message="Test message",
            data={},
        )

        # Assert
        assert notification is None

    async def test_mark_as_read(self, db_session):
        """Test marking notification as read."""
        # Setup
        notification_service = NotificationService(db_session)
        notification = Notification(
            id=uuid4(),
            user_id=uuid4(),
            type="test",
            title="Test",
            message="Test",
        )
        db_session.add(notification)
        await db_session.commit()

        # Execute
        result = await notification_service.mark_as_read(notification.id, notification.user_id)

        # Assert
        assert result is True
        await db_session.refresh(notification)
        assert notification.status == "read"
        assert notification.read_at is not None
```

## Acceptance Criteria

- [ ] Test for successful notification creation
- [ ] Test for rate-limited notifications
- [ ] Test for preference-based filtering
- [ ] Test for WebSocket delivery
- [ ] Test for mark as read
- [ ] Test for get_notifications with pagination
- [ ] Test for unread count
- [ ] All tests use fixtures for database setup
- [ ] Tests cover both success and failure cases
