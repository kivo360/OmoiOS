---
id: TSK-023
title: Create run_project_consolidation Celery task
status: pending
created: 2025-01-08
parent_ticket: TKT-004
estimate: M
type: implementation
dependencies:
  depends_on: [TSK-011, TSK-022]
  blocks: []
---

# TSK-023: Create run_project_consolidation Celery task

## Objective

Create the Celery task that executes consolidation for a specific project.

## Context

This task is called by both the scheduled job and manual triggers. It runs the actual consolidation workflow.

## Deliverables

- `backend/omoi_os/tasks/consolidation_tasks.py` - run_project_consolidation task

## Implementation Notes

```python
@shared_task(name="consolidation.run_project")
def run_project_consolidation(project_id: str, job_id: Optional[str] = None):
    """
    Run consolidation for a specific project.

    Args:
        project_id: Project to consolidate
        job_id: Optional existing job ID (from manual trigger)

    Returns:
        Dict with consolidation results
    """
    from omoi_os.services.consolidation.consolidation_service import get_consolidation_service
    from omoi_os.schemas.consolidation import ConsolidationOptions

    with get_session() as session:
        # Get project config
        project = session.get(Project, project_id)
        if not project or not project.consolidation_enabled:
            return {"error": "Project not found or consolidation disabled"}

        # Get or create job
        if job_id:
            job = session.get(ConsolidationJob, job_id)
        else:
            job = ConsolidationJob(
                project_id=project_id,
                status="running",
                trigger_type="scheduled",
                options=project.consolidation_config,
                triggered_by="system",
            )
            session.add(job)
            session.flush()

        # Build options from project config
        options = ConsolidationOptions(**project.consolidation_config)

        # Execute consolidation
        service = get_consolidation_service()
        try:
            result = await service.execute_consolidation(
                session=session,
                project_id=project_id,
                options=options,
                trigger_type="scheduled",
                triggered_by="system",
            )

            # Update job
            job.status = "completed"
            job.completed_at = utc_now()
            job.memories_merged = len(result.created_memory_ids)
            job.memories_archived = len(result.archived_memory_ids)
            session.flush()

            return {
                "project_id": project_id,
                "job_id": str(job.id),
                "status": "completed",
                "memories_merged": job.memories_merged,
                "memories_archived": job.memories_archived,
            }

        except Exception as e:
            job.status = "failed"
            job.error_message = str(e)
            job.completed_at = utc_now()
            session.flush()
            raise
```

## Acceptance Criteria

- [ ] Celery task created with name "consolidation.run_project"
- [ ] Loads project consolidation config
- [ ] Creates or uses existing job record
- [ ] Executes ConsolidationService
- [ ] Updates job with results
- [ ] Handles errors and updates job status
- [ ] Returns result summary
- [ ] Tests for success and failure cases

## Dependencies

**Depends On**: TSK-011, TSK-022
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
