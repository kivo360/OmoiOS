---
id: TKT-002
title: Consolidation Service Core Logic
status: backlog
priority: HIGH
estimate: L
design_ref: designs/memory-consolidation.md
requirements:
  - REQ-MEMCONS-FUNC-001
  - REQ-MEMCONS-FUNC-002
  - REQ-MEMCONS-FUNC-003
  - REQ-MEMCONS-FUNC-004
  - REQ-MEMCONS-FUNC-005
dependencies:
  blocked_by: [TKT-001]
  blocks: [TKT-003, TKT-004]
---

# TKT-002: Consolidation Service Core Logic

## Description

Implement the core ConsolidationService that handles memory clustering, merging, summarization, archiving, and playbook promotion. This is the heart of the consolidation system.

## Scope

### In Scope
- SimilarityDetector: Cluster memories using embedding similarity
- MemoryMerger: Merge similar memories into consolidated entries
- MemorySynthesizer: Create summary memories from clusters
- MemoryArchiver: Archive stale/unused memories
- PlaybookPromoter: Promote high-value memories to playbook
- ConsolidationService: Orchestrator for all operations
- Audit logging for all operations

### Out of Scope
- API endpoints (covered in TKT-003)
- Scheduled job triggers (covered in TKT-004)

## Acceptance Criteria

- [ ] `ConsolidationService` class with execute_consolidation() method
- [ ] `detect_similar_clusters()` using pgvector cosine similarity
- [ ] `merge_cluster()` creates consolidated memory, marks sources as duplicate
- [ ] `create_summary()` uses LLM for synthesis, validates confidence
- [ ] `archive_stale_memories()` by staleness and reuse criteria
- [ ] `promote_to_playbook()` with confidence threshold
- [ ] All operations create audit records in consolidation_changes
- [ ] Integration with existing MemoryService
- [ ] Error handling and transaction safety
- [ ] Unit tests for each component
- [ ] Integration tests for full workflow

## Technical Notes

### Clustering Algorithm
```python
# Connected components on similarity graph
# Threshold: 0.90 (configurable)
# Min cluster size: 2 (configurable)
```

### Merge Strategy
- Select representative: highest reused_count
- Combine content: concatenate with separators
- Merge tags: union of all source tags
- Preserve file links from all sources
- Generate new embedding

### Synthesis Prompt
Uses LLM to extract:
- Common patterns across memories
- Best practices
- Architectural insights
- Gotchas and warnings

### Archival Criteria
- Not reused in X days (default 90)
- Total reuse_count < Y (default 3)
- Not already archived or duplicate

## Dependencies

**Blocked By**: TKT-001 (Database Schema)
**Blocks**: TKT-003 (API), TKT-004 (Scheduled Jobs)

## Estimate

**Size**: L (4-8 hours)
**Rationale**: Complex business logic, multiple algorithms, LLM integration, thorough testing

## Tasks

- TSK-006: Implement SimilarityDetector for clustering
- TSK-007: Implement MemoryMerger for merging clusters
- TSK-008: Implement MemorySynthesizer for summaries
- TSK-009: Implement MemoryArchiver for stale memories
- TSK-010: Implement PlaybookPromoter for playbook integration
- TSK-011: Implement ConsolidationService orchestrator
- TSK-012: Add audit logging for all operations
- TSK-013: Write unit tests for each component
- TSK-014: Write integration tests for full workflow
