---
id: TKT-002
title: Policy Engine and Intervention Orchestration
status: backlog
priority: HIGH
estimate: L
design_ref: designs/supervisor-agent.md
requirements:
  - REQ-SUPERVISOR-FUNC-003
  - REQ-SUPERVISOR-FUNC-004
  - REQ-SUPERVISOR-FUNC-008
  - REQ-SUPERVISOR-FUNC-010
dependencies:
  blocked_by: [TKT-001]
  blocks: [TKT-003]
---

# TKT-002: Policy Engine and Intervention Orchestration

## Description

Implement the policy evaluation engine that determines when interventions are needed, and the intervention orchestrator that executes actions across Guardian, Conductor, and other services.

## Scope

### In Scope
- PolicyEngine service for evaluating policy conditions
- Policy database models and CRUD operations
- Intervention orchestrator for executing interventions
- Alert aggregation and correlation
- Policy and intervention API endpoints

### Out of Scope
- Adaptive learning (covered in TKT-003)
- Hierarchical escalation (covered in TKT-004)

## Acceptance Criteria

- [ ] PolicyEngine evaluates policies within 500ms
- [ ] Policy conditions support field comparison and composite (AND/OR/NOT) logic
- [ ] Policies can be created via POST /api/v1/policies
- [ ] Policy simulation predicts outcomes without execution
- [ ] Interventions execute actions across GuardianService, TaskQueueService, AgentRegistry
- [ ] Alert aggregation correlates alerts within 5-minute window
- [ ] Intervention outcomes recorded for learning
- [ ] Unit tests for policy evaluation, intervention execution
- [ ] Integration tests with GuardianService and other services

## Technical Notes

### Files to Create
- `backend/omoi_os/models/policy.py` - Policy models
- `backend/omoi_os/services/policy_engine.py` - Policy evaluation engine
- `backend/omoi_os/services/intervention_orchestrator.py` - Intervention execution
- `backend/omoi_os/services/alert_aggregator.py` - Alert correlation
- `backend/omoi_os/api/routes/policies.py` - Policy API routes
- `backend/omoi_os/api/routes/interventions.py` - Intervention API routes

### Policy Definition Format
```yaml
condition:
  type: composite
  operator: AND
  conditions:
    - type: field_comparison
      field: agent.anomaly_score
      operator: ">="
      value: 0.8
    - type: field_comparison
      field: agent.consecutive_anomalous_readings
      operator: ">="
      value: 3
actions:
  - type: quarantine_agent
    target: "${agent.id}"
    reason: "Consecutive anomalous readings"
    approval_required: false
```

### Intervention Types
- `AGENT_RESTART` - Restart individual agent
- `AGENT_QUARANTINE` - Quarantine agent
- `TEAM_RESTART` - Restart all team members (staggered)
- `TASK_REASSIGN` - Reassign task to different agent
- `PRIORITY_OVERRIDE` - Change task priority

## Tasks

- TSK-007: Create policy database models
- TSK-008: Implement PolicyEngine service
- TSK-009: Implement InterventionOrchestrator service
- TSK-010: Implement AlertAggregator service
- TSK-011: Create policy and intervention API routes
- TSK-012: Write tests for policy and intervention services

## Dependencies

**Blocked By**: TKT-001 (Supervisor Core)
**Blocks**: TKT-003 (Adaptive Learning)

## Estimate

**Size**: L (4-8 hours)
**Rationale**: Complex policy evaluation logic, integration with multiple services, alert correlation algorithms
