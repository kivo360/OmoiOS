---
id: TKT-002
title: Consolidation Engine and Trigger Service
status: backlog
priority: HIGH
estimate: XL
design_ref: designs/agent-memory-consolidation.md
requirements:
  - REQ-AMC-FUNC-001
  - REQ-AMC-FUNC-002
  - REQ-AMC-FUNC-014
  - REQ-AMC-FUNC-015
  - REQ-AMC-FUNC-016
dependencies:
  blocked_by:
    - TKT-001
  blocks:
    - TKT-003
    - TKT-004
    - TKT-005
---

# TKT-002: Consolidation Engine and Trigger Service

## Description

Implement the core ConsolidationEngine that orchestrates the multi-phase consolidation workflow (Pattern Extraction → Memory Merging → Hierarchy Creation → Playbook Integration) and the Trigger Service that monitors conditions and initiates consolidation jobs.

## Scope

### In Scope
- `ConsolidationTriggerService` for monitoring trigger conditions
- `ConsolidationEngine` for orchestrating consolidation phases
- Task queue integration for async job execution
- Job status tracking and error handling
- Admin API endpoints for manual control
- Consolidation metrics collection

### Out of Scope
- Individual phase implementations (Pattern Extractor, Memory Merger, etc.)
- Agent tools for querying consolidated memories

## Acceptance Criteria

- [ ] `ConsolidationTriggerService` implemented with:
  - Time-based scheduling (cron: nightly at 2 AM)
  - Threshold-based triggering (every 100 new memories)
  - Manual trigger support
  - Project-scoped triggering
- [ ] `ConsolidationEngine` implemented with:
  - Four-phase workflow orchestration
  - Phase error handling (continues on failure)
  - Progress tracking and metrics
  - Timeout enforcement (default: 10 min per 1000 memories)
- [ ] Task queue integration:
  - Jobs enqueued in TaskQueueService
  - Worker executes consolidation jobs
  - Job status updates (pending → running → completed/failed)
- [ ] Admin API endpoints:
  - `POST /api/v1/admin/consolidate-memories` - Trigger consolidation
  - `GET /api/v1/admin/consolidation-status/{job_id}` - Get job status
  - `GET /api/v1/admin/consolidation-metrics/{project_id}` - Get metrics
- [ ] Error handling:
  - Failed phases don't crash entire job
  - Retry logic with exponential backoff
  - Error messages stored in job record
- [ ] Metrics collection:
  - Memories processed count
  - Patterns extracted count
  - Memories merged count
  - Execution time tracking
- [ ] All tests pass

## Technical Notes

**File Locations**:
- Trigger Service: `backend/omoi_os/services/consolidation/trigger_service.py`
- Engine: `backend/omoi_os/services/consolidation_engine.py`
- API Routes: `backend/omoi_os/api/routes/admin_consolidation.py`
- Worker Task: `backend/omoi_os/workers/consolidation_worker.py`

**Key Considerations**:
- Use APScheduler for time-based triggering
- Phase services (PatternExtractor, MemoryMerger, etc.) injected as dependencies
- Database session management across phases
- Event publishing for job completion

**Consolidation Engine Interface**:
```python
class ConsolidationEngine:
    async def execute(job_id: str) -> ConsolidationResult:
        # Phase 1: Pattern Extraction
        # Phase 2: Memory Merging
        # Phase 3: Hierarchy Creation
        # Phase 4: Playbook Integration
        # Return result with metrics
```

**Trigger Service Interface**:
```python
class ConsolidationTriggerService:
    def start(self) -> None:
        # Start scheduler, register triggers

    def trigger_consolidation(project_id: str, trigger_type: str) -> str:
        # Queue job and return job_id
```

## Tasks

- TSK-007: Create ConsolidationTriggerService with APScheduler
- TSK-008: Implement ConsolidationEngine orchestration
- TSK-009: Create consolidation worker for task queue
- TSK-010: Implement admin API endpoints
- TSK-011: Add job status tracking and metrics
- TSK-012: Write tests for engine and trigger service
- TSK-013: Write integration tests for admin API

## Dependencies

**Blocked By**: TKT-001 (Database models must exist first)
**Blocks**: TKT-003, TKT-004, TKT-005 (Phase implementations depend on engine)

## Estimate

**Size**: XL (8-16 hours)
**Rationale**: Complex orchestration logic, scheduler integration, task queue integration, admin API, and comprehensive testing.
