---
id: TKT-004
title: Scheduled Consolidation Jobs
status: backlog
priority: MEDIUM
estimate: M
design_ref: designs/memory-consolidation.md
requirements:
  - REQ-MEMCONS-FUNC-006
dependencies:
  blocked_by: [TKT-002]
  blocks: []
---

# TKT-004: Scheduled Consolidation Jobs

## Description

Implement Celery scheduled tasks for automatic consolidation. Includes a daily job that checks all projects for memory count threshold and triggers consolidation for eligible projects.

## Scope

### In Scope
- Celery task: run_scheduled_consolidation (daily beat)
- Celery task: run_project_consolidation (per project)
- Project threshold checking
- Job progress tracking
- Error handling and retry logic
- Configuration for schedule interval

### Out of Scope
- Manual trigger (covered in TKT-003)
- Threshold auto-adjustment (future)

## Acceptance Criteria

- [ ] `run_scheduled_consolidation` Celery task created
- [ ] Checks projects exceeding memory threshold
- [ ] Triggers per-project consolidation in parallel
- [ ] `run_project_consolidation` task with result tracking
- [ ] Celery beat configuration for daily schedule
- [ ] Error handling with retry on failure
- [ ] Job status updates in database
- [ ] Tests for scheduled execution

## Technical Notes

### Celery Beat Schedule
```python
CELERY_BEAT_SCHEDULE = {
    'consolidation-daily': {
        'task': 'consolidation.run_scheduled',
        'schedule': crontab(hour=2, minute=0),  # 2 AM daily
    },
}
```

### Threshold Check
```sql
SELECT project_id, COUNT(*) as count
FROM task_memories
WHERE is_duplicate = false AND is_archived = false
GROUP BY project_id
HAVING COUNT(*) > project.consolidation_threshold
```

## Dependencies

**Blocked By**: TKT-002 (Consolidation Service)
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
**Rationale**: Celery setup, task implementation, scheduling

## Tasks

- TSK-022: Create run_scheduled_consolidation Celery task
- TSK-023: Create run_project_consolidation Celery task
- TSK-024: Configure Celery beat schedule
- TSK-025: Add error handling and retry logic
- TSK-026: Write tests for scheduled tasks
