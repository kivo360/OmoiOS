---
id: TKT-004
title: Hierarchy Creator and Playbook Integrator
status: backlog
priority: MEDIUM
estimate: L
design_ref: designs/agent-memory-consolidation.md
requirements:
  - REQ-AMC-FUNC-007
  - REQ-AMC-FUNC-008
  - REQ-AMC-FUNC-009
  - REQ-AMC-FUNC-010
dependencies:
  blocked_by:
    - TKT-001
    - TKT-003
  blocks:
    - TKT-005
---

# TKT-004: Hierarchy Creator and Playbook Integrator

## Description

Implement the Hierarchy Creator (promotes patterns to abstract principles) and Playbook Integrator (auto-generates and updates playbook entries from consolidated insights).

## Scope

### In Scope
- `HierarchyCreator` service for multi-level knowledge synthesis
- `PlaybookIntegrator` service for playbook enrichment
- Pattern grouping and principle synthesis using LLM
- Playbook entry creation and update logic
- Integration with existing playbook_entries table

### Out of Scope
- Agent tools implementation
- Admin API (covered in TKT-002)

## Acceptance Criteria

- [ ] `HierarchyCreator` implemented with:
  - Groups extracted patterns by semantic similarity
  - Uses LLM to synthesize principles from patterns
  - Creates ConsolidatedMemory with abstraction_level=3
  - Links principles to source patterns
  - Validates principle quality (confidence > 0.8)
- [ ] `PlaybookIntegrator` implemented with:
  - Creates PlaybookEntry for high-confidence patterns (>0.8)
  - Detects similarity to existing entries (>0.9)
  - Updates existing entries with new evidence
  - Infers category from pattern content
  - Records changes in playbook_changes table
  - Sets priority based on confidence and evidence count
- [ ] All tests pass

## Technical Notes

**File Locations**:
- Hierarchy Creator: `backend/omoi_os/services/consolidation/hierarchy_creator.py`
- Playbook Integrator: `backend/omoi_os/services/consolidation/playbook_integrator.py`

**Key Considerations**:
- Reuse existing playbook_entries table from memory system
- Category inference: use simple keyword matching or LLM classification
- Priority calculation: `confidence * evidence_count`
- Similarity detection uses embedding search against existing entries

**Hierarchy Creation Algorithm**:
1. Group patterns (abstraction_level=2) by similarity
2. For groups with â‰¥3 patterns:
   - Synthesize principle using LLM
   - Create ConsolidatedMemory (abstraction_level=3)
   - Link to source patterns via source_memory_ids

**Playbook Integration Algorithm**:
1. For each high-confidence pattern/principle:
   - Search existing playbook entries for similarity
   - If similar entry found (>0.9):
     - Append to supporting_memory_ids
     - Increment priority
     - Record change in playbook_changes
   - If no similar entry:
     - Create new PlaybookEntry
     - Infer category from content
     - Set priority based on confidence
     - Record creation in playbook_changes

## Tasks

- TSK-023: Implement HierarchyCreator with pattern grouping
- TSK-024: Implement LLM-based principle synthesis
- TSK-025: Implement PlaybookIntegrator with entry creation
- TSK-026: Implement playbook entry update logic
- TSK-027: Add category inference from content
- TSK-028: Write unit tests for HierarchyCreator
- TSK-029: Write unit tests for PlaybookIntegrator
- TSK-030: Write integration tests with playbook tables

## Dependencies

**Blocked By**:
- TKT-001 (Database models)
- TKT-003 (Pattern Extractor produces patterns)

**Blocks**: TKT-005 (Agent tools use consolidated knowledge)

## Estimate

**Size**: L (4-8 hours)
**Rationale**: Moderate complexity LLM integration, playbook table integration, but fewer moving parts than pattern extraction.
