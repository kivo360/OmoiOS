---
id: TKT-004
title: Hierarchical Supervision
status: backlog
priority: MEDIUM
estimate: M
design_ref: designs/supervisor-agent.md
requirements:
  - REQ-SUPERVISOR-FUNC-006
dependencies:
  blocked_by: [TKT-001]
  blocks: []
---

# TKT-004: Hierarchical Supervision

## Description

Implement hierarchical supervision allowing supervisors to be organized in a tree structure with parent-child relationships and escalation paths.

## Scope

### In Scope
- Hierarchy manager service
- Parent-child supervisor relationships
- Escalation from child to parent supervisors
- Hierarchy depth validation (max 5 levels)
- Aggregate status queries for parent supervisors
- Circular reference detection

### Out of Scope
- Multi-region hierarchies
- Cross-organization supervision

## Acceptance Criteria

- [ ] Child supervisors can specify parent during creation
- [ ] Hierarchy depth limited to 5 levels (enforced)
- [ ] Circular references prevented with validation
- [ ] Child supervisors can escalate issues to parent
- [ ] Parent supervisors can query aggregate status of children
- [ ] Hierarchy traversal supports both up and down
- [ ] Unit tests for hierarchy validation and traversal
- [ ] Integration test for escalation flow

## Technical Notes

### Files to Create
- `backend/omoi_os/services/hierarchy_manager.py` - Hierarchy management

### Hierarchy Validation
```python
def validate_hierarchy(supervisor_id: UUID, parent_id: UUID) -> bool:
    """Validate that parent assignment won't create:
    1. Circular reference
    2. Exceed max depth (5 levels)
    """
    # Check for circular reference
    if would_create_cycle(supervisor_id, parent_id):
        raise ValueError("Circular reference detected")

    # Check depth
    depth = calculate_depth(parent_id)
    if depth >= 5:
        raise ValueError("Hierarchy depth exceeded (max 5)")
```

### Escalation Flow
1. Child supervisor determines it cannot handle issue
2. Child publishes escalation event with parent_id
3. Parent receives event and evaluates policies
4. Parent either handles or escalates further up

## Tasks

- TSK-018: Implement HierarchyManager service
- TSK-019: Add escalation event handling
- TSK-020: Implement aggregate status queries
- TSK-021: Add hierarchy validation to supervisor creation
- TSK-022: Write tests for hierarchical supervision

## Dependencies

**Blocked By**: TKT-001 (Supervisor Core)
**Blocks**: None

## Estimate

**Size**: M (2-4 hours)
**Rationale**: Well-scoped feature, tree traversal algorithms are standard, minimal integration points

## Tasks

- TSK-018: Implement HierarchyManager service
- TSK-019: Add escalation event handling
- TSK-020: Implement aggregate status queries
- TSK-021: Add hierarchy validation to supervisor creation
- TSK-022: Write tests for hierarchical supervision
