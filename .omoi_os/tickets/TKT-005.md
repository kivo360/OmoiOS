---
id: TKT-005
title: Agent Tools and Consolidation Service
status: backlog
priority: HIGH
estimate: L
design_ref: designs/agent-memory-consolidation.md
requirements:
  - REQ-AMC-FUNC-011
  - REQ-AMC-FUNC-012
  - REQ-AMC-FUNC-013
dependencies:
  blocked_by:
    - TKT-001
    - TKT-002
    - TKT-003
    - TKT-004
  blocks: []
---

# TKT-005: Agent Tools and Consolidation Service

## Description

Implement agent tools for querying consolidated memories and the ConsolidationService that provides search, lineage tracing, and metrics capabilities.

## Scope

### In Scope
- `ConsolidationService` for consolidation operations
- Agent tool: `omoi__search_consolidated_memories`
- Agent tool: `omoi__get_consolidated_context`
- Agent tool: `omoi__trace_memory_lineage`
- Hybrid search for consolidated memories
- Memory lineage tracing

### Out of Scope
- Admin API (covered in TKT-002)
- Core consolidation logic (covered in TKT-002, TKT-003, TKT-004)

## Acceptance Criteria

- [ ] `ConsolidationService` implemented with:
  - `trigger_consolidation()` method
  - `search_consolidated()` method (hybrid search)
  - `get_metrics()` method
  - `trace_lineage()` method
  - `get_context()` method
- [ ] `SearchConsolidatedMemoriesTool` implemented:
  - Tool name: `omoi__search_consolidated_memories`
  - Accepts query, abstraction_levels, memory_types, limit
  - Returns results with relevance scores
  - Response time <100ms
- [ ] `GetConsolidatedContextTool` implemented:
  - Tool name: `omoi__get_consolidated_context`
  - Accepts task_description, project_id
  - Returns consolidated memories + playbook entries
  - Includes recommendations for which levels to query
- [ ] `TraceMemoryLineageTool` implemented:
  - Tool name: `omoi__trace_memory_lineage`
  - Accepts memory_id (raw or consolidated)
  - Returns full consolidation tree
  - Supports depth limit
- [ ] Hybrid search:
  - Semantic search using embeddings
  - Keyword search using full-text
  - Reciprocal Rank Fusion for combining results
  - Filter by abstraction_level and memory_type
- [ ] All tools registered with OpenHands
- [ ] All tests pass

## Technical Notes

**File Locations**:
- Service: `backend/omoi_os/services/consolidation_service.py`
- Tool 1: `backend/omoi_os/tools/consolidation_tools.py`
- Tool 2: `backend/omoi_os/tools/consolidation_tools.py`
- Tool 3: `backend/omoi_os/tools/consolidation_tools.py`

**Key Considerations**:
- Reuse existing search patterns from MemoryService
- ConsolidationService wraps engine and provides high-level API
- Tools follow existing OmoiOS tool patterns
- Support both raw and consolidated memory IDs for lineage tracing

**Tool Descriptions**:
```python
# omoi__search_consolidated_memories
"""
Search consolidated memories for higher-level patterns and principles.

Use this when you want to find:
- General patterns across similar tasks
- Abstract principles and best practices
- Consolidated insights from multiple executions

Args:
    query: Natural language search query
    abstraction_levels: Filter by level (1=merged, 2=pattern, 3=principle)
    memory_types: Filter by memory type
    limit: Maximum results (default: 10)

Returns:
    List of consolidated memories with relevance scores
"""

# omoi__get_consolidated_context
"""
Get consolidated knowledge context for a task.

Use this at the start of a task to load:
- Relevant consolidated memories
- Related playbook entries
- Recommendations for which knowledge levels to query

Args:
    task_description: Description of the task you're starting
    project_id: Project ID (optional, inferred from context)

Returns:
    Consolidated memories, playbook entries, and recommendations
"""

# omoi__trace_memory_lineage
"""
Trace the consolidation lineage of a memory.

Use this to understand:
- What raw memories created a consolidated memory
- What consolidated memories derived from a raw memory
- The full consolidation tree

Args:
    memory_id: ID of any memory (raw or consolidated)
    max_depth: Maximum depth to traverse (default: 3)

Returns:
    Consolidation tree with relationships and similarity scores
"""
```

**Lineage Tracing Algorithm**:
1. Start with given memory_id
2. If raw memory: follow consolidated_into_id forward
3. If consolidated memory: follow source_memory_ids backward
4. Build tree recursively up to max_depth
5. Return tree with relationships

## Tasks

- TSK-031: Implement ConsolidationService with search methods
- TSK-032: Implement hybrid search for consolidated memories
- TSK-033: Implement SearchConsolidatedMemoriesTool
- TSK-034: Implement GetConsolidatedContextTool
- TSK-035: Implement TraceMemoryLineageTool
- TSK-036: Register tools with OpenHands
- TSK-037: Write unit tests for ConsolidationService
- TSK-038: Write unit tests for consolidation tools
- TSK-039: Write integration tests for tool registration

## Dependencies

**Blocked By**:
- TKT-001 (Database models)
- TKT-002 (Engine for job triggering)
- TKT-003 (Patterns to search)
- TKT-004 (Principles to search)

**Blocks**: None (final ticket in consolidation system)

## Estimate

**Size**: L (4-8 hours)
**Rationale**: Service layer is relatively straightforward, tools follow established patterns, hybrid search reuses existing code.
