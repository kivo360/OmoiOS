---
id: TKT-001
title: Database Schema and Models for Consolidation
status: backlog
priority: HIGH
estimate: M
design_ref: designs/memory-consolidation.md
requirements:
  - REQ-MEMCONS-FUNC-001
  - REQ-MEMCONS-FUNC-008
dependencies:
  blocked_by: []
  blocks: [TKT-002]
---

# TKT-001: Database Schema and Models for Consolidation

## Description

Set up the database foundation for memory consolidation by creating new tables (consolidation_jobs, consolidation_changes) and extending the task_memories table with consolidation-related fields. Create corresponding SQLAlchemy models and Pydantic schemas.

## Scope

### In Scope
- Create `consolidation_jobs` table with job tracking fields
- Create `consolidation_changes` audit table
- Add consolidation columns to `task_memories` table
- Create SQLAlchemy ORM models for new tables
- Create Pydantic request/response models
- Add database indexes for consolidation queries
- Create Alembic migration

### Out of Scope
- Consolidation business logic (covered in TKT-002)
- API endpoints (covered in TKT-003)

## Acceptance Criteria

- [ ] `consolidation_jobs` table exists with all required columns
- [ ] `consolidation_changes` table exists with audit trail fields
- [ ] `task_memories` table has consolidation columns (consolidated_from, is_archived, etc.)
- [ ] `ConsolidationJob` SQLAlchemy model created
- [ ] `ConsolidationChange` SQLAlchemy model created
- [ ] `TaskMemory` model extended with consolidation fields
- [ ] Pydantic models for API contracts (ConsolidationOptions, TriggerConsolidationRequest, etc.)
- [ ] Alembic migration created and tested
- [ ] Indexes created for consolidation queries
- [ ] Check constraints added for status enums
- [ ] All unit tests pass

## Technical Notes

### Table: consolidation_jobs
- Primary key: UUID
- Foreign key: project_id → projects(id)
- Status enum: pending, running, completed, failed
- Trigger type: scheduled, manual, threshold
- Options: JSONB with merge/summarize/archive/promote flags
- Result counters: memories_merged, archived, promoted, summaries_created

### Table: consolidation_changes
- Primary key: UUID
- Foreign key: consolidation_job_id → consolidation_jobs(id)
- Foreign key: memory_id → task_memories(id)
- Operation: merge, archive, promote, summarize, rollback
- State tracking: previous_state, new_state JSONB

### task_memories Extensions
- `consolidated_from`: UUID[] - source memory IDs
- `consolidated_at`: TIMESTAMP
- `synthesized_from`: UUID[] - source cluster IDs
- `synthesized_at`: TIMESTAMP
- `synthesis_confidence`: FLOAT
- `is_archived`: BOOLEAN
- `archived_at`: TIMESTAMP
- `archive_reason`: VARCHAR(50)

## Dependencies

**Blocked By**: None
**Blocks**: TKT-002 (Consolidation Service)

## Estimate

**Size**: M (2-4 hours)
**Rationale**: Standard database schema changes with migration, multiple tables, model creation

## Tasks

- TSK-001: Create database migration for consolidation tables
- TSK-002: Create SQLAlchemy models for consolidation
- TSK-003: Extend TaskMemory model with consolidation fields
- TSK-004: Create Pydantic schemas for API contracts
- TSK-005: Write unit tests for models and schemas
