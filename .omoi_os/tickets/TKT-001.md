---
id: TKT-001
title: Notification Service Core Infrastructure
status: backlog
priority: HIGH
estimate: L
design_ref: designs/notification-system.md
requirements:
  - REQ-NOTIF-FUNC-001
  - REQ-NOTIF-FUNC-006
  - REQ-NOTIF-FUNC-009
  - REQ-NOTIF-FUNC-010
dependencies:
  blocked_by: []
  blocks:
    - TKT-002
    - TKT-004
---

# TKT-001: Notification Service Core Infrastructure

## Description

Build the core notification infrastructure including database models, NotificationService for creating and delivering notifications, aggregation logic to prevent spam, rate limiting, and automated cleanup jobs.

## Scope

### In Scope
- Notification and NotificationPreference database models
- Database migration for new tables
- NotificationService with create/deliver methods
- NotificationAggregator for grouping similar notifications
- Rate limiting to prevent notification spam
- Cleanup job for old notifications
- Integration with EventBusService for event subscription
- Unit tests for core service logic

### Out of Scope
- API endpoints (covered in TKT-002)
- Email delivery (covered in TKT-004)
- User preference UI
- Frontend notification center component

## Acceptance Criteria

- [ ] Notification model with all required fields (id, user_id, type, title, message, data, status, timestamps)
- [ ] NotificationPreference model for user preferences
- [ ] OrganizationNotificationPreference model for org defaults
- [ ] Database migration creates all tables and indexes
- [ ] NotificationService.create_notification() creates records and triggers delivery
- [ ] NotificationAggregator groups similar notifications within 5-minute window
- [ ] Rate limiting prevents >10 notifications/hour per user (configurable)
- [ ] Cleanup job deletes old read notifications when count exceeds 1000
- [ ] EventBus integration subscribes to relevant events (ticket_updated, task_completed, etc.)
- [ ] All new code has unit tests with >80% coverage
- [ ] Integration tests verify end-to-end notification creation

## Technical Notes

- Use SQLAlchemy async patterns for database operations
- Integrate with existing DatabaseService from omoi_os.services.database
- Store notification preferences as JSONB for flexibility
- Use Redis for rate limit counters if available, else PostgreSQL
- Background tasks use existing task queue pattern

## Tasks

- TSK-001: Create Notification and NotificationPreference models
- TSK-002: Create database migration for notification tables
- TSK-003: Implement NotificationService core methods
- TSK-004: Implement NotificationAggregator
- TSK-005: Implement rate limiting logic
- TSK-006: Implement notification cleanup job
- TSK-007: Integrate with EventBusService for event subscription
- TSK-008: Write unit tests for NotificationService
- TSK-009: Write integration tests for notification flow

## Dependencies

**Blocked By**: None
**Blocks**: TKT-002 (API endpoints require NotificationService), TKT-004 (email requires NotificationService)

## Estimate

**Size**: L (4-8 hours)
**Rationale**: Multiple components (models, service, aggregation, rate limiting, cleanup, EventBus integration) with careful attention to performance and reliability.
