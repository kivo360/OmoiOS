---
id: TKT-001
title: Consolidation Database Models and Migrations
status: backlog
priority: HIGH
estimate: L
design_ref: designs/agent-memory-consolidation.md
requirements:
  - REQ-AMC-DM-001
  - REQ-AMC-DM-002
  - REQ-AMC-DM-003
dependencies:
  blocked_by: []
  blocks:
    - TKT-002
    - TKT-003
---

# TKT-001: Consolidation Database Models and Migrations

## Description

Create the database schema for the Agent Memory Consolidation System. This includes new tables for consolidated memories and consolidation jobs, plus enhancements to the existing task_memories table.

## Scope

### In Scope
- Create `ConsolidatedMemory` model with embedding support
- Create `ConsolidationJob` model for job tracking
- Add consolidation fields to existing `TaskMemory` model
- Create Alembic migration for schema changes
- Add database indexes for performance
- Add foreign key constraints

### Out of Scope
- Data migration (populating new tables)
- Consolidation logic implementation
- API endpoints

## Acceptance Criteria

- [ ] `ConsolidatedMemory` model created with all required fields:
  - id, project_id, content, memory_type, abstraction_level
  - pattern_type, confidence_score, source_memory_ids
  - embedding vector, content_tsv, tags
  - consolidation_method, created_at, updated_at, consolidated_at
  - source_count, reuse_count
- [ ] `ConsolidationJob` model created with all required fields:
  - id, project_id, status, trigger_type
  - scope (JSONB), phases_completed, metrics
  - started_at, completed_at, duration_seconds
  - error_message, retry_count, max_retries
  - created_at, triggered_by
- [ ] `TaskMemory` model enhanced with:
  - consolidated_into_id (FK to ConsolidatedMemory)
  - is_consolidated (BOOLEAN)
- [ ] Alembic migration file created
- [ ] Database indexes created:
  - idx_cm_project, idx_cm_abstraction, idx_cm_type
  - idx_cm_embedding (HNSW pgvector index)
  - idx_cm_content_tsv (GIN full-text index)
  - idx_cm_source_ids (GIN for array)
  - idx_cj_project_status, idx_cj_created
  - idx_tm_consolidated, idx_tm_consolidated_into
- [ ] Foreign key constraints added
- [ ] Check constraints for enums added
- [ ] All migrations run successfully without errors
- [ ] Tests verify model relationships and constraints

## Technical Notes

**File Locations**:
- Model: `backend/omoi_os/models/consolidated_memory.py`
- Model: `backend/omoi_os/models/consolidation_job.py`
- Migration: `backend/migrations/versions/{timestamp}_consolidation_tables.py`

**Key Considerations**:
- Use PostgreSQL UUID type for IDs
- pgvector extension must be enabled for embedding column
- GIN indexes for array columns (source_memory_ids, tags)
- HNSW index for vector similarity search
- ON DELETE CASCADE for project_id foreign keys
- ON DELETE SET NULL for consolidated_into_id (preserve source memories)

**Migration Steps**:
1. Create `consolidated_memories` table
2. Create `consolidation_jobs` table
3. Add columns to `task_memories` table
4. Create all indexes
5. Add foreign key constraints
6. Add check constraints

## Tasks

- TSK-001: Create ConsolidatedMemory SQLAlchemy model
- TSK-002: Create ConsolidationJob SQLAlchemy model
- TSK-003: Enhance TaskMemory model with consolidation fields
- TSK-004: Create Alembic migration for consolidation tables
- TSK-005: Add database indexes for performance
- TSK-006: Write tests for models and migrations

## Dependencies

**Blocked By**: None (foundational ticket)
**Blocks**: TKT-002 (Consolidation Engine), TKT-003 (Pattern Extractor), TKT-004 (Memory Merger)

## Estimate

**Size**: L (4-8 hours)
**Rationale**: Database schema design, migration creation, and testing require careful attention to detail and multiple iterations to get right.
