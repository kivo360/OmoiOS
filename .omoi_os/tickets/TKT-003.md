---
id: TKT-003
title: Pattern Extractor and Memory Merger
status: backlog
priority: HIGH
estimate: XL
design_ref: designs/agent-memory-consolidation.md
requirements:
  - REQ-AMC-FUNC-003
  - REQ-AMC-FUNC-004
  - REQ-AMC-FUNC-005
  - REQ-AMC-FUNC-006
dependencies:
  blocked_by:
    - TKT-001
    - TKT-002
  blocks:
    - TKT-004
---

# TKT-003: Pattern Extractor and Memory Merger

## Description

Implement the Pattern Extractor (analyzes groups of similar memories to extract recurring patterns using LLM) and Memory Merger (combines highly similar memories to reduce redundancy).

## Scope

### In Scope
- `PatternExtractor` service for LLM-based pattern extraction
- `MemoryMerger` service for similarity-based memory merging
- Semantic similarity grouping using embeddings
- LLM integration for pattern synthesis
- Confidence scoring and validation
- Memory lineage tracking

### Out of Scope
- Hierarchy creation (abstraction level promotion)
- Playbook integration

## Acceptance Criteria

- [ ] `PatternExtractor` implemented with:
  - Groups memories by semantic similarity (threshold: 0.85)
  - Groups by memory type for better extraction
  - Uses LLM to extract patterns from groups
  - Validates patterns (confidence > 0.7)
  - Creates ConsolidatedMemory with abstraction_level=2
  - Marks source memories as consolidated
- [ ] `MemoryMerger` implemented with:
  - Finds memory pairs with similarity > 0.95
  - Merges into ConsolidatedMemory with abstraction_level=1
  - Preserves unique information from all sources
  - Averages embeddings for merged memory
  - Marks source memories as consolidated
- [ ] Memory lineage:
  - ConsolidatedMemory.source_memory_ids populated
  - TaskMemory.consolidated_into_id set
  - TaskMemory.is_consolidated set to True
- [ ] Performance:
  - Processes 1000 memories in <2 minutes
  - Efficient similarity calculation using vector indices
- [ ] All tests pass

## Technical Notes

**File Locations**:
- Pattern Extractor: `backend/omoi_os/services/consolidation/pattern_extractor.py`
- Memory Merger: `backend/omoi_os/services/consolidation/memory_merger.py`
- Schemas: `backend/omoi_os/schemas/consolidation.py`

**Key Considerations**:
- Use hierarchical clustering for grouping (O(n²) but acceptable for batch processing)
- Batch LLM calls for efficiency (process multiple groups in parallel)
- Reuse existing EmbeddingService for similarity calculations
- Use existing LLMService for pattern extraction

**Pattern Extraction Algorithm**:
1. Fetch unconsolidated memories with embeddings
2. Group by memory_type
3. Within each type, group by similarity (threshold: 0.85)
4. For groups with ≥3 memories:
   - Extract pattern using LLM
   - Validate confidence score
   - Create ConsolidatedMemory (abstraction_level=2)
   - Mark sources as consolidated

**Memory Merging Algorithm**:
1. Fetch unconsolidated memories with embeddings
2. For each memory, find similar ones (threshold: 0.95)
3. If similar group found:
   - Merge content (combine unique information)
   - Average embeddings
   - Create ConsolidatedMemory (abstraction_level=1)
   - Mark sources as consolidated

**LLM Prompt Template**:
```
Analyze these task execution summaries and extract a recurring pattern:

{summaries}

Extract a pattern that:
1. Captures the common approach or lesson
2. Is generalizable to similar situations
3. Provides actionable guidance

Classify the pattern type as: success, failure, decision, workflow, or gotcha.
Provide a confidence score (0-1) for how well this pattern represents the summaries.
```

## Tasks

- TSK-014: Create consolidation schemas (PatternExtractionOutput, etc.)
- TSK-015: Implement PatternExtractor with similarity grouping
- TSK-016: Implement LLM-based pattern extraction
- TSK-017: Implement MemoryMerger with similarity detection
- TSK-018: Implement memory content merging logic
- TSK-019: Add memory lineage tracking
- TSK-020: Write unit tests for PatternExtractor
- TSK-021: Write unit tests for MemoryMerger
- TSK-022: Write integration tests for consolidation phases

## Dependencies

**Blocked By**:
- TKT-001 (Database models must exist)
- TKT-002 (Engine orchestrates these phases)

**Blocks**: TKT-004 (Hierarchy Creator uses extracted patterns)

## Estimate

**Size**: XL (8-16 hours)
**Rationale**: Complex similarity algorithms, LLM integration, clustering logic, and comprehensive testing.
