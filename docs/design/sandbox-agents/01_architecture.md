# Sandbox Agent Architecture

**Created**: 2025-12-12  
**Updated**: 2025-12-12  
**Status**: Design Document  
**Purpose**: Comprehensive architecture for spawning AI agents in sandboxed environments with real-time bidirectional communication

---

> **ğŸ‰ UPDATE (2025-12-12)**: Upon further codebase analysis, we discovered that **most of the WebSocket infrastructure already exists!**
> 
> **What's already built:**
> - âœ… `/api/v1/ws/events` WebSocket endpoint with filters
> - âœ… `WebSocketEventManager` with Redis pub/sub bridge
> - âœ… Frontend hooks: `useEvents()`, `useEntityEvents()`, `WebSocketProvider`
> - âœ… Full test coverage
>
> **What we actually need to build:**
> - âŒ Sandbox event callback endpoint (~2-3 hours)
> - âŒ Message injection endpoints (~4-6 hours)  
> - âŒ Worker script updates (~4 hours)
>
> **See [Sandbox System Gap Analysis](./sandbox_system_gap_analysis.md) for the revised implementation plan.**

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [High-Level Architecture](#high-level-architecture)
3. [Component Deep-Dive](#component-deep-dive)
4. [Database Schema](#database-schema)
5. [API Endpoints](#api-endpoints)
6. [WebSocket Communication](#websocket-communication)
7. [Event Flow Diagrams](#event-flow-diagrams)
8. [SDK Comparison](#sdk-comparison)
9. [Implementation Plan](#implementation-plan)

---

## Executive Summary

This document describes the architecture for spawning AI coding agents (using **Claude Agent SDK** or **OpenHands SDK**) inside isolated **Daytona Cloud sandboxes**, with **real-time bidirectional communication** via WebSockets that allows users to:

1. **See what's happening inside sandboxes** (file changes, commands, agent thoughts)
2. **Control conversations** (send messages, interrupt, provide guidance)
3. **Monitor progress** (task status, cost tracking, tool usage)
4. **Observe Guardian interventions** (when agents get stuck or drift)

---

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   USER LAYER                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         Next.js Frontend                                â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚ Agent Spawn  â”‚  â”‚ Sandbox View â”‚  â”‚ Conversation â”‚  â”‚  Terminal  â”‚  â”‚   â”‚
â”‚   â”‚  â”‚    Panel     â”‚  â”‚   Monitor    â”‚  â”‚   Control    â”‚  â”‚   Output   â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚         â”‚                 â”‚                 â”‚                â”‚         â”‚   â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚   â”‚                                    â”‚                                    â”‚   â”‚
â”‚   â”‚                              WebSocket + REST                           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               ORCHESTRATION LAYER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        FastAPI Backend                                  â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚  Sandbox     â”‚  â”‚  WebSocket   â”‚  â”‚   Guardian   â”‚  â”‚   Event    â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  Spawner     â”‚  â”‚   Manager    â”‚  â”‚   Service    â”‚  â”‚    Bus     â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  Service     â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  (Redis)   â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚         â”‚                 â”‚                 â”‚                â”‚         â”‚   â”‚
â”‚   â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚   â”‚         â”‚    â”‚                                                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚                    Sandbox Session Manager                        â”‚  â”‚   â”‚
â”‚   â”‚  â”‚                                                                   â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Tracks active sandboxes (sandbox_id â†’ connection info)        â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Routes WebSocket messages to/from sandboxes                   â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Manages conversation state                                     â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Buffers events for reconnection                               â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                                  â”‚                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚                          Daytona API â”‚ + HTTP Callbacks                         â”‚
â”‚                                      â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               EXECUTION LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      Daytona Cloud Sandbox                              â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚                   Agent Runtime (Choice)                         â”‚   â”‚   â”‚
â”‚   â”‚  â”‚                                                                  â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    OR    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â”‚  Claude Agent SDK   â”‚          â”‚   OpenHands SDK      â”‚      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â”‚                     â”‚          â”‚                      â”‚      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â”‚ â€¢ ClaudeSDKClient   â”‚          â”‚ â€¢ LocalConversation  â”‚      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â”‚ â€¢ @tool decorator   â”‚          â”‚ â€¢ Agent + Workspace  â”‚      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â”‚ â€¢ Pre/PostToolUse   â”‚          â”‚ â€¢ Event Callbacks    â”‚      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â”‚ â€¢ Streaming msgs    â”‚          â”‚ â€¢ Tool Registry      â”‚      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚              â”‚                                â”‚                  â”‚   â”‚   â”‚
â”‚   â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚   â”‚
â”‚   â”‚  â”‚                               â”‚                                  â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                                  â”‚                                      â”‚   â”‚
â”‚   â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚   â”‚                    â”‚     Sandbox Worker        â”‚                        â”‚   â”‚
â”‚   â”‚                    â”‚                           â”‚                        â”‚   â”‚
â”‚   â”‚                    â”‚  â€¢ Fetches task from API  â”‚                        â”‚   â”‚
â”‚   â”‚                    â”‚  â€¢ Runs agent loop        â”‚                        â”‚   â”‚
â”‚   â”‚                    â”‚  â€¢ Reports events (HTTP)  â”‚                        â”‚   â”‚
â”‚   â”‚                    â”‚  â€¢ Receives messages      â”‚                        â”‚   â”‚
â”‚   â”‚                    â”‚  â€¢ Sends heartbeats       â”‚                        â”‚   â”‚
â”‚   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚   â”‚                                  â”‚                                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚                    Sandbox Filesystem                             â”‚  â”‚   â”‚
â”‚   â”‚  â”‚                                                                   â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  /workspace/        â† Agent working directory                     â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  /tmp/worker.log    â† Agent logs                                  â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  /tmp/events/       â† Buffered events (if connection lost)        â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Deep-Dive

### 1. Sandbox Session Manager

The **SandboxSessionManager** is the central hub that maintains live connections to sandboxes:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Sandbox Session Manager                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  In-Memory State:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  sessions: Dict[sandbox_id, SandboxSession]                          â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  SandboxSession:                                                      â”‚  â”‚
â”‚  â”‚    â”œâ”€ sandbox_id: str                                                â”‚  â”‚
â”‚  â”‚    â”œâ”€ task_id: str                                                   â”‚  â”‚
â”‚  â”‚    â”œâ”€ agent_id: str                                                  â”‚  â”‚
â”‚  â”‚    â”œâ”€ conversation_id: str                                           â”‚  â”‚
â”‚  â”‚    â”œâ”€ status: "creating" | "running" | "paused" | "completed"        â”‚  â”‚
â”‚  â”‚    â”œâ”€ created_at: datetime                                           â”‚  â”‚
â”‚  â”‚    â”œâ”€ last_event_at: datetime                                        â”‚  â”‚
â”‚  â”‚    â”œâ”€ event_buffer: List[SandboxEvent]  (for reconnection)           â”‚  â”‚
â”‚  â”‚    â”œâ”€ connected_clients: Set[WebSocket] (frontend connections)       â”‚  â”‚
â”‚  â”‚    â””â”€ daytona_sandbox: DaytonaSandbox  (API handle)                  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  WebSocket Subscriptions:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  ws_connections: Dict[user_id, Set[WebSocket]]                       â”‚  â”‚
â”‚  â”‚  sandbox_subscriptions: Dict[sandbox_id, Set[WebSocket]]             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Event Types

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Sandbox Event Types                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  FROM SANDBOX â†’ SERVER â†’ FRONTEND:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  agent.started        - Agent began processing task                   â”‚  â”‚
â”‚  â”‚  agent.thinking       - Agent reasoning (extended thinking block)     â”‚  â”‚
â”‚  â”‚  agent.message        - Agent produced text response                  â”‚  â”‚
â”‚  â”‚  agent.tool_use       - Agent using a tool                           â”‚  â”‚
â”‚  â”‚  agent.tool_result    - Tool execution result                        â”‚  â”‚
â”‚  â”‚  agent.completed      - Agent finished task                          â”‚  â”‚
â”‚  â”‚  agent.error          - Agent encountered error                      â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  file.created         - New file created in workspace                â”‚  â”‚
â”‚  â”‚  file.modified        - File content changed                         â”‚  â”‚
â”‚  â”‚  file.deleted         - File removed                                 â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  command.started      - Shell command began                          â”‚  â”‚
â”‚  â”‚  command.output       - Command stdout/stderr (streaming)            â”‚  â”‚
â”‚  â”‚  command.completed    - Command finished with exit code              â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  sandbox.heartbeat    - Health check                                 â”‚  â”‚
â”‚  â”‚  sandbox.metrics      - Cost, tokens, duration                       â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  FROM FRONTEND â†’ SERVER â†’ SANDBOX:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  user.message         - User sends message to agent                  â”‚  â”‚
â”‚  â”‚  user.interrupt       - Stop current operation                       â”‚  â”‚
â”‚  â”‚  user.guidance        - Provide hint/direction                       â”‚  â”‚
â”‚  â”‚  user.approve         - Approve pending action                       â”‚  â”‚
â”‚  â”‚  user.reject          - Reject pending action                        â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  guardian.intervention - Guardian sends steering message             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema

### New Tables

```sql
-- Tracks sandbox instances
CREATE TABLE sandbox_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sandbox_id VARCHAR(255) UNIQUE NOT NULL,
    task_id UUID REFERENCES tasks(id),
    agent_id UUID REFERENCES agents(id),
    conversation_id VARCHAR(255),
    
    -- Runtime configuration
    runtime VARCHAR(50) NOT NULL DEFAULT 'openhands',  -- 'openhands' | 'claude'
    status VARCHAR(50) NOT NULL DEFAULT 'creating',    -- creating | running | paused | completed | failed | terminated
    
    -- Daytona metadata
    daytona_sandbox_id VARCHAR(255),
    preview_url VARCHAR(512),
    
    -- Timing
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    last_heartbeat_at TIMESTAMP WITH TIME ZONE,
    
    -- Metrics
    total_cost_usd DECIMAL(10, 6) DEFAULT 0,
    total_tokens INTEGER DEFAULT 0,
    tool_calls_count INTEGER DEFAULT 0,
    
    -- Error handling
    error_message TEXT,
    retry_count INTEGER DEFAULT 0
);

-- Stores events from sandboxes for audit/replay
CREATE TABLE sandbox_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sandbox_id VARCHAR(255) NOT NULL REFERENCES sandbox_sessions(sandbox_id),
    
    -- Event details
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB NOT NULL,
    
    -- Source
    source VARCHAR(50) NOT NULL,  -- 'agent' | 'user' | 'guardian' | 'system'
    
    -- Timing
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Indexing
    sequence_number SERIAL
);

-- Index for fast event retrieval
CREATE INDEX idx_sandbox_events_sandbox_id ON sandbox_events(sandbox_id);
CREATE INDEX idx_sandbox_events_created_at ON sandbox_events(created_at);
CREATE INDEX idx_sandbox_events_type ON sandbox_events(event_type);

-- Stores file snapshots for "see what's inside sandbox"
CREATE TABLE sandbox_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sandbox_id VARCHAR(255) NOT NULL REFERENCES sandbox_sessions(sandbox_id),
    
    file_path VARCHAR(1024) NOT NULL,
    file_content TEXT,
    file_size_bytes INTEGER,
    file_hash VARCHAR(64),  -- SHA-256 for change detection
    
    -- Metadata
    is_directory BOOLEAN DEFAULT FALSE,
    last_modified_at TIMESTAMP WITH TIME ZONE,
    
    -- Snapshotting
    snapshot_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(sandbox_id, file_path, snapshot_at)
);

-- Active WebSocket connections (for multi-server scaling)
CREATE TABLE sandbox_ws_connections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sandbox_id VARCHAR(255) NOT NULL REFERENCES sandbox_sessions(sandbox_id),
    user_id UUID REFERENCES users(id),
    
    -- Connection metadata
    connection_id VARCHAR(255) NOT NULL,
    server_instance VARCHAR(255),  -- For load balancing
    connected_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_ping_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     tasks       â”‚       â”‚     agents      â”‚       â”‚     users       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ description     â”‚       â”‚ agent_type      â”‚       â”‚ email           â”‚
â”‚ phase_id        â”‚       â”‚ status          â”‚       â”‚ ...             â”‚
â”‚ status          â”‚       â”‚ ...             â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
         â”‚                         â”‚                         â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚    â”‚
         â–¼    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        sandbox_sessions                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                                                             â”‚
â”‚ sandbox_id (UNIQUE)                                                 â”‚
â”‚ task_id (FK â†’ tasks)                                                â”‚
â”‚ agent_id (FK â†’ agents)                                              â”‚
â”‚ conversation_id                                                     â”‚
â”‚ runtime ('openhands' | 'claude')                                    â”‚
â”‚ status                                                              â”‚
â”‚ daytona_sandbox_id                                                  â”‚
â”‚ preview_url                                                         â”‚
â”‚ total_cost_usd, total_tokens, tool_calls_count                      â”‚
â”‚ created_at, started_at, completed_at, last_heartbeat_at             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                  â”‚                  â”‚
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sandbox_events  â”‚  â”‚ sandbox_files   â”‚  â”‚ sandbox_ws_connections  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚  â”‚ id (PK)         â”‚  â”‚ id (PK)                 â”‚
â”‚ sandbox_id (FK) â”‚  â”‚ sandbox_id (FK) â”‚  â”‚ sandbox_id (FK)         â”‚
â”‚ event_type      â”‚  â”‚ file_path       â”‚  â”‚ user_id (FK)            â”‚
â”‚ event_data      â”‚  â”‚ file_content    â”‚  â”‚ connection_id           â”‚
â”‚ source          â”‚  â”‚ file_hash       â”‚  â”‚ server_instance         â”‚
â”‚ created_at      â”‚  â”‚ snapshot_at     â”‚  â”‚ connected_at            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Endpoints

### Sandbox Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Sandbox API Endpoints                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  POST /api/v1/sandboxes                                                     â”‚
â”‚  â”œâ”€ Description: Spawn a new sandbox for a task                            â”‚
â”‚  â”œâ”€ Body: {                                                                 â”‚
â”‚  â”‚     task_id: string,                                                    â”‚
â”‚  â”‚     runtime: "openhands" | "claude",                                    â”‚
â”‚  â”‚     agent_type?: string,                                                â”‚
â”‚  â”‚     env?: Record<string, string>                                        â”‚
â”‚  â”‚  }                                                                       â”‚
â”‚  â””â”€ Response: { sandbox_id, status, preview_url }                          â”‚
â”‚                                                                             â”‚
â”‚  GET /api/v1/sandboxes                                                      â”‚
â”‚  â”œâ”€ Description: List all active sandboxes                                 â”‚
â”‚  â”œâ”€ Query: ?status=running&task_id=xxx                                     â”‚
â”‚  â””â”€ Response: { sandboxes: SandboxSession[] }                              â”‚
â”‚                                                                             â”‚
â”‚  GET /api/v1/sandboxes/{sandbox_id}                                         â”‚
â”‚  â”œâ”€ Description: Get sandbox details                                       â”‚
â”‚  â””â”€ Response: { sandbox: SandboxSession, recent_events: Event[] }          â”‚
â”‚                                                                             â”‚
â”‚  DELETE /api/v1/sandboxes/{sandbox_id}                                      â”‚
â”‚  â”œâ”€ Description: Terminate a sandbox                                       â”‚
â”‚  â””â”€ Response: { status: "terminated" }                                     â”‚
â”‚                                                                             â”‚
â”‚  POST /api/v1/sandboxes/{sandbox_id}/pause                                  â”‚
â”‚  â”œâ”€ Description: Pause agent execution                                     â”‚
â”‚  â””â”€ Response: { status: "paused" }                                         â”‚
â”‚                                                                             â”‚
â”‚  POST /api/v1/sandboxes/{sandbox_id}/resume                                 â”‚
â”‚  â”œâ”€ Description: Resume paused agent                                       â”‚
â”‚  â””â”€ Response: { status: "running" }                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sandbox Events & Files

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Sandbox Events & Files Endpoints                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  GET /api/v1/sandboxes/{sandbox_id}/events                                  â”‚
â”‚  â”œâ”€ Description: Get historical events                                     â”‚
â”‚  â”œâ”€ Query: ?limit=50&since=timestamp&type=agent.tool_use                   â”‚
â”‚  â””â”€ Response: { events: SandboxEvent[] }                                   â”‚
â”‚                                                                             â”‚
â”‚  POST /api/v1/sandboxes/{sandbox_id}/events                                 â”‚
â”‚  â”œâ”€ Description: Send event to sandbox (user message, interrupt)           â”‚
â”‚  â”œâ”€ Body: {                                                                 â”‚
â”‚  â”‚     event_type: "user.message" | "user.interrupt" | ...,                â”‚
â”‚  â”‚     event_data: { content: string, ... }                                â”‚
â”‚  â”‚  }                                                                       â”‚
â”‚  â””â”€ Response: { event_id, status }                                         â”‚
â”‚                                                                             â”‚
â”‚  GET /api/v1/sandboxes/{sandbox_id}/files                                   â”‚
â”‚  â”œâ”€ Description: List files in sandbox workspace                           â”‚
â”‚  â”œâ”€ Query: ?path=/workspace&recursive=true                                 â”‚
â”‚  â””â”€ Response: { files: FileInfo[] }                                        â”‚
â”‚                                                                             â”‚
â”‚  GET /api/v1/sandboxes/{sandbox_id}/files/{path}                            â”‚
â”‚  â”œâ”€ Description: Get file content                                          â”‚
â”‚  â””â”€ Response: { content: string, size: number, hash: string }              â”‚
â”‚                                                                             â”‚
â”‚  GET /api/v1/sandboxes/{sandbox_id}/terminal                                â”‚
â”‚  â”œâ”€ Description: Get recent terminal output                                â”‚
â”‚  â”œâ”€ Query: ?lines=100                                                      â”‚
â”‚  â””â”€ Response: { output: string, timestamp: string }                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## WebSocket Communication

### WebSocket Endpoint

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WebSocket Architecture                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Endpoint: ws://api.omoios.dev/ws/sandboxes/{sandbox_id}                   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Connection Lifecycle                            â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  1. Client connects with JWT token in query param:                  â”‚   â”‚
â”‚  â”‚     ws://api.omoios.dev/ws/sandboxes/sb-123?token=eyJ...            â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  2. Server authenticates, subscribes to sandbox events              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  3. Server sends buffered events (if reconnecting)                  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  4. Bidirectional messages flow                                     â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  5. Heartbeat every 30s to keep alive                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Message Format                                 â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Server â†’ Client:                                                   â”‚   â”‚
â”‚  â”‚  {                                                                  â”‚   â”‚
â”‚  â”‚    "type": "event",                                                 â”‚   â”‚
â”‚  â”‚    "event_type": "agent.tool_use",                                  â”‚   â”‚
â”‚  â”‚    "sandbox_id": "sb-123",                                          â”‚   â”‚
â”‚  â”‚    "timestamp": "2025-12-12T16:30:00Z",                             â”‚   â”‚
â”‚  â”‚    "data": {                                                        â”‚   â”‚
â”‚  â”‚      "tool_name": "Bash",                                           â”‚   â”‚
â”‚  â”‚      "tool_input": { "command": "npm install" },                    â”‚   â”‚
â”‚  â”‚      "status": "running"                                            â”‚   â”‚
â”‚  â”‚    }                                                                â”‚   â”‚
â”‚  â”‚  }                                                                  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Client â†’ Server:                                                   â”‚   â”‚
â”‚  â”‚  {                                                                  â”‚   â”‚
â”‚  â”‚    "type": "command",                                               â”‚   â”‚
â”‚  â”‚    "command": "send_message",                                       â”‚   â”‚
â”‚  â”‚    "payload": {                                                     â”‚   â”‚
â”‚  â”‚      "content": "Try using async/await instead"                     â”‚   â”‚
â”‚  â”‚    }                                                                â”‚   â”‚
â”‚  â”‚  }                                                                  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WebSocket Message Types

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WebSocket Server â†’ Client Messages                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  { type: "connected", sandbox_id, status, buffered_events_count }          â”‚
â”‚  { type: "event", event_type: "agent.*", data: {...} }                     â”‚
â”‚  { type: "event", event_type: "file.*", data: { path, action, diff } }     â”‚
â”‚  { type: "event", event_type: "command.*", data: { command, output } }     â”‚
â”‚  { type: "event", event_type: "sandbox.*", data: { metrics, status } }     â”‚
â”‚  { type: "heartbeat", timestamp }                                          â”‚
â”‚  { type: "error", code, message }                                          â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    WebSocket Client â†’ Server Messages                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  { type: "command", command: "send_message", payload: { content } }        â”‚
â”‚  { type: "command", command: "interrupt" }                                 â”‚
â”‚  { type: "command", command: "pause" }                                     â”‚
â”‚  { type: "command", command: "resume" }                                    â”‚
â”‚  { type: "command", command: "request_files", payload: { path } }          â”‚
â”‚  { type: "command", command: "request_terminal" }                          â”‚
â”‚  { type: "ping" }                                                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Event Flow Diagrams

### 1. Spawn Sandbox Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚      â”‚  API     â”‚      â”‚ Spawner  â”‚      â”‚ Daytona  â”‚      â”‚ Sandbox  â”‚
â”‚          â”‚      â”‚  Server  â”‚      â”‚ Service  â”‚      â”‚   API    â”‚      â”‚ Worker   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚ POST /sandboxes â”‚                 â”‚                 â”‚                 â”‚
     â”‚ {task_id, ...}  â”‚                 â”‚                 â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚ spawn_for_task()â”‚                 â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚ CREATE sandbox  â”‚                 â”‚
     â”‚                 â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚  sandbox_id +   â”‚                 â”‚
     â”‚                 â”‚                 â”‚  preview_url    â”‚                 â”‚
     â”‚                 â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚           Upload worker script    â”‚
     â”‚                 â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚           Set env vars + start    â”‚
     â”‚                 â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚  sandbox_id     â”‚                 â”‚                 â”‚
     â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚ {sandbox_id,    â”‚                 â”‚                 â”‚                 â”‚
     â”‚  status,        â”‚                 â”‚                 â”‚                 â”‚
     â”‚  preview_url}   â”‚                 â”‚                 â”‚                 â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚   Worker boots  â”‚
     â”‚                 â”‚                 â”‚                 â”‚   & registers   â”‚
     â”‚                 â”‚                 â”‚   â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
     â”‚ WS: connected   â”‚ Event: sandbox.started           â”‚                 â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚                 â”‚
```

### 2. Real-Time Event Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚      â”‚    WS    â”‚      â”‚  Event   â”‚      â”‚ Sandbox  â”‚
â”‚          â”‚      â”‚ Manager  â”‚      â”‚   Bus    â”‚      â”‚ Worker   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚  Agent uses     â”‚
     â”‚                 â”‚                 â”‚  Bash tool      â”‚
     â”‚                 â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚  Publish:       â”‚                 â”‚
     â”‚                 â”‚  agent.tool_use â”‚                 â”‚
     â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ WS Event:       â”‚                 â”‚                 â”‚
     â”‚ {type: "event", â”‚                 â”‚                 â”‚
     â”‚  event_type:    â”‚                 â”‚                 â”‚
     â”‚  "agent.tool_use"â”‚                â”‚                 â”‚
     â”‚  data: {...}}   â”‚                 â”‚                 â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ UI Updates:     â”‚                 â”‚                 â”‚
     â”‚ - Tool panel    â”‚                 â”‚                 â”‚
     â”‚ - Activity log  â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚  Command output â”‚
     â”‚                 â”‚                 â”‚  (streaming)    â”‚
     â”‚                 â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ WS: command.output               â”‚                 â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ Terminal view   â”‚                 â”‚                 â”‚
     â”‚ updates live    â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
```

### 3. User Sends Message to Agent

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚      â”‚    WS    â”‚      â”‚ Sandbox  â”‚      â”‚  Agent   â”‚
â”‚          â”‚      â”‚ Manager  â”‚      â”‚ Worker   â”‚      â”‚ Runtime  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ WS: {type:      â”‚                 â”‚                 â”‚
     â”‚  "command",     â”‚                 â”‚                 â”‚
     â”‚  command:       â”‚                 â”‚                 â”‚
     â”‚  "send_message" â”‚                 â”‚                 â”‚
     â”‚  payload: {...}}â”‚                 â”‚                 â”‚
     â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚ HTTP POST       â”‚                 â”‚
     â”‚                 â”‚ /sandbox-input  â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚ Inject into     â”‚
     â”‚                 â”‚                 â”‚ conversation    â”‚
     â”‚                 â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚ Agent
     â”‚                 â”‚                 â”‚                 â”‚ responds
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚ agent.message   â”‚
     â”‚                 â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ WS: agent.message                â”‚                 â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
```

### 4. Guardian Intervention Flow

> **âš ï¸ IMPORTANT**: The Guardian has TWO intervention paths depending on agent execution mode:
> - **Sandbox Mode**: Uses HTTP message injection API
> - **Legacy Mode**: Uses local filesystem via `ConversationInterventionService`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GUARDIAN INTERVENTION FLOW (UPDATED)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Guardian Service                                                           â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚ Monitoring loop detects:                                           â”‚
â”‚       â”‚ - Agent drift                                                      â”‚
â”‚       â”‚ - Stuck state                                                      â”‚
â”‚       â”‚ - Off-track trajectory                                             â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  execute_steering_intervention(intervention, task)                  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚       â”‚   Is task.sandbox_id present?                         â”‚    â”‚   â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                           â”‚                                        â”‚   â”‚
â”‚  â”‚              YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€ NO                            â”‚   â”‚
â”‚  â”‚                           â”‚                                        â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚  â”‚    â”‚                      â”‚                      â”‚                 â”‚   â”‚
â”‚  â”‚    â–¼                      â”‚                      â–¼                 â”‚   â”‚
â”‚  â”‚  SANDBOX PATH             â”‚             LEGACY PATH                â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚   â”‚
â”‚  â”‚  POST /api/v1/sandboxes   â”‚             ConversationIntervention   â”‚   â”‚
â”‚  â”‚    /{sandbox_id}/messages â”‚             Service.send_intervention() â”‚   â”‚
â”‚  â”‚                           â”‚                      â”‚                 â”‚   â”‚
â”‚  â”‚  Body:                    â”‚             Uses:                      â”‚   â”‚
â”‚  â”‚  {                        â”‚             - task.conversation_id     â”‚   â”‚
â”‚  â”‚    "content": "...",      â”‚             - task.persistence_dir     â”‚   â”‚
â”‚  â”‚    "message_type":        â”‚               (LOCAL filesystem)       â”‚   â”‚
â”‚  â”‚      "guardian_           â”‚                      â”‚                 â”‚   â”‚
â”‚  â”‚       intervention"       â”‚                      â”‚                 â”‚   â”‚
â”‚  â”‚  }                        â”‚                      â”‚                 â”‚   â”‚
â”‚  â”‚         â”‚                 â”‚                      â”‚                 â”‚   â”‚
â”‚  â”‚         â–¼                 â”‚                      â–¼                 â”‚   â”‚
â”‚  â”‚  Worker polls             â”‚             OpenHands Conversation     â”‚   â”‚
â”‚  â”‚  GET /messages            â”‚             object loads state         â”‚   â”‚
â”‚  â”‚  and receives it          â”‚             and injects message        â”‚   â”‚
â”‚  â”‚                           â”‚                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  BOTH PATHS:                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  â€¢ Agent receives intervention message                                     â”‚
â”‚  â€¢ Agent course-corrects behavior                                         â”‚
â”‚  â€¢ Event published for frontend visibility                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Sequence Diagram (Sandbox Mode)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Guardian â”‚      â”‚  HTTP    â”‚      â”‚ Sandbox  â”‚      â”‚  Agent   â”‚
â”‚ Service  â”‚      â”‚   API    â”‚      â”‚ Worker   â”‚      â”‚ Runtime  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ Monitoring loop â”‚                 â”‚                 â”‚
     â”‚ detects drift   â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ _is_sandbox_task() â†’ TRUE        â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚ POST /sandboxes/{id}/messages    â”‚                 â”‚
     â”‚ {type: "guardian_intervention"}  â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚ Queue message   â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚ Poll GET        â”‚
     â”‚                 â”‚                 â”‚ /messages       â”‚
     â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚ Return messages â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚ Inject as       â”‚
     â”‚                 â”‚                 â”‚ system msg      â”‚
     â”‚                 â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚ Agent
     â”‚                 â”‚                 â”‚                 â”‚ course-
     â”‚                 â”‚                 â”‚                 â”‚ corrects
     â”‚                 â”‚                 â”‚                 â”‚
```

### 5. Hook-Based Intervention Architecture

> **ğŸš€ Performance Enhancement**: This pattern reduces intervention latency from seconds to milliseconds.

**Current (Polling-Based) vs. Proposed (Hook-Based):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             INTERVENTION INJECTION: POLLING vs HOOK-BASED                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  POLLING-BASED (Current):                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  Guardian enqueues â†’ Worker finishes turn â†’ Polls â†’ Gets message â†’ Injects â”‚
â”‚                                          â†‘                                   â”‚
â”‚                                   DELAY (seconds)                           â”‚
â”‚                                                                             â”‚
â”‚  HOOK-BASED (Proposed):                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚  Guardian enqueues â†’ PreToolUse fires â†’ Check queue â†’ Inject immediately   â”‚
â”‚                                       â†‘                                      â”‚
â”‚                                INSTANT (<100ms)                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**SDK-Specific Implementation:**

| SDK | Hook Mechanism | Latency | Control Level |
|-----|----------------|---------|---------------|
| Claude Agent SDK | `PreToolUse` hook | <1ms | Full (can block/modify) |
| OpenHands SDK | Event callback (ActionEvent) | <100ms | Moderate (inject message) |

**Worker Script Hook Pattern (Claude SDK):**

```python
# Intervention check hook - fires BEFORE every tool execution
async def check_pending_interventions(input_data, tool_use_id, context):
    intervention = await fetch_next_intervention()
    if intervention:
        return {
            "reason": intervention["message"],  # Feedback for Claude
            "systemMessage": f"[{intervention['source'].upper()}] {intervention['message']}",
        }
    return {}

options = ClaudeAgentOptions(
    hooks={
        "PreToolUse": [HookMatcher(matcher="*", hooks=[check_pending_interventions])],
    },
)
```

**Worker Script Hook Pattern (OpenHands SDK):**

```python
# Enhanced callback with intervention injection
def on_event_with_intervention(event):
    if "Action" in type(event).__name__:
        intervention = fetch_next_intervention_sync()
        if intervention:
            conversation.send_message(
                f"[{intervention['source'].upper()} INTERVENTION] {intervention['message']}"
            )
    # Original event reporting continues...
```

---

## SDK Comparison

> **SDK Documentation References:**
> - **Claude Agent SDK**: `docs/libraries/claude-agent-sdk-python-clean.md`
>   - GitHub: https://github.com/anthropics/claude-agent-sdk-python
> - **OpenHands SDK**: `docs/libraries/software-agent-sdk-clean.md`
>   - GitHub: https://github.com/OpenHands/software-agent-sdk

### Claude Agent SDK vs OpenHands SDK

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SDK Feature Comparison                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       Claude Agent SDK        â”‚         OpenHands SDK                 â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â”‚  ARCHITECTURE:                â”‚  ARCHITECTURE:                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ClaudeSDKClient         â”‚  â”‚  â”‚ Conversation                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€ Claude CLI        â”‚  â”‚  â”‚   â”œâ”€â”€ Agent                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       â””â”€â”€ Tool Use      â”‚  â”‚  â”‚   â”‚     â””â”€â”€ LLM (separate!)     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”œâ”€â”€ Workspace                 â”‚  â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚   â””â”€â”€ Tools[...]                â”‚  â”‚  â”‚
â”‚  â”‚                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â”‚  STREAMING:                   â”‚  STREAMING:                           â”‚  â”‚
â”‚  â”‚  â€¢ async for in receive_*()   â”‚  â€¢ callbacks=[fn]                     â”‚  â”‚
â”‚  â”‚  â€¢ StreamEvent messages       â”‚  â€¢ WebSocket /events/socket           â”‚  â”‚
â”‚  â”‚  â€¢ Partial message updates    â”‚  â€¢ Event handlers                     â”‚  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â”‚  HOOKS:                       â”‚  HOOKS:                               â”‚  â”‚
â”‚  â”‚  â€¢ PreToolUse                 â”‚  â€¢ callbacks=[fn]                     â”‚  â”‚
â”‚  â”‚  â€¢ PostToolUse                â”‚  â€¢ Event handlers                     â”‚  â”‚
â”‚  â”‚  â€¢ can_use_tool callback      â”‚                                       â”‚  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â”‚  TOOLS:                       â”‚  TOOLS:                               â”‚  â”‚
â”‚  â”‚  â€¢ @tool decorator            â”‚  â€¢ Tool(name=ToolName.name)           â”‚  â”‚
â”‚  â”‚  â€¢ create_sdk_mcp_server()    â”‚  â€¢ TerminalTool, FileEditorTool       â”‚  â”‚
â”‚  â”‚  â€¢ mcp_servers={} option      â”‚  â€¢ TaskTrackerTool                    â”‚  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â”‚  CONVERSATION CONTROL:        â”‚  CONVERSATION CONTROL:                â”‚  â”‚
â”‚  â”‚  â€¢ client.query()             â”‚  â€¢ conversation.send_message()        â”‚  â”‚
â”‚  â”‚  â€¢ client.interrupt()         â”‚  â€¢ conversation.run()                 â”‚  â”‚
â”‚  â”‚  â€¢ Multi-turn sessions        â”‚  â€¢ REST API + WebSocket               â”‚  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â”‚  COST TRACKING:               â”‚  COST TRACKING:                       â”‚  â”‚
â”‚  â”‚  â€¢ max_budget_usd option      â”‚  â€¢ llm.metrics.accumulated_cost       â”‚  â”‚
â”‚  â”‚  â€¢ ResultMessage.total_cost   â”‚  â€¢ llm.metrics.accumulated_tokens     â”‚  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â”‚  SETUP:                       â”‚  SETUP:                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ options = ClaudeAgent   â”‚  â”‚  â”‚ llm = LLM(model=..., api_key=.) â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Options(...)          â”‚  â”‚  â”‚ agent = Agent(llm=llm,          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ client = ClaudeSDK      â”‚  â”‚  â”‚               tools=[...])      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Client(options)       â”‚  â”‚  â”‚ conv = Conversation(agent,      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ client.query(prompt)    â”‚  â”‚  â”‚               workspace="/w")   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                               â”‚                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  RECOMMENDATION:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Use CLAUDE AGENT SDK when:                                         â”‚   â”‚
â”‚  â”‚  â€¢ You want simpler architecture (fewer layers)                     â”‚   â”‚
â”‚  â”‚  â€¢ You need native Claude tool_use                                  â”‚   â”‚
â”‚  â”‚  â€¢ You want fine-grained hook control                              â”‚   â”‚
â”‚  â”‚  â€¢ MCP server integration is important                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Use OPENHANDS SDK when:                                            â”‚   â”‚
â”‚  â”‚  â€¢ You need the rich tool ecosystem (file_editor, terminal)         â”‚   â”‚
â”‚  â”‚  â€¢ You want built-in workspace isolation                            â”‚   â”‚
â”‚  â”‚  â€¢ You need the Agent Server with WebSocket support                 â”‚   â”‚
â”‚  â”‚  â€¢ You're building a code-generation focused system                 â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  FOR OMOIOS: Support BOTH with runtime selection                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Plan

> **âš ï¸ REVISED**: The original 4-week plan has been significantly reduced since we discovered 
> the existing WebSocket infrastructure. See [Gap Analysis](./sandbox_system_gap_analysis.md) for details.

### ~~Phase 1: Core Infrastructure (Week 1)~~ â†’ Mostly Exists!

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 1: REVISED - Minimal New Work                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âœ… ALREADY EXISTS:                                                         â”‚
â”‚      âœ“ DaytonaSpawnerService with in-memory tracking                       â”‚
â”‚      âœ“ EventBusService with Redis pub/sub                                  â”‚
â”‚      âœ“ WebSocketEventManager with filters                                  â”‚
â”‚                                                                             â”‚
â”‚  âŒ STILL NEEDED (2-3 hours):                                               â”‚
â”‚      â–¡ POST /api/v1/sandboxes/{id}/events (event callback)                 â”‚
â”‚                                                                             â”‚
â”‚  â³ OPTIONAL (can defer):                                                   â”‚
â”‚      â–¡ Database persistence for sandbox_sessions                           â”‚
â”‚      â–¡ Database persistence for sandbox_events (audit trail)               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ~~Phase 2: WebSocket Layer (Week 2)~~ â†’ Already Exists!

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Phase 2: NOTHING TO BUILD!                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âœ… ALREADY EXISTS in backend/omoi_os/api/routes/events.py:                 â”‚
â”‚      âœ“ WebSocket endpoint: /api/v1/ws/events                               â”‚
â”‚      âœ“ WebSocketEventManager class                                         â”‚
â”‚      âœ“ Redis Pub/Sub listener (pattern: events.*)                          â”‚
â”‚      âœ“ Filter by event_types, entity_types, entity_ids                     â”‚
â”‚      âœ“ Dynamic subscription via WebSocket messages                         â”‚
â”‚      âœ“ Ping/keepalive every 30s                                            â”‚
â”‚                                                                             â”‚
â”‚  âœ… ALREADY EXISTS in frontend/hooks/useEvents.ts:                          â”‚
â”‚      âœ“ useEvents() hook with filters                                       â”‚
â”‚      âœ“ useEntityEvents(entityType, entityId) hook                          â”‚
â”‚      âœ“ useEventTypes(eventTypes) hook                                      â”‚
â”‚      âœ“ Auto-reconnection                                                   â”‚
â”‚      âœ“ Event buffer (max 100)                                              â”‚
â”‚                                                                             â”‚
â”‚  âœ… ALREADY EXISTS in frontend/providers/WebSocketProvider.tsx:             â”‚
â”‚      âœ“ WebSocketProvider context                                           â”‚
â”‚      âœ“ useWebSocket() hook                                                 â”‚
â”‚      âœ“ Reconnection with backoff                                           â”‚
â”‚                                                                             â”‚
â”‚  HOW TO USE:                                                                â”‚
â”‚      Backend: event_bus.publish(SystemEvent(                               â”‚
â”‚          entity_type="sandbox", entity_id=sandbox_id, ...                  â”‚
â”‚      ))                                                                     â”‚
â”‚      Frontend: useEntityEvents("sandbox", sandboxId)                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: Message Injection (4-6 hours)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Phase 3: Message Injection                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  3.1 Message Queue Endpoints (NEW)                                          â”‚
â”‚      â–¡ POST /api/v1/sandboxes/{id}/messages (queue message)                â”‚
â”‚      â–¡ GET /api/v1/sandboxes/{id}/messages (worker polls)                  â”‚
â”‚                                                                             â”‚
â”‚  3.2 Worker Polling                                                         â”‚
â”‚      â–¡ Worker polls for messages after each agent turn                     â”‚
â”‚      â–¡ Handle interrupt commands                                           â”‚
â”‚      â–¡ Inject user messages into conversation                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 4: Worker Script Updates (4 hours)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Phase 4: Worker Script Updates                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  4.1 Event Reporting                                                        â”‚
â”‚      â–¡ POST events to /sandboxes/{id}/events (not tasks endpoint)          â”‚
â”‚      â–¡ Report tool_use, thinking, message events                           â”‚
â”‚                                                                             â”‚
â”‚  4.2 Message Polling                                                        â”‚
â”‚      â–¡ Poll GET /sandboxes/{id}/messages after agent turns                 â”‚
â”‚      â–¡ Handle interrupt command                                            â”‚
â”‚      â–¡ Inject user messages into agent                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 5: Frontend UI (Optional - Separate Task)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Phase 5: Frontend UI (Optional)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Once the backend is working, frontend just uses existing hooks:            â”‚
â”‚                                                                             â”‚
â”‚  const { events } = useEntityEvents("sandbox", sandboxId)                  â”‚
â”‚                                                                             â”‚
â”‚  UI Components (can build incrementally):                                   â”‚
â”‚      â–¡ Real-time agent activity view                                        â”‚
â”‚      â–¡ Message input box                                                    â”‚
â”‚      â–¡ Interrupt button                                                     â”‚
â”‚      â–¡ File tree view (via sandbox API)                                    â”‚
â”‚      â–¡ Terminal output view                                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

This architecture enables:

1. **Real-time visibility** into sandbox agent execution via WebSockets
2. **Bidirectional control** - users can send messages, interrupt, guide agents
3. **SDK flexibility** - support both Claude Agent SDK and OpenHands SDK
4. **Scalability** - Redis Pub/Sub for multi-server deployments
5. **Audit trail** - all events stored in database for replay
6. **Guardian integration** - interventions flow through the same event system

### Revised Timeline

| Original Plan | Revised Plan |
|---------------|--------------|
| Phase 1: 1 week | ~~Exists~~ + 2-3 hours |
| Phase 2: 1 week | ~~Exists~~ (0 hours) |
| Phase 3: 1 week | 4-6 hours |
| Phase 4: 1 week | 4 hours |
| **Total: 4 weeks** | **Total: 14-19 hours** |

---

## Related Documents

- [**Sandbox System Gap Analysis**](./sandbox_system_gap_analysis.md) â† **Start here for implementation**
- [Product Vision](../product_vision.md)
- [Architecture Comparison](../architecture/services/architecture_comparison_current_vs_target.md)
- [Workspace Isolation System](./agents/workspace_isolation_system.md)
- [Daytona Spawner Service](../../backend/omoi_os/services/daytona_spawner.py)

## Existing Code References

**Backend WebSocket (ALREADY EXISTS):**
- `backend/omoi_os/api/routes/events.py` - WebSocket endpoint & WebSocketEventManager
- `backend/tests/test_websocket_events.py` - Full test coverage
- `backend/scripts/test_websocket_client.py` - Manual test client

**Frontend WebSocket (ALREADY EXISTS):**
- `frontend/providers/WebSocketProvider.tsx` - Context provider
- `frontend/hooks/useEvents.ts` - useEvents, useEntityEvents, useEventTypes hooks
